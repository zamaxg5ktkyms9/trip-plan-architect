This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.claude/
  settings.json
  settings.local.json
.github/
  workflows/
    ci.yml
    daily-content.yml
    daily-generate.yml
.husky/
  pre-commit
public/
  file.svg
  globe.svg
  logo.svg
  next.svg
  placeholder.svg
  vercel.svg
  window.svg
scripts/
  check-redis-data.ts
  generate-daily.ts
src/
  app/
    api/
      generate/
        __tests__/
          route.test.ts
        route.ts
      og/
        route.tsx
      plans/
        __tests__/
          route.test.ts
        route.ts
      rakuten/
        search/
          route.ts
      unsplash/
        route.ts
    plans/
      [slug]/
        page.tsx
      page.tsx
    privacy/
      page.tsx
    terms/
      page.tsx
    favicon.ico
    globals.css
    layout.tsx
    not-found.tsx
    page.tsx
    robots.ts
    sitemap.ts
  components/
    ui/
      alert.tsx
      badge.tsx
      button.tsx
      card.tsx
      dialog.tsx
      input.tsx
      skeleton.tsx
      sonner.tsx
      textarea.tsx
    footer.tsx
    optimized-plan-view.tsx
    rakuten-hotel-card.tsx
    recent-plans.tsx
    trip-generator.tsx
  lib/
    __tests__/
      rate-limit.test.ts
    constants/
      seeds.ts
    llm/
      providers/
        google.ts
        openai.ts
      client.ts
      types.ts
    repositories/
      __tests__/
        plan-repository.test.ts
      plan-repository.ts
    debug.ts
    rate-limit.ts
    unsplash.ts
    utils.ts
  test/
    setup.ts
  types/
    plan.ts
  env.ts
.env.example
.gitignore
.prettierignore
.prettierrc
components.json
eslint.config.mjs
knip.json
next.config.ts
package.json
playwright.config.ts
postcss.config.mjs
README.md
tsconfig.json
tsconfig.scripts.json
vercel.json
vitest.config.ts
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".claude/settings.local.json">
{
  "permissions": {
    "allow": [
      "Bash(npx create-next-app@latest . --typescript --eslint --tailwind --src-dir --app --import-alias \"@/*\")",
      "Bash(npx create-next-app@latest trip-plan-architect --typescript --eslint --tailwind --src-dir --app --import-alias \"@/*\")",
      "Bash(npx shadcn@latest init -d)",
      "Bash(npx shadcn@latest add:*)",
      "Bash(npm install:*)",
      "Bash(npx playwright install)",
      "Bash(npx husky init)",
      "Bash(npm run lint:*)",
      "Bash(npx knip)",
      "Bash(cat:*)",
      "Bash(npm run dev:*)",
      "Bash(curl:*)",
      "Bash(npm run test:*)",
      "Bash(npm run type-check:*)",
      "Bash(git check-ignore:*)",
      "Bash(git add:*)",
      "Bash(git commit -m \"$\\(cat <<''EOF''\nfeat: Implement Phase 1 & 2 - Project setup and data layer\n\nPhase 1: Initial project setup\n- Setup Next.js 16 with TypeScript, ESLint, Tailwind CSS\n- Initialize shadcn/ui with 10 components \\(button, card, input, etc.\\)\n- Configure testing environment \\(Vitest, Playwright\\)\n- Setup code quality tools \\(Prettier, ESLint, Knip\\)\n- Configure Git hooks \\(Husky, lint-staged\\)\n- Setup CI workflows \\(lint, type-check, test, build\\)\n- Add daily-content workflow with Discord notifications\n\nPhase 2: Data layer and API implementation\n- Add type definitions for travel plans \\(Plan, Day, Event\\)\n- Implement Repository Pattern with file system storage\n- Create API route with AI SDK integration \\(OpenAI GPT-4o-mini\\)\n- Add rate limiting \\(30/hour global, 5/day per IP\\)\n- Create daily plan generation script for SEO\n- Add comprehensive unit tests \\(24 tests passing\\)\n- All tests pass without API keys \\(fully mocked\\)\n\nTech Stack:\n- Next.js 16.1.1, React 19, TypeScript 5\n- Vercel AI SDK, OpenAI, Zod\n- Upstash Redis for rate limiting\n- Vitest, Playwright, Testing Library\n\nğŸ¤– Generated with [Claude Code]\\(https://claude.com/claude-code\\)\n\nCo-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>\nEOF\n\\)\")",
      "Bash(git push:*)",
      "Bash(xargs file:*)",
      "Bash(git commit:*)",
      "Bash(git checkout:*)",
      "Bash(npm view:*)",
      "Bash(npm run build:*)",
      "Bash(git log:*)",
      "Bash(git pull:*)",
      "Bash(test:*)",
      "Bash(npm uninstall:*)",
      "Bash(git stash:*)",
      "Bash(lsof:*)",
      "Bash(xargs kill:*)",
      "Bash(npx tsx:*)",
      "Bash(UPSTASH_REDIS_REST_URL=https://right-bear-18444.upstash.io UPSTASH_REDIS_REST_TOKEN=AUgMAAIncDJkZWNjMGIzYjcwZTU0NTliYjAwZGY5NzM4OTFkOGRlOXAyMTg0NDQ npx tsx:*)",
      "Bash(npm info:*)",
      "Bash(git rm:*)",
      "Bash(cd:*)",
      "Bash(npm test)",
      "Bash(git fetch:*)",
      "Bash(tree:*)",
      "Bash(git reset --hard 4237b14)",
      "Bash(git diff:*)",
      "Bash(git merge-base HEAD origin/main)",
      "Bash(git show origin/main:src/app/plans/[slug]/page.tsx)",
      "Bash(git reset --hard 40f5518)",
      "Bash(git reset --hard 6e1f9df)",
      "Bash(git reset --hard 706442e)",
      "Bash(as the right operand of the 'in' operator.\"\n\nâœ… Build verified locally with npm run build\n\nCo-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>\nEOF\n\\)\")",
      "Bash(repomix)",
      "Bash(cd /Users/tozawanobuharu/Desktop/GoogleDrive/04\\\\ dev/claude/TripPlanArchitect && npx tsc:*)",
      "Bash(cd /Users/tozawanobuharu/Desktop/GoogleDrive/04\\\\ dev/claude/TripPlanArchitect:*)",
      "Bash(npm test -- src/lib/repositories/__tests__/plan-repository.test.ts)",
      "Bash(npm run typecheck:*)",
      "Bash(npm test -- --run)",
      "Bash(npm run knip)",
      "Bash(git restore:*)",
      "Bash(tsc:*)"
    ]
  }
}
</file>

<file path=".github/workflows/ci.yml">
name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  lint-and-typecheck:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Run ESLint
        run: npm run lint
      - name: Run Type Check
        run: npm run type-check

  knip:
    name: Check Unused Code (Knip)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Run Knip
        run: npx knip

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Run tests
        run: npm run test

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Build
        run: npm run build
</file>

<file path=".github/workflows/daily-content.yml">
name: Daily Content Check

on:
  schedule:
    - cron: '0 0 * * *' # Runs at 00:00 UTC (09:00 JST) daily

jobs:
  daily-check:
    name: Daily Content Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Run daily checks
        run: |
          npm run lint
          npm run type-check
          npm run test
          npm run build

      - name: Notify Discord on failure
        if: failure()
        run: |
          curl -H "Content-Type: application/json" \
            -X POST \
            -d "{\"content\": \"âš ï¸ Daily content check failed for ${{ github.repository }}\\nWorkflow: ${{ github.workflow }}\\nRun: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}" \
            ${{ secrets.DISCORD_WEBHOOK_URL }}
</file>

<file path=".github/workflows/daily-generate.yml">
name: Daily Travel Plan Generation

# Automatically generates a new travel plan every day at 9:00 AM JST (00:00 UTC)
# Uses curated seed data to create SEO-optimized content

on:
  # Schedule: Daily at 9:00 AM JST (00:00 UTC)
  schedule:
    - cron: '0 0 * * *'

  # Allow manual triggering from GitHub Actions UI
  workflow_dispatch:

jobs:
  generate-plan:
    name: Generate Daily Travel Plan
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      # Step 1: Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Setup Node.js environment
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # Step 3: Install dependencies
      - name: Install dependencies
        run: npm ci

      # Step 4: Run plan generation script
      - name: Generate travel plan
        run: npx ts-node --project tsconfig.scripts.json scripts/generate-daily.ts
        env:
          # Required environment variables
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          UPSTASH_REDIS_REST_URL: ${{ secrets.UPSTASH_REDIS_REST_URL }}
          UPSTASH_REDIS_REST_TOKEN: ${{ secrets.UPSTASH_REDIS_REST_TOKEN }}
          # Optional environment variables
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}

      # Step 5: Summary
      - name: Workflow summary
        if: success()
        run: |
          echo "âœ… Daily travel plan generated successfully!" >> $GITHUB_STEP_SUMMARY
          echo "Check Discord for details (if webhook is configured)" >> $GITHUB_STEP_SUMMARY
</file>

<file path=".husky/pre-commit">
npx lint-staged
</file>

<file path="public/file.svg">
<svg fill="none" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 13.5V5.41a1 1 0 0 0-.3-.7L9.8.29A1 1 0 0 0 9.08 0H1.5v13.5A2.5 2.5 0 0 0 4 16h8a2.5 2.5 0 0 0 2.5-2.5m-1.5 0v-7H8v-5H3v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1M9.5 5V2.12L12.38 5zM5.13 5h-.62v1.25h2.12V5zm-.62 3h7.12v1.25H4.5zm.62 3h-.62v1.25h7.12V11z" clip-rule="evenodd" fill="#666" fill-rule="evenodd"/></svg>
</file>

<file path="public/globe.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><g clip-path="url(#a)"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.27 14.1a6.5 6.5 0 0 0 3.67-3.45q-1.24.21-2.7.34-.31 1.83-.97 3.1M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.48-1.52a7 7 0 0 1-.96 0H7.5a4 4 0 0 1-.84-1.32q-.38-.89-.63-2.08a40 40 0 0 0 3.92 0q-.25 1.2-.63 2.08a4 4 0 0 1-.84 1.31zm2.94-4.76q1.66-.15 2.95-.43a7 7 0 0 0 0-2.58q-1.3-.27-2.95-.43a18 18 0 0 1 0 3.44m-1.27-3.54a17 17 0 0 1 0 3.64 39 39 0 0 1-4.3 0 17 17 0 0 1 0-3.64 39 39 0 0 1 4.3 0m1.1-1.17q1.45.13 2.69.34a6.5 6.5 0 0 0-3.67-3.44q.65 1.26.98 3.1M8.48 1.5l.01.02q.41.37.84 1.31.38.89.63 2.08a40 40 0 0 0-3.92 0q.25-1.2.63-2.08a4 4 0 0 1 .85-1.32 7 7 0 0 1 .96 0m-2.75.4a6.5 6.5 0 0 0-3.67 3.44 29 29 0 0 1 2.7-.34q.31-1.83.97-3.1M4.58 6.28q-1.66.16-2.95.43a7 7 0 0 0 0 2.58q1.3.27 2.95.43a18 18 0 0 1 0-3.44m.17 4.71q-1.45-.12-2.69-.34a6.5 6.5 0 0 0 3.67 3.44q-.65-1.27-.98-3.1" fill="#666"/></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h16v16H0z"/></clipPath></defs></svg>
</file>

<file path="public/logo.svg">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200" width="200" height="200">
  <!-- Background circle -->
  <circle cx="100" cy="100" r="95" fill="#4A90E2" opacity="0.1"/>
  
  <!-- Compass circle -->
  <circle cx="100" cy="100" r="70" fill="none" stroke="#4A90E2" stroke-width="3"/>
  <circle cx="100" cy="100" r="60" fill="none" stroke="#4A90E2" stroke-width="1.5" opacity="0.3"/>
  
  <!-- Compass directions -->
  <!-- North -->
  <path d="M 100 35 L 105 50 L 100 45 L 95 50 Z" fill="#E74C3C"/>
  <!-- South -->
  <path d="M 100 165 L 105 150 L 100 155 L 95 150 Z" fill="#95A5A6"/>
  <!-- East -->
  <path d="M 165 100 L 150 95 L 155 100 L 150 105 Z" fill="#95A5A6"/>
  <!-- West -->
  <path d="M 35 100 L 50 95 L 45 100 L 50 105 Z" fill="#95A5A6"/>
  
  <!-- Compass needle -->
  <g transform="rotate(-30 100 100)">
    <path d="M 100 50 L 105 100 L 100 95 L 95 100 Z" fill="#E74C3C"/>
    <path d="M 100 150 L 105 100 L 100 105 L 95 100 Z" fill="#34495E"/>
  </g>
  
  <!-- Center pin -->
  <circle cx="100" cy="100" r="5" fill="#34495E"/>
  <circle cx="100" cy="100" r="3" fill="#ECF0F1"/>
  
  <!-- Pen design -->
  <g transform="translate(130, 130)">
    <!-- Pen body -->
    <path d="M 0 0 L 35 35 L 30 40 L -5 5 Z" fill="#F39C12"/>
    <path d="M -5 5 L 30 40 L 25 45 L -10 10 Z" fill="#E67E22"/>
    
    <!-- Pen tip -->
    <path d="M 30 40 L 35 35 L 40 40 L 35 45 Z" fill="#95A5A6"/>
    <path d="M 35 45 L 40 40 L 42 42 L 37 47 Z" fill="#34495E"/>
    
    <!-- Pen clip -->
    <path d="M 5 -5 Q 8 -8 10 -5 L 8 5 Q 6 3 5 5 Z" fill="#BDC3C7"/>
  </g>
  
  <!-- Writing line accent -->
  <path d="M 145 145 Q 155 155 165 160" fill="none" stroke="#3498DB" stroke-width="2" stroke-linecap="round" opacity="0.6"/>
</svg>
</file>

<file path="public/next.svg">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 394 80"><path fill="#000" d="M262 0h68.5v12.7h-27.2v66.6h-13.6V12.7H262V0ZM149 0v12.7H94v20.4h44.3v12.6H94v21h55v12.6H80.5V0h68.7zm34.3 0h-17.8l63.8 79.4h17.9l-32-39.7 32-39.6h-17.9l-23 28.6-23-28.6zm18.3 56.7-9-11-27.1 33.7h17.8l18.3-22.7z"/><path fill="#000" d="M81 79.3 17 0H0v79.3h13.6V17l50.2 62.3H81Zm252.6-.4c-1 0-1.8-.4-2.5-1s-1.1-1.6-1.1-2.6.3-1.8 1-2.5 1.6-1 2.6-1 1.8.3 2.5 1a3.4 3.4 0 0 1 .6 4.3 3.7 3.7 0 0 1-3 1.8zm23.2-33.5h6v23.3c0 2.1-.4 4-1.3 5.5a9.1 9.1 0 0 1-3.8 3.5c-1.6.8-3.5 1.3-5.7 1.3-2 0-3.7-.4-5.3-1s-2.8-1.8-3.7-3.2c-.9-1.3-1.4-3-1.4-5h6c.1.8.3 1.6.7 2.2s1 1.2 1.6 1.5c.7.4 1.5.5 2.4.5 1 0 1.8-.2 2.4-.6a4 4 0 0 0 1.6-1.8c.3-.8.5-1.8.5-3V45.5zm30.9 9.1a4.4 4.4 0 0 0-2-3.3 7.5 7.5 0 0 0-4.3-1.1c-1.3 0-2.4.2-3.3.5-.9.4-1.6 1-2 1.6a3.5 3.5 0 0 0-.3 4c.3.5.7.9 1.3 1.2l1.8 1 2 .5 3.2.8c1.3.3 2.5.7 3.7 1.2a13 13 0 0 1 3.2 1.8 8.1 8.1 0 0 1 3 6.5c0 2-.5 3.7-1.5 5.1a10 10 0 0 1-4.4 3.5c-1.8.8-4.1 1.2-6.8 1.2-2.6 0-4.9-.4-6.8-1.2-2-.8-3.4-2-4.5-3.5a10 10 0 0 1-1.7-5.6h6a5 5 0 0 0 3.5 4.6c1 .4 2.2.6 3.4.6 1.3 0 2.5-.2 3.5-.6 1-.4 1.8-1 2.4-1.7a4 4 0 0 0 .8-2.4c0-.9-.2-1.6-.7-2.2a11 11 0 0 0-2.1-1.4l-3.2-1-3.8-1c-2.8-.7-5-1.7-6.6-3.2a7.2 7.2 0 0 1-2.4-5.7 8 8 0 0 1 1.7-5 10 10 0 0 1 4.3-3.5c2-.8 4-1.2 6.4-1.2 2.3 0 4.4.4 6.2 1.2 1.8.8 3.2 2 4.3 3.4 1 1.4 1.5 3 1.5 5h-5.8z"/></svg>
</file>

<file path="public/placeholder.svg">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1600 900" width="1600" height="900">
  <!-- ã‚°ãƒ¬ãƒ¼èƒŒæ™¯ -->
  <rect width="1600" height="900" fill="#cccccc"/>
  
  <!-- ã‚«ãƒ¡ãƒ©ã‚¢ã‚¤ã‚³ãƒ³ -->
  <g transform="translate(800, 400)">
    <!-- ã‚«ãƒ¡ãƒ©æœ¬ä½“ -->
    <rect x="-80" y="-40" width="160" height="100" rx="8" fill="#666666"/>
    <!-- ãƒ¬ãƒ³ã‚º -->
    <circle cx="0" cy="20" r="35" fill="#888888"/>
    <circle cx="0" cy="20" r="25" fill="#555555"/>
    <!-- ãƒ“ãƒ¥ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ³ãƒ€ãƒ¼ -->
    <rect x="-25" y="-55" width="50" height="15" rx="3" fill="#666666"/>
    <!-- ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ -->
    <circle cx="50" cy="-25" r="8" fill="#888888"/>
  </g>
  
  <!-- "No Image" ãƒ†ã‚­ã‚¹ãƒˆ -->
  <text x="800" y="550" font-family="Arial, sans-serif" font-size="48" fill="#666666" text-anchor="middle" font-weight="bold">
    No Image
  </text>
</svg>
</file>

<file path="public/vercel.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1155 1000"><path d="m577.3 0 577.4 1000H0z" fill="#fff"/></svg>
</file>

<file path="public/window.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.5 2.5h13v10a1 1 0 0 1-1 1h-11a1 1 0 0 1-1-1zM0 1h16v11.5a2.5 2.5 0 0 1-2.5 2.5h-11A2.5 2.5 0 0 1 0 12.5zm3.75 4.5a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5M7 4.75a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0m1.75.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5" fill="#666"/></svg>
</file>

<file path="scripts/check-redis-data.ts">
/**
 * Debug script to check Redis data structure
 * Run with: UPSTASH_REDIS_REST_URL=xxx UPSTASH_REDIS_REST_TOKEN=yyy npx tsx scripts/check-redis-data.ts
 */

import { Redis } from '@upstash/redis'

async function main() {
  const redis = Redis.fromEnv()

  console.log('ğŸ” Checking Redis data...\n')

  // Get all slugs from sorted set
  const slugs = await redis.zrange<string[]>('plan:slugs', 0, -1, {
    rev: true,
    withScores: true,
  })

  console.log(`ğŸ“Š Found ${slugs.length / 2} plans in sorted set\n`)

  // Display first 5 plans with their scores
  for (let i = 0; i < Math.min(10, slugs.length); i += 2) {
    const slug = slugs[i]
    const score = slugs[i + 1]

    console.log(`Slug: ${slug}`)
    console.log(`Score (timestamp): ${score}`)
    console.log(`Date: ${new Date(Number(score)).toLocaleString()}`)

    // Get metadata for this slug
    const meta = await redis.get(`plan:meta:${slug}`)
    console.log(`Metadata:`, meta)
    console.log('---')
  }
}

main().catch(console.error)
</file>

<file path="src/app/api/og/route.tsx">
import { ImageResponse } from 'next/og'
import { NextRequest } from 'next/server'

export const runtime = 'edge'

/**
 * GET /api/og
 * Generates Open Graph images for social media sharing
 *
 * Query parameters:
 * - title: Plan title (e.g., "Tokyo Adventure")
 * - days: Number of days (e.g., "5")
 *
 * Returns a 1200x630 image optimized for Twitter, Facebook, etc.
 *
 * Performance optimizations:
 * - Uses system fonts (no external font fetching)
 * - Aggressive caching headers for Vercel Edge Network
 * - Fallback error handling for reliability
 */
export async function GET(request: NextRequest) {
  try {
    const { searchParams } = request.nextUrl
    const title = searchParams.get('title') || 'Travel Plan'
    const days = searchParams.get('days') || '3'

    const imageResponse = new ImageResponse(
      <div
        style={{
          height: '100%',
          width: '100%',
          display: 'flex',
          flexDirection: 'column',
          alignItems: 'center',
          justifyContent: 'center',
          backgroundColor: '#fff',
          backgroundImage: 'linear-gradient(to bottom, #eff6ff, #ffffff)',
          fontFamily: 'system-ui, -apple-system, sans-serif',
        }}
      >
        <div
          style={{
            display: 'flex',
            flexDirection: 'column',
            alignItems: 'center',
            justifyContent: 'center',
            padding: '60px',
            maxWidth: '1000px',
          }}
        >
          {/* Logo/Icon */}
          <div
            style={{
              fontSize: 100,
              marginBottom: 30,
            }}
          >
            âœˆï¸
          </div>

          {/* Title */}
          <div
            style={{
              fontSize: 64,
              fontWeight: 'bold',
              color: '#1e3a8a',
              textAlign: 'center',
              marginBottom: 24,
              maxWidth: '90%',
              lineHeight: 1.1,
              letterSpacing: '-0.02em',
            }}
          >
            {title}
          </div>

          {/* Days Badge */}
          {days && (
            <div
              style={{
                display: 'flex',
                alignItems: 'center',
                backgroundColor: '#3b82f6',
                color: '#ffffff',
                padding: '12px 28px',
                borderRadius: 8,
                fontSize: 28,
                fontWeight: '600',
                marginBottom: 32,
              }}
            >
              {days} Day{parseInt(days) > 1 ? 's' : ''} Trip
            </div>
          )}

          {/* Subtitle */}
          <div
            style={{
              fontSize: 32,
              color: '#64748b',
              fontWeight: '500',
              marginTop: 16,
            }}
          >
            AI-Powered Trip Plan Architect
          </div>
        </div>
      </div>,
      {
        width: 1200,
        height: 630,
      }
    )

    // Add aggressive caching headers for Vercel Edge Network and Twitter
    // This ensures the image is cached and served instantly on subsequent requests
    return new Response(imageResponse.body, {
      headers: {
        ...Object.fromEntries(imageResponse.headers.entries()),
        'Cache-Control': 'public, max-age=31536000, immutable',
        'CDN-Cache-Control': 'public, max-age=31536000',
        'Vercel-CDN-Cache-Control': 'public, max-age=31536000',
      },
    })
  } catch (error) {
    // Fallback: Return a simple static image on error
    console.error('OG image generation error:', error)

    return new ImageResponse(
      <div
        style={{
          height: '100%',
          width: '100%',
          display: 'flex',
          flexDirection: 'column',
          alignItems: 'center',
          justifyContent: 'center',
          backgroundColor: '#3b82f6',
          fontFamily: 'system-ui, -apple-system, sans-serif',
        }}
      >
        <div
          style={{
            fontSize: 72,
            fontWeight: 'bold',
            color: '#ffffff',
            textAlign: 'center',
          }}
        >
          âœˆï¸ Trip Plan Architect
        </div>
        <div
          style={{
            fontSize: 32,
            color: '#e0e7ff',
            marginTop: 24,
          }}
        >
          AI-Powered Travel Planning
        </div>
      </div>,
      {
        width: 1200,
        height: 630,
        headers: {
          'Cache-Control': 'public, max-age=60, s-maxage=60',
        },
      }
    )
  }
}
</file>

<file path="src/app/api/unsplash/route.ts">
import { NextRequest, NextResponse } from 'next/server'
import { getUnsplashImage } from '@/lib/unsplash'
import { debugLog } from '@/lib/debug'

export const runtime = 'edge'

/**
 * GET /api/unsplash
 * Fetches an image URL from Unsplash API based on search query
 *
 * Query Parameters:
 * - query: Search query for the image
 *
 * @returns JSON with imageUrl or null if not found
 */
export async function GET(request: NextRequest) {
  const { searchParams } = request.nextUrl
  const query = searchParams.get('query')

  try {
    if (!query) {
      return NextResponse.json(
        { error: 'Query parameter is required' },
        { status: 400 }
      )
    }

    const imageUrl = await getUnsplashImage(query)

    if (!imageUrl) {
      debugLog(`[API] No image found for query: "${query}"`)
    }

    return NextResponse.json({ imageUrl })
  } catch (error) {
    console.error('[API] âŒ Error fetching Unsplash image:', error)
    console.error('[API] Query was:', query || 'undefined')
    return NextResponse.json(
      {
        error: 'Failed to fetch image',
        imageUrl: null,
      },
      { status: 500 }
    )
  }
}
</file>

<file path="src/app/privacy/page.tsx">
import type { Metadata } from 'next'
import Link from 'next/link'
import { Button } from '@/components/ui/button'
import { ArrowLeft } from 'lucide-react'

export const metadata: Metadata = {
  title: 'ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ - Trip Plan Architect',
  description:
    'Trip Plan Architectã®ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã€‚å€‹äººæƒ…å ±ã®åé›†ã€åˆ©ç”¨ã€ä¿è­·ã€ãŠã‚ˆã³AIç”Ÿæˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®å…è²¬äº‹é …ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚',
}

export default function PrivacyPage() {
  return (
    <div className="min-h-screen bg-gradient-to-b from-blue-50 to-white">
      <div className="container mx-auto px-4 py-8 max-w-3xl">
        <div className="mb-6">
          <Link href="/">
            <Button variant="ghost" className="gap-2">
              <ArrowLeft className="h-4 w-4" />
              ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹
            </Button>
          </Link>
        </div>

        <article className="prose prose-slate max-w-none">
          <h1 className="text-3xl md:text-4xl font-bold text-gray-900 mb-8">
            ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼
          </h1>

          <p className="text-sm text-gray-500 mb-8">æœ€çµ‚æ›´æ–°æ—¥: 2026å¹´1æœˆ6æ—¥</p>

          {/* 1. ã¯ã˜ã‚ã« */}
          <section className="mb-8">
            <h2 className="text-2xl font-semibold text-gray-900 mb-4">
              1. ã¯ã˜ã‚ã«
            </h2>
            <p className="text-gray-700 leading-relaxed mb-4">
              Trip Plan
              Architectï¼ˆä»¥ä¸‹ã€ã€Œå½“ã‚µãƒ¼ãƒ“ã‚¹ã€ã¨ã„ã„ã¾ã™ï¼‰ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å€‹äººæƒ…å ±ã®å–ã‚Šæ‰±ã„ã«ã¤ã„ã¦ã€ä»¥ä¸‹ã®é€šã‚Šãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ï¼ˆä»¥ä¸‹ã€ã€Œæœ¬ãƒãƒªã‚·ãƒ¼ã€ã¨ã„ã„ã¾ã™ï¼‰ã‚’å®šã‚ã¾ã™ã€‚å½“ã‚µãƒ¼ãƒ“ã‚¹ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã‚’å°Šé‡ã—ã€å€‹äººæƒ…å ±ã®ä¿è­·ã«åŠªã‚ã¾ã™ã€‚
            </p>
          </section>

          {/* 2. åé›†ã™ã‚‹æƒ…å ± */}
          <section className="mb-8">
            <h2 className="text-2xl font-semibold text-gray-900 mb-4">
              2. åé›†ã™ã‚‹æƒ…å ±
            </h2>
            <p className="text-gray-700 leading-relaxed mb-4">
              å½“ã‚µãƒ¼ãƒ“ã‚¹ã§ã¯ã€ä»¥ä¸‹ã®æƒ…å ±ã‚’åé›†ãƒ»åˆ©ç”¨ã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
            </p>

            <h3 className="text-xl font-medium text-gray-800 mb-3">
              2.1 ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæä¾›ã™ã‚‹æƒ…å ±
            </h3>
            <ul className="list-disc pl-6 text-gray-700 mb-4">
              <li>æ—…è¡Œå…ˆã®å¸Œæœ›æ¡ä»¶ï¼ˆã‚¨ãƒªã‚¢ã€æ—¥æ•°ã€äºˆç®—ç­‰ï¼‰</li>
              <li>æ—…è¡Œã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆé–‹ç™ºåˆå®¿ã€æ¸©æ³‰ã€å®¶æ—æ—…è¡Œç­‰ï¼‰</li>
              <li>ãã®ä»–ã€ãƒ—ãƒ©ãƒ³ç”Ÿæˆã®ãŸã‚ã«å…¥åŠ›ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±</li>
            </ul>

            <h3 className="text-xl font-medium text-gray-800 mb-3">
              2.2 è‡ªå‹•çš„ã«åé›†ã•ã‚Œã‚‹æƒ…å ±
            </h3>
            <p className="text-gray-700 leading-relaxed mb-4">
              å½“ã‚µãƒ¼ãƒ“ã‚¹ã¯ã€ã‚µãƒ¼ãƒ“ã‚¹å‘ä¸Šã®ãŸã‚ã«Google
              Analyticsç­‰ã®è§£æãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦ãŠã‚Šã€ä»¥ä¸‹ã®æƒ…å ±ã‚’è‡ªå‹•çš„ã«åé›†ã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
            </p>
            <ul className="list-disc pl-6 text-gray-700 mb-4">
              <li>IPã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆåŒ¿ååŒ–å‡¦ç†æ¸ˆã¿ï¼‰</li>
              <li>ãƒ–ãƒ©ã‚¦ã‚¶ã®ç¨®é¡ãƒ»ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±</li>
              <li>ã‚¢ã‚¯ã‚»ã‚¹æ—¥æ™‚ãƒ»æ»åœ¨æ™‚é–“</li>
              <li>Cookieï¼ˆã‚¯ãƒƒã‚­ãƒ¼ï¼‰ãŠã‚ˆã³é¡ä¼¼æŠ€è¡“ã«ã‚ˆã‚‹è­˜åˆ¥ãƒ‡ãƒ¼ã‚¿</li>
            </ul>
          </section>

          {/* 3. åˆ©ç”¨ç›®çš„ */}
          <section className="mb-8">
            <h2 className="text-2xl font-semibold text-gray-900 mb-4">
              3. åˆ©ç”¨ç›®çš„
            </h2>
            <p className="text-gray-700 leading-relaxed mb-4">
              åé›†ã—ãŸæƒ…å ±ã¯ã€ä»¥ä¸‹ã®ç›®çš„ã§åˆ©ç”¨ã—ã¾ã™ã€‚
            </p>
            <ol className="list-decimal pl-6 text-gray-700 mb-4 space-y-2">
              <li>AIã«ã‚ˆã‚‹æ—…è¡Œãƒ—ãƒ©ãƒ³ã®ç”ŸæˆãŠã‚ˆã³æœ¬ã‚µãƒ¼ãƒ“ã‚¹ã®æä¾›</li>
              <li>åˆ©ç”¨çŠ¶æ³ã®åˆ†æã«ã‚ˆã‚‹ã‚µãƒ¼ãƒ“ã‚¹æ”¹å–„ãƒ»æ–°æ©Ÿèƒ½é–‹ç™º</li>
              <li>ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ãƒ»ã‚¹ãƒ‘ãƒ è¡Œç‚ºã®é˜²æ­¢ï¼ˆRate Limitingç­‰ï¼‰</li>
              <li>ãŠå•ã„åˆã‚ã›ã¸ã®å¯¾å¿œ</li>
            </ol>
          </section>

          {/* 4. ç¬¬ä¸‰è€…ã‚µãƒ¼ãƒ“ã‚¹ã®åˆ©ç”¨ */}
          <section className="mb-8">
            <h2 className="text-2xl font-semibold text-gray-900 mb-4">
              4. ç¬¬ä¸‰è€…ã‚µãƒ¼ãƒ“ã‚¹ã®åˆ©ç”¨
            </h2>
            <p className="text-gray-700 leading-relaxed mb-4">
              å½“ã‚µãƒ¼ãƒ“ã‚¹ã¯ã€ä»¥ä¸‹ã®ç¬¬ä¸‰è€…ã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆ©ç”¨ã—ã¦æ©Ÿèƒ½ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚å„ã‚µãƒ¼ãƒ“ã‚¹ã«ãŠã‘ã‚‹ãƒ‡ãƒ¼ã‚¿å–ã‚Šæ‰±ã„ã«ã¤ã„ã¦ã¯ã€å„ç¤¾ã®ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã‚’ã”å‚ç…§ãã ã•ã„ã€‚
            </p>
            <ul className="list-disc pl-6 text-gray-700 mb-4 space-y-2">
              <li>
                <strong>Google Analytics (GA4):</strong>{' '}
                ã‚¢ã‚¯ã‚»ã‚¹è§£æã®ãŸã‚ã«ä½¿ç”¨ã€‚
              </li>
              <li>
                <strong>OpenAI API:</strong>{' '}
                æ—…è¡Œãƒ—ãƒ©ãƒ³ç”Ÿæˆã®AIã‚¨ãƒ³ã‚¸ãƒ³ã¨ã—ã¦ä½¿ç”¨ã€‚å…¥åŠ›ã•ã‚ŒãŸæ—…è¡Œæ¡ä»¶ã¯OpenAIã«é€ä¿¡ã•ã‚Œã¾ã™ãŒã€å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ã®åˆ©ç”¨ã‚’åˆ¶é™ã™ã‚‹è¨­å®šã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚
              </li>
              <li>
                <strong>Vercel:</strong>{' '}
                ã‚µãƒ¼ãƒãƒ¼ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ãŠã‚ˆã³ãƒ‡ãƒ—ãƒ­ã‚¤ã®ãŸã‚ã«ä½¿ç”¨ã€‚
              </li>
              <li>
                <strong>Unsplash API:</strong> æ—…è¡Œå…ˆã®ç”»åƒè¡¨ç¤ºã®ãŸã‚ã«ä½¿ç”¨ã€‚
              </li>
            </ul>
          </section>

          {/* 5. åºƒå‘Šãƒ»ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆã«ã¤ã„ã¦ */}
          <section className="mb-8">
            <h2 className="text-2xl font-semibold text-gray-900 mb-4">
              5. åºƒå‘Šãƒ»ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆã«ã¤ã„ã¦
            </h2>

            <h3 className="text-xl font-medium text-gray-800 mb-3">
              5.1 Amazonã‚¢ã‚½ã‚·ã‚¨ã‚¤ãƒˆãƒ»ãƒ—ãƒ­ã‚°ãƒ©ãƒ 
            </h3>
            <p className="text-gray-700 leading-relaxed mb-4">
              å½“ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆTrip Plan
              Architectï¼‰ã¯ã€Amazon.co.jpã‚’å®£ä¼ã—ãƒªãƒ³ã‚¯ã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦ã‚µã‚¤ãƒˆãŒç´¹ä»‹æ–™ã‚’ç²å¾—ã§ãã‚‹æ‰‹æ®µã‚’æä¾›ã™ã‚‹ã“ã¨ã‚’ç›®çš„ã«è¨­å®šã•ã‚ŒãŸã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§ã‚ã‚‹ã€Amazonã‚¢ã‚½ã‚·ã‚¨ã‚¤ãƒˆãƒ»ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®å‚åŠ è€…ã§ã™ã€‚
            </p>

            <h3 className="text-xl font-medium text-gray-800 mb-3">
              5.2 Google AdSenseï¼ˆãŠã‚ˆã³ãã®ä»–åºƒå‘Šé…ä¿¡ï¼‰
            </h3>
            <p className="text-gray-700 leading-relaxed mb-4">
              å½“ã‚µãƒ¼ãƒ“ã‚¹ã§ã¯ã€ç¬¬ä¸‰è€…é…ä¿¡ã®åºƒå‘Šã‚µãƒ¼ãƒ“ã‚¹ï¼ˆGoogle
              AdSenseç­‰ï¼‰ã‚’åˆ©ç”¨ã™ã‚‹å ´åˆãŒã‚ã‚Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èˆˆå‘³ã«å¿œã˜ãŸå•†å“ã‚„ã‚µãƒ¼ãƒ“ã‚¹ã®åºƒå‘Šã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã€Cookieï¼ˆã‚¯ãƒƒã‚­ãƒ¼ï¼‰ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
              Cookieã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€å½“ã‚µã‚¤ãƒˆã¯ãŠå®¢æ§˜ã®ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã‚’è­˜åˆ¥ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ãŒã€ãŠå®¢æ§˜å€‹äººã‚’ç‰¹å®šã§ãã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
            </p>
            <p className="text-gray-700 leading-relaxed">
              Cookieã‚’ç„¡åŠ¹ã«ã™ã‚‹æ–¹æ³•ã‚„ã€Googleã‚¢ãƒ‰ã‚»ãƒ³ã‚¹ã«é–¢ã™ã‚‹è©³ç´°ã¯ã€Œ
              <a
                href="https://policies.google.com/technologies/ads?hl=ja"
                target="_blank"
                rel="noopener noreferrer"
                className="text-blue-600 hover:underline"
              >
                Googleãƒãƒªã‚·ãƒ¼ã¨è¦ç´„ â€“ åºƒå‘Š
              </a>
              ã€ã‚’ã”ç¢ºèªãã ã•ã„ã€‚
            </p>
          </section>

          {/* 6. å…è²¬äº‹é … */}
          <section className="mb-8">
            <h2 className="text-2xl font-semibold text-gray-900 mb-4">
              6. å…è²¬äº‹é …ï¼ˆAIç”Ÿæˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«ã¤ã„ã¦ï¼‰
            </h2>
            <p className="text-gray-700 leading-relaxed mb-4">
              å½“ã‚µãƒ¼ãƒ“ã‚¹ã®æ—…è¡Œãƒ—ãƒ©ãƒ³ã¯ã€äººå·¥çŸ¥èƒ½ï¼ˆAIï¼‰ã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸã‚‚ã®ã§ã™ã€‚
            </p>
            <ol className="list-decimal pl-6 text-gray-700 mb-4 space-y-2">
              <li>
                <strong>æƒ…å ±ã®æ­£ç¢ºæ€§:</strong>{' '}
                ç”Ÿæˆã•ã‚ŒãŸãƒ—ãƒ©ãƒ³ã«å«ã¾ã‚Œã‚‹æ–½è¨­æƒ…å ±ï¼ˆå–¶æ¥­æ™‚é–“ã€ä¾¡æ ¼ã€å­˜ç¶šçŠ¶æ³ç­‰ï¼‰ã®æ­£ç¢ºæ€§ãƒ»å®Œå…¨æ€§ã‚’ä¿è¨¼ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
                <span className="font-bold text-red-600">
                  ã”å‡ºç™ºå‰ã«ã€å¿…ãšå…¬å¼ã‚µã‚¤ãƒˆã‚„Googleãƒãƒƒãƒ—ç­‰ã§æœ€æ–°æƒ…å ±ã‚’ã”ç¢ºèªãã ã•ã„ã€‚
                </span>
              </li>
              <li>
                <strong>è²¬ä»»ã®æ‰€åœ¨:</strong>{' '}
                AIãŒç”Ÿæˆã—ãŸãƒ—ãƒ©ãƒ³ã«åŸºã¥ã„ã¦ç”Ÿã˜ãŸæå®³ã€ãƒˆãƒ©ãƒ–ãƒ«ã€ä¸åˆ©ç›Šã«ã¤ã„ã¦ã€å½“ã‚µãƒ¼ãƒ“ã‚¹ãŠã‚ˆã³é‹å–¶è€…ã¯ä¸€åˆ‡ã®è²¬ä»»ã‚’è² ã„ã¾ã›ã‚“ã€‚
              </li>
              <li>
                <strong>å®‰å…¨æ€§:</strong>{' '}
                ææ¡ˆã•ã‚ŒãŸæ—…è¡Œå…ˆã®ç¾åœ¨ã®å®‰å…¨æ€§ã‚„æ°—è±¡çŠ¶æ³ã«ã¤ã„ã¦ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”è‡ªèº«ã§åˆ¤æ–­ã—ã€è‡ªå·±è²¬ä»»ã§è¡Œå‹•ã—ã¦ãã ã•ã„ã€‚
              </li>
            </ol>
          </section>

          {/* 7. å€‹äººæƒ…å ±ã®ç®¡ç†ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ */}
          <section className="mb-8">
            <h2 className="text-2xl font-semibold text-gray-900 mb-4">
              7. å€‹äººæƒ…å ±ã®ç®¡ç†ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
            </h2>
            <p className="text-gray-700 leading-relaxed">
              å½“ã‚µãƒ¼ãƒ“ã‚¹ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å®‰å…¨ç®¡ç†ã®ãŸã‚ã«å¿…è¦ã‹ã¤é©åˆ‡ãªæªç½®ï¼ˆHTTPSæš—å·åŒ–é€šä¿¡ç­‰ï¼‰ã‚’è¬›ã˜ã¾ã™ã€‚ç”Ÿæˆã•ã‚ŒãŸãƒ—ãƒ©ãƒ³ãƒ‡ãƒ¼ã‚¿ã¯ä¸€æ™‚çš„ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆRedisï¼‰ã«ä¿å­˜ã•ã‚Œã¾ã™ãŒã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¦æ±‚ã«å¿œã˜ã¦å‰Šé™¤å¯èƒ½ã§ã™ã€‚
            </p>
          </section>

          {/* 8. ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã®å¤‰æ›´ */}
          <section className="mb-8">
            <h2 className="text-2xl font-semibold text-gray-900 mb-4">
              8. ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã®å¤‰æ›´
            </h2>
            <p className="text-gray-700 leading-relaxed">
              æœ¬ãƒãƒªã‚·ãƒ¼ã®å†…å®¹ã¯ã€æ³•ä»¤æ”¹æ­£ã‚„ã‚µãƒ¼ãƒ“ã‚¹å¤‰æ›´ã«ä¼´ã„ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€šçŸ¥ã™ã‚‹ã“ã¨ãªãå¤‰æ›´ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚‚ã®ã¨ã—ã¾ã™ã€‚å¤‰æ›´å¾Œã®ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã¯ã€æœ¬ãƒšãƒ¼ã‚¸ã«æ²è¼‰ã—ãŸã¨ãã‹ã‚‰åŠ¹åŠ›ã‚’ç”Ÿã˜ã‚‹ã‚‚ã®ã¨ã—ã¾ã™ã€‚
            </p>
          </section>

          {/* 9. ãŠå•ã„åˆã‚ã› */}
          <section className="mb-8">
            <h2 className="text-2xl font-semibold text-gray-900 mb-4">
              9. ãŠå•ã„åˆã‚ã›
            </h2>
            <p className="text-gray-700 leading-relaxed mb-4">
              æœ¬ãƒãƒªã‚·ãƒ¼ã«é–¢ã™ã‚‹ãŠå•ã„åˆã‚ã›ã¯ã€ä»¥ä¸‹ã®çª“å£ã¾ã§ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚
            </p>
            <ul className="list-disc pl-6 text-gray-700 mb-4">
              <li>
                <strong>é‹å–¶è€…:</strong> Trip Plan Architect é‹å–¶äº‹å‹™å±€
              </li>
              <li>
                <strong>ãŠå•ã„åˆã‚ã›:</strong>{' '}
                <a href="#" className="text-blue-600 hover:underline">
                  ãŠå•ã„åˆã‚ã›ãƒ•ã‚©ãƒ¼ãƒ  ã¾ãŸã¯ å…¬å¼X(Twitter)
                </a>
              </li>
            </ul>
          </section>
        </article>
      </div>
    </div>
  )
}
</file>

<file path="src/app/terms/page.tsx">
import type { Metadata } from 'next'
import Link from 'next/link'
import { Button } from '@/components/ui/button'
import { ArrowLeft } from 'lucide-react'

export const metadata: Metadata = {
  title: 'åˆ©ç”¨è¦ç´„ - Trip Plan Architect',
  description:
    'Trip Plan Architectã®åˆ©ç”¨è¦ç´„ã€‚ã‚µãƒ¼ãƒ“ã‚¹ã®åˆ©ç”¨æ¡ä»¶ã€å…è²¬äº‹é …ã€ç¦æ­¢äº‹é …ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚',
}

export default function TermsPage() {
  return (
    <div className="min-h-screen bg-gradient-to-b from-blue-50 to-white">
      <div className="container mx-auto px-4 py-8 max-w-3xl">
        <div className="mb-6">
          <Link href="/">
            <Button variant="ghost" className="gap-2">
              <ArrowLeft className="h-4 w-4" />
              ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹
            </Button>
          </Link>
        </div>

        <article className="prose prose-slate max-w-none">
          <h1 className="text-3xl md:text-4xl font-bold text-gray-900 mb-8">
            åˆ©ç”¨è¦ç´„
          </h1>

          <p className="text-sm text-gray-500 mb-8">æœ€çµ‚æ›´æ–°æ—¥: 2026å¹´1æœˆ6æ—¥</p>

          {/* å‰æ–‡ */}
          <div className="mb-8">
            <p className="text-gray-700 leading-relaxed">
              ã“ã®åˆ©ç”¨è¦ç´„ï¼ˆä»¥ä¸‹ã€Œæœ¬è¦ç´„ã€ï¼‰ã¯ã€Trip Plan
              Architectï¼ˆä»¥ä¸‹ã€Œå½“ã‚µãƒ¼ãƒ“ã‚¹ã€ï¼‰ã®åˆ©ç”¨æ¡ä»¶ã‚’å®šã‚ã‚‹ã‚‚ã®ã§ã™ã€‚å½“ã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆ©ç”¨ã•ã‚Œã‚‹æ–¹ï¼ˆä»¥ä¸‹ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ï¼‰ã¯ã€æœ¬è¦ç´„ã«åŒæ„ã—ãŸã‚‚ã®ã¨ã¿ãªã•ã‚Œã¾ã™ã€‚
            </p>
          </div>

          {/* 1. ã‚µãƒ¼ãƒ“ã‚¹ã®æ¦‚è¦ã¨ãƒ™ãƒ¼ã‚¿ç‰ˆã®å…è²¬ */}
          <section className="mb-8">
            <h2 className="text-2xl font-semibold text-gray-900 mb-4">
              1. ã‚µãƒ¼ãƒ“ã‚¹ã®æ¦‚è¦ã¨ãƒ™ãƒ¼ã‚¿ç‰ˆã®å…è²¬
            </h2>
            <p className="text-gray-700 leading-relaxed">
              å½“ã‚µãƒ¼ãƒ“ã‚¹ã¯ã€AIï¼ˆäººå·¥çŸ¥èƒ½ï¼‰ã‚’æ´»ç”¨ã—ã¦æ—…è¡Œãƒ—ãƒ©ãƒ³ã‚’è‡ªå‹•ç”Ÿæˆã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚ç¾åœ¨ã¯
              <strong className="font-semibold">ãƒ™ãƒ¼ã‚¿ç‰ˆ</strong>
              ã¨ã—ã¦æä¾›ã•ã‚Œã¦ãŠã‚Šã€æ©Ÿèƒ½ã®å¤‰æ›´ã€ä¸­æ–­ã€çµ‚äº†ãŒäºˆå‘Šãªãè¡Œã‚ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
            </p>
          </section>

          {/* 2. AIç”Ÿæˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«é–¢ã™ã‚‹é‡è¦äº‹é … */}
          <section className="mb-8">
            <h2 className="text-2xl font-semibold text-gray-900 mb-4">
              2. AIç”Ÿæˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«é–¢ã™ã‚‹é‡è¦äº‹é …
            </h2>
            <p className="text-gray-700 leading-relaxed mb-4">
              å½“ã‚µãƒ¼ãƒ“ã‚¹ã®å‡ºåŠ›çµæœã¯ã€AIï¼ˆLLMï¼‰ã«ã‚ˆã£ã¦ç”Ÿæˆã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ä»¥ä¸‹ã®ç‰¹æ€§ã‚’ç†è§£ã—ã€è‡ªå·±è²¬ä»»ã§åˆ©ç”¨ã™ã‚‹ã“ã¨ã«åŒæ„ã™ã‚‹ã‚‚ã®ã¨ã—ã¾ã™ã€‚
            </p>
            <ol className="list-decimal pl-6 text-gray-700 mb-4 space-y-2">
              <li>
                <strong>æƒ…å ±ã®ä¸æ­£ç¢ºæ€§:</strong>{' '}
                ç”Ÿæˆã•ã‚ŒãŸãƒ—ãƒ©ãƒ³ï¼ˆæ–½è¨­åã€å–¶æ¥­æ™‚é–“ã€ä¾¡æ ¼ã€äº¤é€šæ‰‹æ®µãªã©ï¼‰ã¯ã€æ­£ç¢ºæ€§ã‚’ä¿è¨¼ã—ã¾ã›ã‚“ã€‚ã€Œãƒãƒ«ã‚·ãƒãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆã‚‚ã£ã¨ã‚‚ã‚‰ã—ã„å˜˜ï¼‰ã€ãŒå«ã¾ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
              </li>
              <li>
                <strong>è¦ç¢ºèª:</strong> æ—…è¡Œã®äºˆç´„ã‚„å®Ÿéš›ã®ç§»å‹•ã‚’è¡Œã†å‰ã«ã€
                <strong className="text-red-600">
                  å¿…ãšGoogleãƒãƒƒãƒ—ã‚„å…¬å¼ã‚µã‚¤ãƒˆç­‰ã®ä¸€æ¬¡æƒ…å ±ã§æœ€æ–°ã®çŠ¶æ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
                </strong>
              </li>
              <li>
                <strong>å…è²¬:</strong>{' '}
                AIãŒææ¡ˆã—ãŸãƒ—ãƒ©ãƒ³ã«èµ·å› ã™ã‚‹ãƒˆãƒ©ãƒ–ãƒ«ï¼ˆè‡¨æ™‚ä¼‘æ¥­ã€æº€å¸­ã€ç§»å‹•ä¸å¯ãªã©ï¼‰ã«ã¤ã„ã¦ã€é‹å–¶è€…ã¯ä¸€åˆ‡ã®è²¬ä»»ã‚’è² ã„ã¾ã›ã‚“ã€‚
              </li>
            </ol>
          </section>

          {/* 3. ç¦æ­¢äº‹é … */}
          <section className="mb-8">
            <h2 className="text-2xl font-semibold text-gray-900 mb-4">
              3. ç¦æ­¢äº‹é …
            </h2>
            <p className="text-gray-700 leading-relaxed mb-4">
              ä»¥ä¸‹ã®è¡Œç‚ºã‚’ç¦æ­¢ã—ã¾ã™ã€‚
            </p>
            <ul className="list-disc pl-6 text-gray-700 mb-4 space-y-1">
              <li>
                ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã€ã‚¯ãƒ­ãƒ¼ãƒªãƒ³ã‚°ç­‰ã«ã‚ˆã‚‹éåº¦ãªè² è·ã‚’ã‹ã‘ã‚‹è¡Œç‚º
              </li>
              <li>ãƒªãƒãƒ¼ã‚¹ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°</li>
              <li>æ³•ä»¤ã¾ãŸã¯å…¬åºè‰¯ä¿—ã«é•åã™ã‚‹ç›®çš„ã§ã®åˆ©ç”¨</li>
              <li>é€šå¸¸ã®åˆ©ç”¨ç¯„å›²ã‚’è¶…ãˆãŸé€£ç¶šçš„ãªã‚¢ã‚¯ã‚»ã‚¹ï¼ˆDoSæ”»æ’ƒç­‰ï¼‰</li>
            </ul>
          </section>

          {/* 4. åˆ©ç”¨åˆ¶é™ï¼ˆRate Limitsï¼‰ */}
          <section className="mb-8">
            <h2 className="text-2xl font-semibold text-gray-900 mb-4">
              4. åˆ©ç”¨åˆ¶é™ï¼ˆRate Limitsï¼‰
            </h2>
            <p className="text-gray-700 leading-relaxed mb-4">
              å®‰å®šé‹ç”¨ã®ãŸã‚ã«ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™ã‚’è¨­ã‘ã¦ã„ã¾ã™ã€‚
            </p>
            <ul className="list-disc pl-6 text-gray-700 mb-4 space-y-1">
              <li>
                ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®è² è·çŠ¶æ³ã«ã‚ˆã‚Šã€ä¸€æ™‚çš„ã«åˆ©ç”¨ã‚’åˆ¶é™ã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
              </li>
              <li>æŠ€è¡“çš„ãªæ‰‹æ®µã‚’ç”¨ã„ã¦åˆ¶é™ã‚’å›é¿ã™ã‚‹è¡Œç‚ºã¯ç¦æ­¢ã—ã¾ã™ã€‚</li>
            </ul>
          </section>

          {/* 5. çŸ¥çš„è²¡ç”£æ¨© */}
          <section className="mb-8">
            <h2 className="text-2xl font-semibold text-gray-900 mb-4">
              5. çŸ¥çš„è²¡ç”£æ¨©
            </h2>
            <ul className="list-disc pl-6 text-gray-700 mb-4 space-y-2">
              <li>
                å½“ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ‡ã‚¶ã‚¤ãƒ³ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚³ãƒ¼ãƒ‰ã«é–¢ã™ã‚‹æ¨©åˆ©ã¯é‹å–¶è€…ã«å¸°å±ã—ã¾ã™ã€‚
              </li>
              <li>
                ç”Ÿæˆã•ã‚ŒãŸæ—…è¡Œãƒ—ãƒ©ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆç­‰ã®åˆ©ç”¨æ¨©ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¸°å±ã—ã¾ã™ãŒã€å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦åŒæ§˜ã®ãƒ—ãƒ©ãƒ³ãŒä»–è€…ã«ç”Ÿæˆã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã“ã¨ã‚’äº†æ‰¿ã™ã‚‹ã‚‚ã®ã¨ã—ã¾ã™ã€‚
              </li>
              <li>
                è¡¨ç¤ºã•ã‚Œã‚‹ç”»åƒã¯Unsplashç­‰ã®å¤–éƒ¨APIã‚’åˆ©ç”¨ã—ã¦ãŠã‚Šã€å„æä¾›å…ƒã®ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã«å¾“ã„ã¾ã™ã€‚
              </li>
            </ul>
          </section>

          {/* 6. å…è²¬äº‹é … */}
          <section className="mb-8">
            <h2 className="text-2xl font-semibold text-gray-900 mb-4">
              6. å…è²¬äº‹é …
            </h2>
            <p className="text-gray-700 leading-relaxed mb-4">
              é‹å–¶è€…ã¯ã€å½“ã‚µãƒ¼ãƒ“ã‚¹ã«äº‹å®Ÿä¸Šã¾ãŸã¯æ³•å¾‹ä¸Šã®ç‘•ç–µï¼ˆå®‰å…¨æ€§ã€ä¿¡é ¼æ€§ã€æ­£ç¢ºæ€§ã€å®Œå…¨æ€§ã€æœ‰åŠ¹æ€§ã€ç‰¹å®šã®ç›®çš„ã¸ã®é©åˆæ€§ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãªã©ã«é–¢ã™ã‚‹æ¬ é™¥ã€ã‚¨ãƒ©ãƒ¼ã‚„ãƒã‚°ã€æ¨©åˆ©ä¾µå®³ãªã©ã‚’å«ã¿ã¾ã™ï¼‰ãŒãªã„ã“ã¨ã‚’æ˜ç¤ºçš„ã«ã‚‚é»™ç¤ºçš„ã«ã‚‚ä¿è¨¼ã—ã¦ãŠã‚Šã¾ã›ã‚“ã€‚
            </p>
            <p className="text-gray-700 leading-relaxed">
              å½“ã‚µãƒ¼ãƒ“ã‚¹ã«èµ·å› ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç”Ÿã˜ãŸã‚ã‚‰ã‚†ã‚‹æå®³ã«ã¤ã„ã¦ã€é‹å–¶è€…ã®æ•…æ„ã¾ãŸã¯é‡éå¤±ã«ã‚ˆã‚‹å ´åˆã‚’é™¤ãã€ä¸€åˆ‡ã®è²¬ä»»ã‚’è² ã„ã¾ã›ã‚“ã€‚
            </p>
          </section>

          {/* 7. æº–æ‹ æ³•ãƒ»è£åˆ¤ç®¡è½„ */}
          <section className="mb-8">
            <h2 className="text-2xl font-semibold text-gray-900 mb-4">
              7. æº–æ‹ æ³•ãƒ»è£åˆ¤ç®¡è½„
            </h2>
            <p className="text-gray-700 leading-relaxed">
              æœ¬è¦ç´„ã®è§£é‡ˆã«ã‚ãŸã£ã¦ã¯ã€æ—¥æœ¬æ³•ã‚’æº–æ‹ æ³•ã¨ã—ã¾ã™ã€‚å½“ã‚µãƒ¼ãƒ“ã‚¹ã«é–¢ã—ã¦ç´›äº‰ãŒç”Ÿã˜ãŸå ´åˆã«ã¯ã€æ±äº¬åœ°æ–¹è£åˆ¤æ‰€ã‚’å°‚å±çš„åˆæ„ç®¡è½„è£åˆ¤æ‰€ã¨ã—ã¾ã™ã€‚
            </p>
          </section>

          <hr className="my-8 border-gray-200" />

          {/* ãŠå•ã„åˆã‚ã› */}
          <section className="mb-8">
            <h2 className="text-2xl font-semibold text-gray-900 mb-4">
              ãŠå•ã„åˆã‚ã›
            </h2>
            <p className="text-gray-700 leading-relaxed">
              ä¸å…·åˆå ±å‘Šã‚„ãŠå•ã„åˆã‚ã›ã¯ã€
              <a href="#" className="text-blue-600 hover:underline">
                Xï¼ˆæ—§Twitterï¼‰
              </a>
              ã¾ãŸã¯Webã‚µã‚¤ãƒˆã®ãƒ•ã‚©ãƒ¼ãƒ ã‚ˆã‚Šã”é€£çµ¡ãã ã•ã„ã€‚
            </p>
          </section>
        </article>
      </div>
    </div>
  )
}
</file>

<file path="src/app/not-found.tsx">
import Link from 'next/link'
import { Button } from '@/components/ui/button'
import { SearchX, Home } from 'lucide-react'

export default function NotFound() {
  return (
    <div className="min-h-screen bg-gradient-to-b from-blue-50 to-white flex items-center justify-center">
      <div className="container mx-auto px-4 py-16 max-w-2xl text-center">
        <div className="mb-8">
          <SearchX className="h-24 w-24 mx-auto text-blue-600 mb-6" />
          <h1 className="text-6xl font-bold text-gray-900 mb-4">404</h1>
          <h2 className="text-3xl font-semibold text-gray-800 mb-4">
            Page Not Found
          </h2>
          <p className="text-xl text-gray-600 mb-2">ãƒšãƒ¼ã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>
          <p className="text-gray-600 mb-8">
            The page you&apos;re looking for doesn&apos;t exist or has been
            moved.
          </p>
        </div>

        <Link href="/">
          <Button size="lg" className="gap-2">
            <Home className="h-5 w-5" />
            Return Home
          </Button>
        </Link>
      </div>
    </div>
  )
}
</file>

<file path="src/app/robots.ts">
import { MetadataRoute } from 'next'

/**
 * Generates robots.txt file for search engine crawlers
 * Allows all crawlers to access all pages
 * References the sitemap for complete site structure
 */
export default function robots(): MetadataRoute.Robots {
  return {
    rules: {
      userAgent: '*',
      allow: '/',
    },
    sitemap: 'https://www.trip-plan-architect.com/sitemap.xml',
  }
}
</file>

<file path="src/components/ui/alert.tsx">
import * as React from 'react'
import { cva, type VariantProps } from 'class-variance-authority'

import { cn } from '@/lib/utils'

const alertVariants = cva(
  'relative w-full rounded-lg border px-4 py-3 text-sm grid has-[>svg]:grid-cols-[calc(var(--spacing)*4)_1fr] grid-cols-[0_1fr] has-[>svg]:gap-x-3 gap-y-0.5 items-start [&>svg]:size-4 [&>svg]:translate-y-0.5 [&>svg]:text-current',
  {
    variants: {
      variant: {
        default: 'bg-card text-card-foreground',
        destructive:
          'text-destructive bg-card [&>svg]:text-current *:data-[slot=alert-description]:text-destructive/90',
      },
    },
    defaultVariants: {
      variant: 'default',
    },
  }
)

function Alert({
  className,
  variant,
  ...props
}: React.ComponentProps<'div'> & VariantProps<typeof alertVariants>) {
  return (
    <div
      data-slot="alert"
      role="alert"
      className={cn(alertVariants({ variant }), className)}
      {...props}
    />
  )
}

function AlertTitle({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="alert-title"
      className={cn(
        'col-start-2 line-clamp-1 min-h-4 font-medium tracking-tight',
        className
      )}
      {...props}
    />
  )
}

function AlertDescription({
  className,
  ...props
}: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="alert-description"
      className={cn(
        'text-muted-foreground col-start-2 grid justify-items-start gap-1 text-sm [&_p]:leading-relaxed',
        className
      )}
      {...props}
    />
  )
}

export { Alert, AlertTitle, AlertDescription }
</file>

<file path="src/components/ui/badge.tsx">
import * as React from 'react'
import { Slot } from '@radix-ui/react-slot'
import { cva, type VariantProps } from 'class-variance-authority'

import { cn } from '@/lib/utils'

const badgeVariants = cva(
  'inline-flex items-center justify-center rounded-full border px-2 py-0.5 text-xs font-medium w-fit whitespace-nowrap shrink-0 [&>svg]:size-3 gap-1 [&>svg]:pointer-events-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive transition-[color,box-shadow] overflow-hidden',
  {
    variants: {
      variant: {
        default:
          'border-transparent bg-primary text-primary-foreground [a&]:hover:bg-primary/90',
        secondary:
          'border-transparent bg-secondary text-secondary-foreground [a&]:hover:bg-secondary/90',
        destructive:
          'border-transparent bg-destructive text-white [a&]:hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60',
        outline:
          'text-foreground [a&]:hover:bg-accent [a&]:hover:text-accent-foreground',
      },
    },
    defaultVariants: {
      variant: 'default',
    },
  }
)

function Badge({
  className,
  variant,
  asChild = false,
  ...props
}: React.ComponentProps<'span'> &
  VariantProps<typeof badgeVariants> & { asChild?: boolean }) {
  const Comp = asChild ? Slot : 'span'

  return (
    <Comp
      data-slot="badge"
      className={cn(badgeVariants({ variant }), className)}
      {...props}
    />
  )
}

export { Badge, badgeVariants }
</file>

<file path="src/components/ui/button.tsx">
import * as React from 'react'
import { Slot } from '@radix-ui/react-slot'
import { cva, type VariantProps } from 'class-variance-authority'

import { cn } from '@/lib/utils'

const buttonVariants = cva(
  "inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",
  {
    variants: {
      variant: {
        default: 'bg-primary text-primary-foreground hover:bg-primary/90',
        destructive:
          'bg-destructive text-white hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60',
        outline:
          'border bg-background shadow-xs hover:bg-accent hover:text-accent-foreground dark:bg-input/30 dark:border-input dark:hover:bg-input/50',
        secondary:
          'bg-secondary text-secondary-foreground hover:bg-secondary/80',
        ghost:
          'hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50',
        link: 'text-primary underline-offset-4 hover:underline',
      },
      size: {
        default: 'h-9 px-4 py-2 has-[>svg]:px-3',
        sm: 'h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5',
        lg: 'h-10 rounded-md px-6 has-[>svg]:px-4',
        icon: 'size-9',
        'icon-sm': 'size-8',
        'icon-lg': 'size-10',
      },
    },
    defaultVariants: {
      variant: 'default',
      size: 'default',
    },
  }
)

function Button({
  className,
  variant = 'default',
  size = 'default',
  asChild = false,
  ...props
}: React.ComponentProps<'button'> &
  VariantProps<typeof buttonVariants> & {
    asChild?: boolean
  }) {
  const Comp = asChild ? Slot : 'button'

  return (
    <Comp
      data-slot="button"
      data-variant={variant}
      data-size={size}
      className={cn(buttonVariants({ variant, size, className }))}
      {...props}
    />
  )
}

export { Button, buttonVariants }
</file>

<file path="src/components/ui/card.tsx">
import * as React from 'react'

import { cn } from '@/lib/utils'

function Card({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="card"
      className={cn(
        'bg-card text-card-foreground flex flex-col gap-6 rounded-xl border py-6 shadow-sm',
        className
      )}
      {...props}
    />
  )
}

function CardHeader({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="card-header"
      className={cn(
        '@container/card-header grid auto-rows-min grid-rows-[auto_auto] items-start gap-2 px-6 has-data-[slot=card-action]:grid-cols-[1fr_auto] [.border-b]:pb-6',
        className
      )}
      {...props}
    />
  )
}

function CardTitle({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="card-title"
      className={cn('leading-none font-semibold', className)}
      {...props}
    />
  )
}

function CardDescription({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="card-description"
      className={cn('text-muted-foreground text-sm', className)}
      {...props}
    />
  )
}

function CardAction({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="card-action"
      className={cn(
        'col-start-2 row-span-2 row-start-1 self-start justify-self-end',
        className
      )}
      {...props}
    />
  )
}

function CardContent({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="card-content"
      className={cn('px-6', className)}
      {...props}
    />
  )
}

function CardFooter({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="card-footer"
      className={cn('flex items-center px-6 [.border-t]:pt-6', className)}
      {...props}
    />
  )
}

export {
  Card,
  CardHeader,
  CardFooter,
  CardTitle,
  CardAction,
  CardDescription,
  CardContent,
}
</file>

<file path="src/components/ui/dialog.tsx">
'use client'

import * as React from 'react'
import * as DialogPrimitive from '@radix-ui/react-dialog'
import { XIcon } from 'lucide-react'

import { cn } from '@/lib/utils'

function Dialog({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Root>) {
  return <DialogPrimitive.Root data-slot="dialog" {...props} />
}

function DialogTrigger({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Trigger>) {
  return <DialogPrimitive.Trigger data-slot="dialog-trigger" {...props} />
}

function DialogPortal({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Portal>) {
  return <DialogPrimitive.Portal data-slot="dialog-portal" {...props} />
}

function DialogClose({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Close>) {
  return <DialogPrimitive.Close data-slot="dialog-close" {...props} />
}

function DialogOverlay({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Overlay>) {
  return (
    <DialogPrimitive.Overlay
      data-slot="dialog-overlay"
      className={cn(
        'data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/50',
        className
      )}
      {...props}
    />
  )
}

function DialogContent({
  className,
  children,
  showCloseButton = true,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Content> & {
  showCloseButton?: boolean
}) {
  return (
    <DialogPortal data-slot="dialog-portal">
      <DialogOverlay />
      <DialogPrimitive.Content
        data-slot="dialog-content"
        className={cn(
          'bg-background data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 fixed top-[50%] left-[50%] z-50 grid w-full max-w-[calc(100%-2rem)] translate-x-[-50%] translate-y-[-50%] gap-4 rounded-lg border p-6 shadow-lg duration-200 outline-none sm:max-w-lg',
          className
        )}
        {...props}
      >
        {children}
        {showCloseButton && (
          <DialogPrimitive.Close
            data-slot="dialog-close"
            className="ring-offset-background focus:ring-ring data-[state=open]:bg-accent data-[state=open]:text-muted-foreground absolute top-4 right-4 rounded-xs opacity-70 transition-opacity hover:opacity-100 focus:ring-2 focus:ring-offset-2 focus:outline-hidden disabled:pointer-events-none [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4"
          >
            <XIcon />
            <span className="sr-only">Close</span>
          </DialogPrimitive.Close>
        )}
      </DialogPrimitive.Content>
    </DialogPortal>
  )
}

function DialogHeader({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="dialog-header"
      className={cn('flex flex-col gap-2 text-center sm:text-left', className)}
      {...props}
    />
  )
}

function DialogFooter({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="dialog-footer"
      className={cn(
        'flex flex-col-reverse gap-2 sm:flex-row sm:justify-end',
        className
      )}
      {...props}
    />
  )
}

function DialogTitle({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Title>) {
  return (
    <DialogPrimitive.Title
      data-slot="dialog-title"
      className={cn('text-lg leading-none font-semibold', className)}
      {...props}
    />
  )
}

function DialogDescription({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Description>) {
  return (
    <DialogPrimitive.Description
      data-slot="dialog-description"
      className={cn('text-muted-foreground text-sm', className)}
      {...props}
    />
  )
}

export {
  Dialog,
  DialogClose,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogOverlay,
  DialogPortal,
  DialogTitle,
  DialogTrigger,
}
</file>

<file path="src/components/ui/input.tsx">
import * as React from 'react'

import { cn } from '@/lib/utils'

function Input({ className, type, ...props }: React.ComponentProps<'input'>) {
  return (
    <input
      type={type}
      data-slot="input"
      className={cn(
        'file:text-foreground placeholder:text-muted-foreground selection:bg-primary selection:text-primary-foreground dark:bg-input/30 border-input h-9 w-full min-w-0 rounded-md border bg-transparent px-3 py-1 text-base shadow-xs transition-[color,box-shadow] outline-none file:inline-flex file:h-7 file:border-0 file:bg-transparent file:text-sm file:font-medium disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50 md:text-sm',
        'focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px]',
        'aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive',
        className
      )}
      {...props}
    />
  )
}

export { Input }
</file>

<file path="src/components/ui/skeleton.tsx">
import { cn } from '@/lib/utils'

function Skeleton({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="skeleton"
      className={cn('bg-accent animate-pulse rounded-md', className)}
      {...props}
    />
  )
}

export { Skeleton }
</file>

<file path="src/components/ui/sonner.tsx">
'use client'

import {
  CircleCheckIcon,
  InfoIcon,
  Loader2Icon,
  OctagonXIcon,
  TriangleAlertIcon,
} from 'lucide-react'
import { useTheme } from 'next-themes'
import { Toaster as Sonner, type ToasterProps } from 'sonner'

const Toaster = ({ ...props }: ToasterProps) => {
  const { theme = 'system' } = useTheme()

  return (
    <Sonner
      theme={theme as ToasterProps['theme']}
      className="toaster group"
      icons={{
        success: <CircleCheckIcon className="size-4" />,
        info: <InfoIcon className="size-4" />,
        warning: <TriangleAlertIcon className="size-4" />,
        error: <OctagonXIcon className="size-4" />,
        loading: <Loader2Icon className="size-4 animate-spin" />,
      }}
      style={
        {
          '--normal-bg': 'var(--popover)',
          '--normal-text': 'var(--popover-foreground)',
          '--normal-border': 'var(--border)',
          '--border-radius': 'var(--radius)',
        } as React.CSSProperties
      }
      {...props}
    />
  )
}

export { Toaster }
</file>

<file path="src/components/ui/textarea.tsx">
import * as React from 'react'

import { cn } from '@/lib/utils'

function Textarea({ className, ...props }: React.ComponentProps<'textarea'>) {
  return (
    <textarea
      data-slot="textarea"
      className={cn(
        'border-input placeholder:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 flex field-sizing-content min-h-16 w-full rounded-md border bg-transparent px-3 py-2 text-base shadow-xs transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50 md:text-sm',
        className
      )}
      {...props}
    />
  )
}

export { Textarea }
</file>

<file path="src/lib/__tests__/rate-limit.test.ts">
import { describe, it, expect, vi } from 'vitest'
import { checkRateLimit, getClientIP } from '../rate-limit'

vi.mock('@upstash/ratelimit', () => ({
  Ratelimit: vi.fn(),
}))

vi.mock('@upstash/redis', () => ({
  Redis: {
    fromEnv: vi.fn(() => ({})),
  },
}))

describe('rate-limit', () => {
  describe('checkRateLimit', () => {
    it('should return success when no limiter is provided', async () => {
      const result = await checkRateLimit('test-id', null)

      expect(result.success).toBe(true)
      expect(result.limit).toBe(0)
      expect(result.remaining).toBe(0)
      expect(result.reset).toBe(0)
    })

    it('should return success when limit is not exceeded', async () => {
      const mockLimiter = {
        limit: vi.fn(async () => ({
          success: true,
          limit: 30,
          remaining: 29,
          reset: Date.now() + 3600000,
        })),
      }

      const result = await checkRateLimit('test-id', mockLimiter as never)

      expect(result.success).toBe(true)
      expect(result.limit).toBe(30)
      expect(result.remaining).toBe(29)
      expect(mockLimiter.limit).toHaveBeenCalledWith('test-id')
    })

    it('should throw error when rate limit is exceeded', async () => {
      const resetTime = Date.now() + 3600000
      const mockLimiter = {
        limit: vi.fn(async () => ({
          success: false,
          limit: 30,
          remaining: 0,
          reset: resetTime,
        })),
      }

      await expect(
        checkRateLimit('test-id', mockLimiter as never)
      ).rejects.toThrow(/Rate limit exceeded/)
    })
  })

  describe('getClientIP', () => {
    it('should extract IP from x-forwarded-for header', () => {
      const headers = new Headers({
        'x-forwarded-for': '192.168.1.1, 10.0.0.1',
      })

      const ip = getClientIP(headers)

      expect(ip).toBe('192.168.1.1')
    })

    it('should extract IP from x-real-ip header when x-forwarded-for is not present', () => {
      const headers = new Headers({
        'x-real-ip': '192.168.1.2',
      })

      const ip = getClientIP(headers)

      expect(ip).toBe('192.168.1.2')
    })

    it('should return "unknown" when no IP headers are present', () => {
      const headers = new Headers()

      const ip = getClientIP(headers)

      expect(ip).toBe('unknown')
    })

    it('should prefer x-forwarded-for over x-real-ip', () => {
      const headers = new Headers({
        'x-forwarded-for': '192.168.1.1',
        'x-real-ip': '192.168.1.2',
      })

      const ip = getClientIP(headers)

      expect(ip).toBe('192.168.1.1')
    })
  })
})
</file>

<file path="src/lib/constants/seeds.ts">
export interface SeedPlan {
  region: string // Unsplashã§æ¤œç´¢ã—ã‚„ã™ã„ä¸»è¦éƒ½å¸‚å (ä¾‹: "Tokyo", "Hakone")
  title: string // SEOã‚’æ„è­˜ã—ãŸè‹±èªã‚¿ã‚¤ãƒˆãƒ«
  theme: string // æ—…è¡Œã®ãƒ†ãƒ¼ãƒ (Workation, Tech, Nature, etc.)
  keywords: string[] // ç”»åƒæ¤œç´¢ç”¨ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ (è‹±èª)
}

export const SEED_PLANS: SeedPlan[] = [
  // A. é–‹ç™ºåˆå®¿ãƒ»é›†ä¸­ (Deep Work)
  {
    region: 'Hakone',
    title: 'Hakone Onsen Development Camp',
    theme: 'Deep Work',
    keywords: ['hot spring', 'ryokan', 'laptop', 'japanese room'],
  },
  {
    region: 'Nagano',
    title: 'Lakeside Coworking Retreat',
    theme: 'Deep Work',
    keywords: ['lake', 'forest', 'laptop', 'nature'],
  },
  {
    region: 'Chiba',
    title: 'Ocean View Coding Camp',
    theme: 'Deep Work',
    keywords: ['ocean view', 'beach', 'desk', 'coffee'],
  },
  {
    region: 'Shirahama',
    title: 'Resort Workation in Shirahama',
    theme: 'Workation',
    keywords: ['white beach', 'resort', 'tropical', 'laptop'],
  },
  {
    region: 'Izu',
    title: 'Relaxing Izu Onsen & Coding',
    theme: 'Deep Work',
    keywords: ['hot spring', 'tatami', 'relaxing', 'tea'],
  },
  {
    region: 'Tokushima',
    title: 'Kamiyama Satellite Office Tour',
    theme: 'Workation',
    keywords: ['rural japan', 'old house', 'mountain', 'river'],
  },

  // B. éƒ½å¸‚å‹ãƒ†ãƒƒã‚¯ãƒ»ã‚¬ã‚¸ã‚§ãƒƒãƒˆå·¡ã‚Š (Tech & Industry)
  {
    region: 'Akihabara',
    title: 'Akihabara Retro Tech Hunt',
    theme: 'Tech',
    keywords: ['akihabara', 'electronics', 'retro game', 'neon'],
  },
  {
    region: 'Osaka',
    title: 'Osaka Den-Den Town Tech Tour',
    theme: 'Tech',
    keywords: ['osaka street', 'neon', 'shopping', 'electronics'],
  },
  {
    region: 'Fukuoka',
    title: 'Fukuoka Startup & Engineer Cafe',
    theme: 'Tech',
    keywords: ['fukuoka city', 'cafe', 'coworking', 'modern office'],
  },
  {
    region: 'Tsukuba',
    title: 'Tsukuba Space & Science Tour',
    theme: 'Science',
    keywords: ['rocket', 'space center', 'robot', 'science museum'],
  },
  {
    region: 'Nagoya',
    title: 'Nagoya Industrial Tech History',
    theme: 'Industry',
    keywords: ['factory', 'machine', 'museum', 'industrial'],
  },
  {
    region: 'Fukui',
    title: 'Sabae Glasses & Wearable Tech',
    theme: 'Industry',
    keywords: ['glasses', 'craftsmanship', 'workshop', 'tools'],
  },

  // C. ãƒãƒãƒ‰ãƒ»ã‚«ãƒ•ã‚§ä½œæ¥­ (Workation / Nomad)
  {
    region: 'Shinjuku',
    title: 'Tokyo Midnight Coding Cafes',
    theme: 'Nomad',
    keywords: ['night cafe', 'tokyo night', 'laptop', 'neon'],
  },
  {
    region: 'Sapporo',
    title: 'Sapporo Summer Escape & Parfait',
    theme: 'Workation',
    keywords: ['parfait', 'sapporo city', 'summer', 'cafe'],
  },
  {
    region: 'Kyoto',
    title: 'Kyoto Machiya Cafe & Temple Work',
    theme: 'Workation',
    keywords: ['kyoto street', 'matcha', 'temple', 'japanese garden'],
  },
  {
    region: 'Okinawa',
    title: 'Okinawa Ocean View Nomad',
    theme: 'Workation',
    keywords: ['blue ocean', 'tropical cafe', 'beach', 'coffee'],
  },
  {
    region: 'Sendai',
    title: 'Sendai Beef Tongue & Coworking',
    theme: 'Workation',
    keywords: ['grilled meat', 'sendai city', 'modern building', 'business'],
  },
  {
    region: 'Kobe',
    title: 'Kobe Port & Jazz Cafe Coding',
    theme: 'Relax',
    keywords: ['jazz cafe', 'coffee', 'kobe port', 'brick warehouse'],
  },

  // D. ãƒ‡ã‚¸ã‚¿ãƒ«ãƒ‡ãƒˆãƒƒã‚¯ã‚¹ãƒ»ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ (Refresh / Detox)
  {
    region: 'Tottori',
    title: 'Tottori Sand Dunes Digital Detox',
    theme: 'Detox',
    keywords: ['sand dunes', 'desert', 'sky', 'footsteps'],
  },
  {
    region: 'Yakushima',
    title: 'Yakushima Ancient Forest Trek',
    theme: 'Nature',
    keywords: ['ancient forest', 'moss', 'green', 'hiking'],
  },
  {
    region: 'Aomori',
    title: 'Aomori Hot Spring Digital Detox',
    theme: 'Detox',
    keywords: ['snow', 'hot spring', 'mountains', 'winter'],
  },
  {
    region: 'Gunma',
    title: 'Minakami Bungee & Adventure',
    theme: 'Activity',
    keywords: ['bungee jumping', 'river', 'bridge', 'mountain valley'],
  },
  {
    region: 'Naoshima',
    title: 'Naoshima Modern Art Island Tour',
    theme: 'Art',
    keywords: ['modern art', 'sculpture', 'sea', 'island'],
  },
  {
    region: 'Ise',
    title: 'Ise Jingu Shrine Spiritual Trip',
    theme: 'Culture',
    keywords: ['shinto shrine', 'torii gate', 'forest', 'sacred'],
  },

  // E. åŠ¹ç‡ãƒ»ãƒãƒ‹ã‚¢ãƒƒã‚¯ (Efficiency / Hobby)
  {
    region: 'Saitama',
    title: 'Saitama Railway Museum & Train View',
    theme: 'Hobby',
    keywords: ['train', 'railway', 'shinkansen', 'locomotive'],
  },
  {
    region: 'Toyama',
    title: 'Kurobe Dam Infrastructure Tour',
    theme: 'Industry',
    keywords: ['huge dam', 'water release', 'mountain', 'engineering'],
  },
  {
    region: 'Hiroshima',
    title: 'Kure Maritime Museum & Submarines',
    theme: 'History',
    keywords: ['submarine', 'battleship', 'harbor', 'navy'],
  },
  {
    region: 'Niigata',
    title: 'Sake Tasting & Station Onsen',
    theme: 'Food',
    keywords: ['sake bottles', 'rice field', 'snowy station', 'onsen'],
  },
  {
    region: 'Yamanashi',
    title: 'Sunrise Onsen & Mt Fuji View',
    theme: 'Nature',
    keywords: ['mount fuji', 'sunrise', 'outdoor bath', 'scenery'],
  },
  {
    region: 'Nagasaki',
    title: 'Gunkanjima Abandoned Island Tour',
    theme: 'History',
    keywords: ['abandoned building', 'ruins', 'concrete', 'island'],
  },
]
</file>

<file path="src/lib/llm/providers/google.ts">
import { createGoogleGenerativeAI } from '@ai-sdk/google'
import { generateObject, streamObject, type LanguageModel } from 'ai'
import { PlanSchema, type Plan } from '@/types/plan'
import type { LLMProvider, StreamResult } from '../types'

/**
 * Google Gemini provider implementation using Vercel AI SDK
 * Uses gemini-2.0-flash-exp model for fast and cost-effective generation
 */
export class GoogleProvider implements LLMProvider {
  readonly name = 'Google Gemini'
  private readonly apiKey: string
  private readonly model: string

  constructor(apiKey: string, model: string = 'gemini-2.0-flash-exp') {
    if (!apiKey) {
      throw new Error('Google API key is required')
    }
    this.apiKey = apiKey
    this.model = model
    console.log(
      `[GoogleProvider] Initialized with model: ${this.model} (received: ${model || 'undefined'})`
    )
  }

  getModelName(): string {
    return this.model
  }

  getModel(): LanguageModel {
    const google = createGoogleGenerativeAI({ apiKey: this.apiKey })
    return google(this.model)
  }

  async generatePlan(systemPrompt: string, userPrompt: string): Promise<Plan> {
    const result = await generateObject({
      model: this.getModel(),
      schema: PlanSchema,
      system: systemPrompt,
      prompt: userPrompt,
    })

    return result.object
  }

  streamPlan(systemPrompt: string, userPrompt: string): StreamResult {
    return streamObject({
      model: this.getModel(),
      schema: PlanSchema,
      system: systemPrompt,
      prompt: userPrompt,
    })
  }
}
</file>

<file path="src/lib/llm/providers/openai.ts">
import { openai } from '@ai-sdk/openai'
import { generateObject, streamObject, type LanguageModel } from 'ai'
import { PlanSchema, type Plan } from '@/types/plan'
import type { LLMProvider, StreamResult } from '../types'

/**
 * OpenAI provider implementation using Vercel AI SDK
 * Uses gpt-4o-mini model for cost-effective plan generation
 */
export class OpenAIProvider implements LLMProvider {
  readonly name = 'OpenAI'
  private readonly apiKey: string
  private readonly model: string

  constructor(apiKey: string, model: string = 'gpt-4o-mini') {
    if (!apiKey) {
      throw new Error('OpenAI API key is required')
    }
    this.apiKey = apiKey
    this.model = model
    console.log(
      `[OpenAIProvider] Initialized with model: ${this.model} (received: ${model || 'undefined'})`
    )
  }

  getModelName(): string {
    return this.model
  }

  getModel(): LanguageModel {
    return openai(this.model)
  }

  async generatePlan(systemPrompt: string, userPrompt: string): Promise<Plan> {
    const result = await generateObject({
      model: this.getModel(),
      schema: PlanSchema,
      system: systemPrompt,
      prompt: userPrompt,
    })

    return result.object
  }

  streamPlan(systemPrompt: string, userPrompt: string): StreamResult {
    return streamObject({
      model: this.getModel(),
      schema: PlanSchema,
      system: systemPrompt,
      prompt: userPrompt,
    })
  }
}
</file>

<file path="src/lib/llm/client.ts">
import type { LLMProvider } from './types'
import { OpenAIProvider } from './providers/openai'
import { GoogleProvider } from './providers/google'
import { env } from '@/env'

/**
 * Factory function to get the appropriate LLM client based on environment configuration
 * @returns Configured LLM provider instance
 * @throws Error if required API keys are missing or provider is invalid
 */
export function getLLMClient(): LLMProvider {
  const provider = (process.env.LLM_PROVIDER || 'openai').toLowerCase()

  switch (provider) {
    case 'openai':
      if (!process.env.OPENAI_API_KEY) {
        throw new Error(
          'OPENAI_API_KEY environment variable is required when using OpenAI provider'
        )
      }
      return new OpenAIProvider(process.env.OPENAI_API_KEY, env.OPENAI_MODEL)

    case 'google':
      if (!process.env.GEMINI_API_KEY) {
        throw new Error(
          'GEMINI_API_KEY environment variable is required when using Google provider'
        )
      }
      return new GoogleProvider(process.env.GEMINI_API_KEY, env.GEMINI_MODEL)

    default:
      throw new Error(
        `Unsupported LLM provider: ${provider}. Supported providers: openai, google`
      )
  }
}
</file>

<file path="src/lib/llm/types.ts">
import type { Plan } from '@/types/plan'
import type { LanguageModel } from 'ai'

/**
 * Stream result returned by streaming generation
 */
export interface StreamResult {
  toTextStreamResponse(): Response
}

/**
 * Common interface for all LLM providers
 * Abstracts away the differences between OpenAI, Google, Anthropic, etc.
 */
export interface LLMProvider {
  /**
   * Generate a travel plan based on system and user prompts
   * @param systemPrompt - Instructions for the AI model (role, constraints)
   * @param userPrompt - User's specific request (destination, preferences)
   * @returns Parsed travel plan object conforming to Plan schema
   */
  generatePlan(systemPrompt: string, userPrompt: string): Promise<Plan>

  /**
   * Stream a travel plan generation (for API endpoints)
   * @param systemPrompt - Instructions for the AI model (role, constraints)
   * @param userPrompt - User's specific request (destination, preferences)
   * @returns StreamResult that can be converted to Response
   */
  streamPlan(systemPrompt: string, userPrompt: string): StreamResult

  /**
   * Get the underlying AI SDK model instance
   * @returns LanguageModel instance for use with AI SDK functions
   */
  getModel(): LanguageModel

  /**
   * Provider name for logging and debugging
   */
  readonly name: string

  /**
   * Get the model name being used (for logging and debugging)
   * @returns Model identifier (e.g., "gpt-4o-mini", "gemini-2.0-flash-exp")
   */
  getModelName(): string
}
</file>

<file path="src/lib/debug.ts">
import { env } from '@/env'

/**
 * Debug utilities for conditional logging
 */

const IS_DEBUG = env.NEXT_PUBLIC_IS_DEBUG || env.NODE_ENV === 'development'

/**
 * Console.log wrapper that only logs when debug mode is enabled
 * @param args - Arguments to log
 */
export function debugLog(...args: unknown[]): void {
  if (IS_DEBUG) {
    console.log(...args)
  }
}

/**
 * Console.error wrapper (always logs errors regardless of debug mode)
 * @param args - Arguments to log
 */
export function debugError(...args: unknown[]): void {
  console.error(...args)
}
</file>

<file path="src/lib/rate-limit.ts">
import { Ratelimit } from '@upstash/ratelimit'
import { Redis } from '@upstash/redis'
import { env } from '@/env'

/**
 * Rate limiter configuration and instances
 * Uses type-safe environment variables from @/env
 */

/**
 * Global rate limiter: Total requests allowed across all users per day
 * Configured via env.GLOBAL_RATE_LIMIT_REQUESTS (default: 100/day)
 */
export const globalRateLimit =
  process.env.UPSTASH_REDIS_REST_URL && process.env.UPSTASH_REDIS_REST_TOKEN
    ? new Ratelimit({
        redis: Redis.fromEnv(),
        limiter: Ratelimit.slidingWindow(env.GLOBAL_RATE_LIMIT_REQUESTS, '1 d'),
        analytics: true,
        prefix: 'ratelimit_v2:global',
      })
    : null

/**
 * IP-based rate limiter: Requests allowed per IP address per day
 * Configured via env.IP_RATE_LIMIT_REQUESTS (default: 5/day)
 */
export const ipRateLimit =
  process.env.UPSTASH_REDIS_REST_URL && process.env.UPSTASH_REDIS_REST_TOKEN
    ? new Ratelimit({
        redis: Redis.fromEnv(),
        limiter: Ratelimit.slidingWindow(env.IP_RATE_LIMIT_REQUESTS, '1 d'),
        analytics: true,
        prefix: 'ratelimit_v2:ip',
      })
    : null

/**
 * Checks rate limits for a given identifier (global or IP-based)
 * @param identifier - The unique identifier to check (e.g., 'global' or IP address)
 * @param limiter - The rate limiter instance to use
 * @returns Object with success status and limit information
 * @throws Error if rate limit is exceeded
 */
export async function checkRateLimit(
  identifier: string,
  limiter: Ratelimit | null
): Promise<{
  success: boolean
  limit: number
  remaining: number
  reset: number
}> {
  if (!limiter) {
    return {
      success: true,
      limit: 0,
      remaining: 0,
      reset: 0,
    }
  }

  const result = await limiter.limit(identifier)

  if (!result.success) {
    throw new Error(
      `Rate limit exceeded. Try again in ${Math.ceil((result.reset - Date.now()) / 1000)} seconds.`
    )
  }

  return {
    success: result.success,
    limit: result.limit,
    remaining: result.remaining,
    reset: result.reset,
  }
}

/**
 * Extracts client IP address from request headers
 * @param headers - Request headers
 * @returns Client IP address or 'unknown'
 */
export function getClientIP(headers: Headers): string {
  return (
    headers.get('x-forwarded-for')?.split(',')[0] ||
    headers.get('x-real-ip') ||
    'unknown'
  )
}
</file>

<file path="src/lib/utils.ts">
import { clsx, type ClassValue } from 'clsx'
import { twMerge } from 'tailwind-merge'

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}
</file>

<file path="src/test/setup.ts">
import '@testing-library/jest-dom'
</file>

<file path=".gitignore">
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# dependencies
/node_modules
/.pnp
.pnp.*
.yarn/*
!.yarn/patches
!.yarn/plugins
!.yarn/releases
!.yarn/versions

# testing
/coverage

# next.js
/.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*
.pnpm-debug.log*

# env files (can opt-in for committing if needed)
.env*
!.env.example

# vercel
.vercel

# typescript
*.tsbuildinfo
next-env.d.ts

# test data
/data/plans-test
</file>

<file path=".prettierignore">
node_modules
.next
out
build
dist
coverage
*.lock
package-lock.json
</file>

<file path=".prettierrc">
{
  "semi": false,
  "singleQuote": true,
  "tabWidth": 2,
  "trailingComma": "es5",
  "printWidth": 80,
  "arrowParens": "avoid"
}
</file>

<file path="components.json">
{
  "$schema": "https://ui.shadcn.com/schema.json",
  "style": "new-york",
  "rsc": true,
  "tsx": true,
  "tailwind": {
    "config": "",
    "css": "src/app/globals.css",
    "baseColor": "neutral",
    "cssVariables": true,
    "prefix": ""
  },
  "iconLibrary": "lucide",
  "aliases": {
    "components": "@/components",
    "utils": "@/lib/utils",
    "ui": "@/components/ui",
    "lib": "@/lib",
    "hooks": "@/hooks"
  },
  "registries": {}
}
</file>

<file path="eslint.config.mjs">
import { defineConfig, globalIgnores } from "eslint/config";
import nextVitals from "eslint-config-next/core-web-vitals";
import nextTs from "eslint-config-next/typescript";
import eslintConfigPrettier from "eslint-config-prettier";
import unusedImports from "eslint-plugin-unused-imports";

const eslintConfig = defineConfig([
  ...nextVitals,
  ...nextTs,
  eslintConfigPrettier,
  {
    plugins: {
      "unused-imports": unusedImports,
    },
    rules: {
      "unused-imports/no-unused-imports": "error",
      "unused-imports/no-unused-vars": [
        "warn",
        {
          vars: "all",
          varsIgnorePattern: "^_",
          args: "after-used",
          argsIgnorePattern: "^_",
        },
      ],
    },
  },
  // Override default ignores of eslint-config-next.
  globalIgnores([
    // Default ignores of eslint-config-next:
    ".next/**",
    "out/**",
    "build/**",
    "next-env.d.ts",
  ]),
]);

export default eslintConfig;
</file>

<file path="knip.json">
{
  "entry": ["src/app/**/*.{ts,tsx}", "scripts/**/*.ts"],
  "project": ["src/**/*.{ts,tsx}", "scripts/**/*.ts"],
  "ignore": [
    "src/components/ui/**",
    "src/lib/utils.ts",
    "src/types/**",
    "src/lib/repositories/plan-repository.ts"
  ],
  "ignoreExportsUsedInFile": true,
  "ignoreDependencies": [
    "@radix-ui/react-dialog",
    "next-themes",
    "@testing-library/react",
    "postcss",
    "tailwindcss",
    "tw-animate-css",
    "openai",
    "tsconfig-paths"
  ]
}
</file>

<file path="playwright.config.ts">
import { defineConfig, devices } from '@playwright/test'

export default defineConfig({
  testDir: './e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: 'html',
  use: {
    baseURL: 'http://localhost:3000',
    trace: 'on-first-retry',
  },
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
  ],
  webServer: {
    command: 'npm run dev',
    url: 'http://localhost:3000',
    reuseExistingServer: !process.env.CI,
  },
})
</file>

<file path="postcss.config.mjs">
const config = {
  plugins: {
    "@tailwindcss/postcss": {},
  },
};

export default config;
</file>

<file path="README.md">
This is a [Next.js](https://nextjs.org) project bootstrapped with [`create-next-app`](https://nextjs.org/docs/app/api-reference/cli/create-next-app).

## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦

ã“ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€æ—…è¡Œãƒ—ãƒ©ãƒ³ã‚’è‡ªå‹•ç”Ÿæˆã™ã‚‹ãŸã‚ã®ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æŒ‡å®šã—ãŸæ¡ä»¶ã«åŸºã¥ã„ã¦ã€æœ€é©ãªæ—…è¡Œãƒ—ãƒ©ãƒ³ã‚’ç”Ÿæˆã—ã€è¦–è¦šçš„ã«è¡¨ç¤ºã—ã¾ã™ã€‚

## æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

- **Next.js**: Reactãƒ™ãƒ¼ã‚¹ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã€ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚„é™çš„ã‚µã‚¤ãƒˆç”Ÿæˆã‚’ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚
- **Vercel**: Next.jsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã€‚
- **OpenAI API**: è‡ªç„¶è¨€èªå‡¦ç†ã‚’åˆ©ç”¨ã—ã¦ã€æ—…è¡Œãƒ—ãƒ©ãƒ³ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
- **Unsplash API**: é«˜å“è³ªãªç”»åƒã‚’å–å¾—ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã—ã¾ã™ã€‚
- **Redis**: ãƒ‡ãƒ¼ã‚¿ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚„ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã«ä½¿ç”¨ã—ã¾ã™ã€‚

## ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †

1. ãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã—ã¾ã™ã€‚
2. å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```bash
npm install
# or
yarn install
# or
pnpm install
```

3. é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¾ã™ã€‚

```bash
npm run dev
# or
yarn dev
# or
pnpm dev
```

4. ãƒ–ãƒ©ã‚¦ã‚¶ã§ [http://localhost:3000](http://localhost:3000) ã‚’é–‹ã„ã¦çµæœã‚’ç¢ºèªã—ã¾ã™ã€‚

## Learn More

To learn more about Next.js, take a look at the following resources:

- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.
- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.

You can check out [the Next.js GitHub repository](https://github.com/vercel/next.js) - your feedback and contributions are welcome!

## Deploy on Vercel

The easiest way to deploy your Next.js app is to use the [Vercel Platform](https://vercel.com/new?utm_medium=default-template&filter=next.js&utm_source=create-next-app&utm_campaign=create-next-app-readme) from the creators of Next.js.

Check out our [Next.js deployment documentation](https://nextjs.org/docs/app/building-your-application/deploying) for more details.
</file>

<file path="tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./src/*"]
    }
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts",
    "**/*.mts"
  ],
  "exclude": ["node_modules"]
}
</file>

<file path="tsconfig.scripts.json">
{
  "extends": "./tsconfig.json",
  "compilerOptions": {
    "module": "commonjs",
    "moduleResolution": "node",
    "target": "ES2020",
    "lib": ["ES2020"],
    "esModuleInterop": true,
    "skipLibCheck": true,
    "strict": true,
    "resolveJsonModule": true,
    "allowSyntheticDefaultImports": true,
    "noEmit": true,
    "baseUrl": ".",
    "paths": {
      "@/*": ["./src/*"]
    }
  },
  "include": ["scripts/**/*", "src/**/*"],
  "exclude": ["node_modules", ".next", "out"],
  "ts-node": {
    "require": ["tsconfig-paths/register"]
  }
}
</file>

<file path="vitest.config.ts">
import { defineConfig } from 'vitest/config'
import react from '@vitejs/plugin-react'
import path from 'path'

export default defineConfig({
  plugins: [react()],
  test: {
    environment: 'jsdom',
    globals: true,
    setupFiles: './src/test/setup.ts',
  },
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src'),
    },
  },
})
</file>

<file path=".claude/settings.json">
{
  "permissions": {
    "allow": ["Bash(npx repomix)"]
  }
}
</file>

<file path="scripts/generate-daily.ts">
#!/usr/bin/env ts-node
/**
 * Automated Daily Travel Plan Generator (V3)
 *
 * This script generates SEO-optimized travel plans based on curated seed data.
 * It runs daily via GitHub Actions to populate the database with fresh content.
 *
 * Flow:
 * 1. Load environment variables and validate configuration
 * 2. Select a random seed plan from SEED_PLANS
 * 3. Generate travel plan using configured LLM provider (OpenAI or Google Gemini)
 * 4. Save plan to Redis database (V3 namespace)
 * 5. Send notification to Discord webhook
 *
 * Usage:
 *   ts-node scripts/generate-daily.ts
 *
 * Requirements:
 *   - LLM_PROVIDER (optional, defaults to 'openai')
 *   - OPENAI_API_KEY (if using OpenAI)
 *   - GEMINI_API_KEY (if using Google Gemini)
 *   - UPSTASH_REDIS_REST_URL
 *   - UPSTASH_REDIS_REST_TOKEN
 *   - DISCORD_WEBHOOK_URL (optional)
 */

import { generateObject } from 'ai'
import { getLLMClient } from '../src/lib/llm/client'
import { PlanRepository } from '../src/lib/repositories/plan-repository'
import { SEED_PLANS, SeedPlan } from '../src/lib/constants/seeds'
import { OptimizedPlanSchema, type OptimizedPlan } from '../src/types/plan'

/**
 * Environment variable validation
 */
function validateEnvironment(): void {
  const provider = (process.env.LLM_PROVIDER || 'openai').toLowerCase()

  const required = ['UPSTASH_REDIS_REST_URL', 'UPSTASH_REDIS_REST_TOKEN']

  // Add provider-specific API key requirement
  if (provider === 'openai') {
    required.push('OPENAI_API_KEY')
  } else if (provider === 'google') {
    required.push('GEMINI_API_KEY')
  }

  const missing = required.filter(key => !process.env[key])

  if (missing.length > 0) {
    console.error('âŒ Missing required environment variables:')
    missing.forEach(key => console.error(`   - ${key}`))
    process.exit(1)
  }

  console.log(`âœ“ Environment variables validated (LLM Provider: ${provider})`)
}

/**
 * Randomly selects an element from an array
 */
function randomChoice<T>(array: readonly T[]): T {
  return array[Math.floor(Math.random() * array.length)]
}

/**
 * Generates an optimized travel plan using configured LLM provider based on seed data
 */
async function generatePlan(seed: SeedPlan): Promise<OptimizedPlan> {
  console.log(`\nğŸ“ Generating V3 optimized plan for: ${seed.title}`)
  console.log(`   Region: ${seed.region}`)
  console.log(`   Theme: ${seed.theme}`)
  console.log(`   Keywords: ${seed.keywords.join(', ')}`)

  const systemPrompt = `# Role
ã‚ãªãŸã¯ã€Œãƒ­ã‚¸ã‚«ãƒ«ãªæ—…è¡Œå»ºç¯‰å®¶ã€ã§ã™ã€‚åŠ¹ç‡çš„ã§å®Ÿç”¨çš„ãªä¸€äººæ—…ã®æ—…ç¨‹ã‚’è¨­è¨ˆã™ã‚‹AIã§ã™ã€‚

# ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 
1. **æ‹ ç‚¹æˆ¦ç•¥:** æŒ‡å®šã•ã‚ŒãŸåœ°åŸŸã®ä¸»è¦é§…å‘¨è¾ºã‚’ã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹ã¨ã™ã‚‹
2. **ãƒ«ãƒ¼ãƒˆæœ€é©åŒ–:** æ‹ ç‚¹ â†’ ãƒ¡ã‚¸ãƒ£ãƒ¼ã‚¹ãƒãƒƒãƒˆ â†’ ã‚µãƒ†ãƒ©ã‚¤ãƒˆï¼ˆç©´å ´ï¼‰ â†’ æ‹ ç‚¹ ã¸æˆ»ã‚‹ã€Œä¸€ç­†æ›¸ããƒ«ãƒ¼ãƒˆã€ã‚’æ§‹ç¯‰ã™ã‚‹
3. **æ™‚é–“ç®¡ç†:** å„åœ°ç‚¹é–“ã®ç§»å‹•æ™‚é–“ã‚’è€ƒæ…®ã—ã¦ã€ç¾å®Ÿçš„ãªã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’çµ„ã‚€
4. **é£Ÿäº‹:** ç‰¹å®šã®åº—ã‚’äºˆç´„ã•ã›ãªã„ã€‚ã€Œã“ã®ã‚¨ãƒªã‚¢ãªã‚‰â—‹â—‹ãŒãŠã™ã™ã‚ï¼ˆå€™è£œ: Aåº—, Båº—ï¼‰ã€ã¨ã„ã†ææ¡ˆã«ç•™ã‚ã‚‹

# Google Maps URLç”Ÿæˆï¼ˆé‡è¦ï¼‰
å„æ—¥ã®ãƒ«ãƒ¼ãƒˆã«å¯¾ã—ã¦ã€å®Ÿéš›ã«æ©Ÿèƒ½ã™ã‚‹Google Maps URLã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ã€‚

**ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ:**
\`https://www.google.com/maps/dir/?api=1&origin={æ‹ ç‚¹}&destination={æ‹ ç‚¹}&waypoints={ã‚¹ãƒãƒƒãƒˆA}|{ã‚¹ãƒãƒƒãƒˆB}|{ã‚¹ãƒãƒƒãƒˆC}\`

**ãƒ«ãƒ¼ãƒ«:**
- originï¼ˆå‡ºç™ºåœ°ï¼‰ã¨destinationï¼ˆåˆ°ç€åœ°ï¼‰ã¯ä¸¡æ–¹ã¨ã‚‚æ‹ ç‚¹ã‚¨ãƒªã‚¢ã«ã™ã‚‹
- waypointsã¯ã€Œ|ã€ï¼ˆãƒ‘ã‚¤ãƒ—ï¼‰ã§åŒºåˆ‡ã‚‹
- æ—¥æœ¬èªã®ã‚¹ãƒãƒƒãƒˆåã¯ãã®ã¾ã¾ä½¿ç”¨å¯èƒ½

# å‡ºåŠ›è¨€èª
**ã™ã¹ã¦ã®å‡ºåŠ›ã¯æ—¥æœ¬èªã§è¨˜è¿°ã™ã‚‹ã“ã¨**

# å‡ºåŠ›æ§‹é€ 
- **title:** æ—…ã®ã‚¿ã‚¤ãƒˆãƒ«
- **intro:** åŠ¹ç‡æ€§ã¨è‡ªç”±åº¦ã‚’ã‚¢ãƒ”ãƒ¼ãƒ«ã™ã‚‹å°å…¥æ–‡ï¼ˆ100-150æ–‡å­—ï¼‰
- **target:** å¸¸ã« "general"
- **itinerary:** æ—¥ã”ã¨ã®æ—…ç¨‹
  - day: æ—¥æ•°ï¼ˆ1ã‹ã‚‰é–‹å§‹ï¼‰
  - google_maps_url: ãã®æ—¥ã®ãƒ«ãƒ¼ãƒˆå…¨ä½“ã‚’ç¤ºã™Google Maps URL
  - events: ã‚¤ãƒ™ãƒ³ãƒˆã®é…åˆ—
    - time: æ™‚åˆ»ï¼ˆä¾‹: "10:00"ï¼‰
    - spot: ã‚¹ãƒãƒƒãƒˆå
    - query: Google Mapsæ¤œç´¢ã‚¯ã‚¨ãƒª
    - description: ãã®ã‚¹ãƒãƒƒãƒˆã§ã®éã”ã—æ–¹ã‚„ãƒã‚¤ãƒ³ãƒˆ
    - type: "spot" | "food" | "move"
- **affiliate:** ãŠã™ã™ã‚ã‚µãƒ¼ãƒ“ã‚¹/å•†å“
  - label: è¡¨ç¤ºãƒ©ãƒ™ãƒ«
  - url: ãƒªãƒ³ã‚¯URLï¼ˆãƒ¬ãƒ³ã‚¿ã‚«ãƒ¼ã€ãƒ›ãƒ†ãƒ«äºˆç´„ã‚µã‚¤ãƒˆãªã©ï¼‰`

  const userPrompt = `ä»¥ä¸‹ã®æ¡ä»¶ã§æœ€é©åŒ–ã•ã‚ŒãŸæ—…è¡Œãƒ—ãƒ©ãƒ³ã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š

**ç›®çš„åœ°:** ${seed.region}
**ãƒ†ãƒ¼ãƒ:** ${seed.theme}
**ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰:** ${seed.keywords.join(', ')}
**ã‚¿ã‚¤ãƒˆãƒ«æ¡ˆ:** ${seed.title}

æ‹ ç‚¹ï¼ˆ${seed.region}ã®ä¸»è¦é§…å‘¨è¾ºï¼‰ã‚’èµ·ç‚¹ãƒ»çµ‚ç‚¹ã¨ã™ã‚‹åŠ¹ç‡çš„ãªå‘¨éŠãƒ«ãƒ¼ãƒˆã‚’è¨­è¨ˆã—ã¦ãã ã•ã„ã€‚
2ã€œ3æ—¥é–“ã®ãƒ—ãƒ©ãƒ³ã§ã€å„æ—¥ã®google_maps_urlã«ã¯ã€å®Ÿéš›ã«ã‚¯ãƒªãƒƒã‚¯ã—ã¦ä½¿ãˆã‚‹æ­£ã—ã„URLã‚’å«ã‚ã¦ãã ã•ã„ã€‚`

  const llmClient = getLLMClient()

  const result = await generateObject({
    model: llmClient.getModel(),
    system: systemPrompt,
    prompt: userPrompt,
    schema: OptimizedPlanSchema,
  })

  const plan = result.object

  console.log(`âœ“ Plan generated: "${plan.title}"`)
  console.log(`   Days: ${plan.itinerary.length}`)
  console.log(
    `   Total events: ${plan.itinerary.reduce((acc: number, day) => acc + day.events.length, 0)}`
  )

  return plan
}

/**
 * Sends a notification to Discord webhook
 */
async function sendDiscordNotification(
  seed: SeedPlan,
  slug: string,
  planTitle: string
): Promise<void> {
  if (!process.env.DISCORD_WEBHOOK_URL) {
    console.log('âš  Discord webhook not configured, skipping notification')
    return
  }

  try {
    const url = `https://www.trip-plan-architect.com/plans/${slug}`
    const embed = {
      title: 'âœˆï¸ New V3 Travel Plan Generated',
      description: planTitle,
      color: 0x2563eb, // Blue-600
      fields: [
        {
          name: 'Region',
          value: seed.region,
          inline: true,
        },
        {
          name: 'Theme',
          value: seed.theme,
          inline: true,
        },
        {
          name: 'Keywords',
          value: seed.keywords.join(', '),
          inline: false,
        },
        {
          name: 'URL',
          value: url,
          inline: false,
        },
      ],
      timestamp: new Date().toISOString(),
    }

    const response = await fetch(process.env.DISCORD_WEBHOOK_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        embeds: [embed],
      }),
    })

    if (!response.ok) {
      console.error(
        `âš  Discord notification failed: ${response.status} ${response.statusText}`
      )
    } else {
      console.log('âœ“ Discord notification sent')
    }
  } catch (error) {
    console.error('âš  Error sending Discord notification:', error)
  }
}

/**
 * Main execution function
 */
async function main() {
  console.log('ğŸš€ Starting V3 automated travel plan generation...\n')

  // Step 1: Validate environment
  validateEnvironment()

  // Step 2: Check if we have seed data
  if (SEED_PLANS.length === 0) {
    console.error('âŒ No seed plans found in SEED_PLANS array')
    console.error(
      '   Please add seed data to src/lib/constants/seeds.ts before running this script'
    )
    process.exit(1)
  }

  console.log(`âœ“ Loaded ${SEED_PLANS.length} seed plans\n`)

  // Step 3: Select random seed
  const selectedSeed = randomChoice(SEED_PLANS)
  console.log('ğŸ² Randomly selected seed:')
  console.log(`   ${selectedSeed.title} (${selectedSeed.region})`)

  try {
    // Step 4: Generate V3 optimized plan
    const plan = await generatePlan(selectedSeed)

    // Step 5: Save to Redis (V3 namespace)
    console.log('\nğŸ’¾ Saving V3 plan to Redis...')
    const repository = new PlanRepository()
    const slug = await repository.saveV3(plan)
    console.log(`âœ“ Plan saved successfully: ${slug}`)

    // Step 6: Send Discord notification
    console.log('\nğŸ“¢ Sending notification...')
    await sendDiscordNotification(selectedSeed, slug, plan.title)

    // Success summary
    console.log('\nâœ… V3 Generation completed successfully!')
    console.log(`   Slug: ${slug}`)
    console.log(`   Title: ${plan.title}`)
    console.log(`   URL: https://www.trip-plan-architect.com/plans/${slug}\n`)
  } catch (error) {
    console.error('\nâŒ Error during plan generation:', error)
    process.exit(1)
  }
}

// Execute main function
main()
</file>

<file path="src/app/api/generate/__tests__/route.test.ts">
import { describe, it, expect } from 'vitest'
import { GenerateInputV3Schema } from '@/types/plan'
import { getClientIP } from '@/lib/rate-limit'
import { PlanRepository } from '@/lib/repositories/plan-repository'

describe('API Route Components', () => {
  describe('GenerateInputV3Schema', () => {
    it('should validate correct input', () => {
      const validInput = {
        destination: 'é•·å´',
        base_area: 'é•·å´é§…å‘¨è¾º',
        transportation: 'transit',
      }

      const result = GenerateInputV3Schema.safeParse(validInput)
      expect(result.success).toBe(true)
      if (result.success) {
        expect(result.data.destination).toBe('é•·å´')
        expect(result.data.base_area).toBe('é•·å´é§…å‘¨è¾º')
        expect(result.data.transportation).toBe('transit')
      }
    })

    it('should validate car transportation', () => {
      const validInput = {
        destination: 'é‡‘æ²¢',
        base_area: 'é‡‘æ²¢é§…',
        transportation: 'car',
      }

      const result = GenerateInputV3Schema.safeParse(validInput)
      expect(result.success).toBe(true)
      if (result.success) {
        expect(result.data.transportation).toBe('car')
      }
    })

    it('should reject empty destination', () => {
      const invalidInput = {
        destination: '',
        base_area: 'é•·å´é§…å‘¨è¾º',
        transportation: 'transit',
      }

      const result = GenerateInputV3Schema.safeParse(invalidInput)
      expect(result.success).toBe(false)
    })

    it('should reject empty base_area', () => {
      const invalidInput = {
        destination: 'é•·å´',
        base_area: '',
        transportation: 'transit',
      }

      const result = GenerateInputV3Schema.safeParse(invalidInput)
      expect(result.success).toBe(false)
    })

    it('should reject invalid transportation', () => {
      const invalidInput = {
        destination: 'é•·å´',
        base_area: 'é•·å´é§…å‘¨è¾º',
        transportation: 'bicycle',
      }

      const result = GenerateInputV3Schema.safeParse(invalidInput)
      expect(result.success).toBe(false)
    })

    it('should reject missing transportation', () => {
      const invalidInput = {
        destination: 'é•·å´',
        base_area: 'é•·å´é§…å‘¨è¾º',
      }

      const result = GenerateInputV3Schema.safeParse(invalidInput)
      expect(result.success).toBe(false)
    })
  })

  describe('getClientIP', () => {
    it('should extract IP from x-forwarded-for header', () => {
      const headers = new Headers({
        'x-forwarded-for': '192.168.1.1, 10.0.0.1',
      })

      const ip = getClientIP(headers)
      expect(ip).toBe('192.168.1.1')
    })

    it('should extract IP from x-real-ip header', () => {
      const headers = new Headers({
        'x-real-ip': '192.168.1.2',
      })

      const ip = getClientIP(headers)
      expect(ip).toBe('192.168.1.2')
    })

    it('should return unknown for missing headers', () => {
      const headers = new Headers()
      const ip = getClientIP(headers)
      expect(ip).toBe('unknown')
    })
  })

  describe('PlanRepository Integration', () => {
    it('should be instantiable without Redis', () => {
      const repo = new PlanRepository()
      expect(repo).toBeDefined()
    })
  })
})
</file>

<file path="src/app/layout.tsx">
import type { Metadata } from 'next'
import { Noto_Sans_JP, Geist_Mono } from 'next/font/google'
import { GoogleAnalytics } from '@next/third-parties/google'
import { Toaster } from 'sonner'
import { Footer } from '@/components/footer'
import './globals.css'

const notoSansJP = Noto_Sans_JP({
  variable: '--font-noto-sans-jp',
  subsets: ['latin'],
  weight: ['400', '500', '700'],
})

const geistMono = Geist_Mono({
  variable: '--font-geist-mono',
  subsets: ['latin'],
})

export const metadata: Metadata = {
  title: 'Optimized Solo Travel - åŠ¹ç‡çš„ãªä¸€äººæ—…ãƒ«ãƒ¼ãƒˆè¨­è¨ˆ',
  description:
    'è¡ŒããŸã„å ´æ‰€ã‚’æœ€é©ãªãƒ«ãƒ¼ãƒˆã«ã€‚30ä»£ã‹ã‚‰ã®åŠ¹ç‡çš„ãªã‚½ãƒ­æ—…ã‚’AIãŒè¨­è¨ˆã—ã¾ã™ã€‚æ‹ ç‚¹ã‹ã‚‰å§‹ã¾ã‚‹ä¸€ç­†æ›¸ããƒ«ãƒ¼ãƒˆã§ã€è‡ªç”±ã§ç„¡é§„ã®ãªã„æ—…ã‚’ã€‚',
  openGraph: {
    title: 'Optimized Solo Travel - åŠ¹ç‡çš„ãªä¸€äººæ—…ãƒ«ãƒ¼ãƒˆè¨­è¨ˆ',
    description:
      'è¡ŒããŸã„å ´æ‰€ã‚’æœ€é©ãªãƒ«ãƒ¼ãƒˆã«ã€‚30ä»£ã‹ã‚‰ã®åŠ¹ç‡çš„ãªã‚½ãƒ­æ—…ã‚’AIãŒè¨­è¨ˆã—ã¾ã™ã€‚æ‹ ç‚¹ã‹ã‚‰å§‹ã¾ã‚‹ä¸€ç­†æ›¸ããƒ«ãƒ¼ãƒˆã§ã€è‡ªç”±ã§ç„¡é§„ã®ãªã„æ—…ã‚’ã€‚',
    type: 'website',
  },
  twitter: {
    card: 'summary_large_image',
    title: 'Optimized Solo Travel - åŠ¹ç‡çš„ãªä¸€äººæ—…ãƒ«ãƒ¼ãƒˆè¨­è¨ˆ',
    description:
      'è¡ŒããŸã„å ´æ‰€ã‚’æœ€é©ãªãƒ«ãƒ¼ãƒˆã«ã€‚30ä»£ã‹ã‚‰ã®åŠ¹ç‡çš„ãªã‚½ãƒ­æ—…ã‚’AIãŒè¨­è¨ˆã—ã¾ã™ã€‚æ‹ ç‚¹ã‹ã‚‰å§‹ã¾ã‚‹ä¸€ç­†æ›¸ããƒ«ãƒ¼ãƒˆã§ã€è‡ªç”±ã§ç„¡é§„ã®ãªã„æ—…ã‚’ã€‚',
  },
}

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode
}>) {
  return (
    <html lang="ja">
      <body
        className={`${notoSansJP.variable} ${geistMono.variable} antialiased`}
      >
        {children}
        <Footer />
        <Toaster position="top-center" />
      </body>
      <GoogleAnalytics gaId="G-ZDYP124TX4" />
    </html>
  )
}
</file>

<file path="src/components/footer.tsx">
'use client'

import Link from 'next/link'

export function Footer() {
  const currentYear = new Date().getFullYear()

  return (
    <footer className="border-t bg-white">
      <div className="container mx-auto px-4 py-6">
        <div className="flex flex-col items-center justify-center gap-4 text-sm text-muted-foreground md:flex-row md:justify-between">
          {/* Links */}
          <nav className="flex gap-6">
            <Link
              href="/"
              className="hover:text-foreground transition-colors"
              onClick={e => {
                e.preventDefault()
                window.location.href = '/'
              }}
            >
              ãƒ›ãƒ¼ãƒ 
            </Link>
            <Link
              href="/terms"
              className="hover:text-foreground transition-colors"
            >
              åˆ©ç”¨è¦ç´„
            </Link>
            <Link
              href="/privacy"
              className="hover:text-foreground transition-colors"
            >
              ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼
            </Link>
            <a
              href="https://x.com/TripPlanArch"
              target="_blank"
              rel="noopener noreferrer"
              className="hover:text-foreground transition-colors"
            >
              ãŠå•ã„åˆã‚ã›
            </a>
          </nav>

          {/* Copyright */}
          <p className="text-center">
            Â© {currentYear} Trip Plan Architect. All rights reserved.
          </p>
        </div>
      </div>
    </footer>
  )
}
</file>

<file path="src/lib/unsplash.ts">
import { env } from '@/env'
import { debugLog } from '@/lib/debug'

/**
 * Unsplash API integration for fetching location images
 * Uses the official Unsplash API (not the deprecated Source service)
 */

interface UnsplashPhoto {
  id: string
  urls: {
    raw: string
    full: string
    regular: string
    small: string
    thumb: string
  }
  alt_description: string | null
  user: {
    name: string
    username: string
  }
}

interface UnsplashSearchResponse {
  total: number
  total_pages: number
  results: UnsplashPhoto[]
}

const UNSPLASH_API_URL = 'https://api.unsplash.com/search/photos'

/**
 * Sanitizes search query by removing parenthetical content
 * @param query - Raw search query
 * @returns Sanitized query without parentheses and their content
 */
export function sanitizeQuery(query: string): string {
  // Remove parentheses and their content, then trim whitespace
  return query.replace(/\s*\(.*?\)\s*/g, '').trim()
}

/**
 * Fetches an image URL from Unsplash API based on a search query
 * @param query - Search query (e.g., "Tokyo Tower", "Paris Eiffel Tower")
 * @returns Image URL or null if not found/error
 */
export async function getUnsplashImage(query: string): Promise<string | null> {
  // Return null if API key is not configured
  if (!env.UNSPLASH_ACCESS_KEY) {
    debugLog(
      '[Unsplash] API key not configured - UNSPLASH_ACCESS_KEY is missing'
    )
    return null
  }

  try {
    // Sanitize query to improve search accuracy
    const sanitizedQuery = sanitizeQuery(query)
    debugLog(
      `[Unsplash] Original query: "${query}" -> Sanitized: "${sanitizedQuery}"`
    )

    const url = new URL(UNSPLASH_API_URL)
    url.searchParams.set('query', sanitizedQuery)
    url.searchParams.set('orientation', 'landscape')
    url.searchParams.set('per_page', '1')

    // Fetch with timeout to prevent hanging
    const controller = new AbortController()
    const timeoutId = setTimeout(() => controller.abort(), 3000)

    const response = await fetch(url.toString(), {
      headers: {
        Authorization: `Client-ID ${env.UNSPLASH_ACCESS_KEY}`,
      },
      signal: controller.signal,
      next: {
        // Cache for 24 hours to avoid hitting rate limits
        revalidate: 86400,
      },
    })

    clearTimeout(timeoutId)

    if (!response.ok) {
      const errorText = await response.text()
      console.error(
        `[Unsplash] âŒ API error: ${response.status} ${response.statusText}`
      )
      console.error(`[Unsplash] Error details:`, errorText)
      console.error(`[Unsplash] Query was: "${sanitizedQuery}"`)
      return null
    }

    const data: UnsplashSearchResponse = await response.json()

    if (data.results.length === 0) {
      debugLog(`[Unsplash] No images found for query: ${sanitizedQuery}`)
      return null
    }

    // Return the regular size URL (good balance between quality and load time)
    return data.results[0].urls.regular
  } catch (error) {
    if (error instanceof Error && error.name === 'AbortError') {
      console.error('[Unsplash] Request timeout (3000ms exceeded)')
    } else {
      debugLog('[Unsplash] Error fetching image:', error)
    }
    return null
  }
}
</file>

<file path=".env.example">
# ===================================
# Trip Plan Architect - Environment Variables
# ===================================
# All environment variables are validated using Zod schema in src/env.ts

# LLM Provider Selection (openai or google)
LLM_PROVIDER=openai

# OpenAI API Configuration (REQUIRED if LLM_PROVIDER=openai)
OPENAI_API_KEY=your_openai_api_key_here
# OpenAI Model (optional, default: gpt-4o-mini)
# Available models: gpt-4o, gpt-4o-mini, gpt-4-turbo, gpt-3.5-turbo
# Note: gpt-4o-mini has faster generation speed (2x faster than gpt-4o)
OPENAI_MODEL=gpt-4o-mini

# Google Gemini API Configuration (REQUIRED if LLM_PROVIDER=google)
GEMINI_API_KEY=your_gemini_api_key_here
# Gemini Model (optional, default: gemini-2.0-flash-exp)
# Available models: gemini-2.0-flash-exp, gemini-1.5-pro, gemini-1.5-flash
GEMINI_MODEL=gemini-2.0-flash-exp

# Upstash Redis Configuration (REQUIRED for production - rate limiting and plan storage)
# Get your credentials from: https://console.upstash.com/
# If not set, rate limiting will be disabled (dev mode only)
UPSTASH_REDIS_REST_URL=your_upstash_redis_url_here
UPSTASH_REDIS_REST_TOKEN=your_upstash_redis_token_here

# Unsplash API Configuration (optional - for spot images)
# Get your API key from: https://unsplash.com/developers
# If not set, images will use gradient fallback
UNSPLASH_ACCESS_KEY=your_unsplash_access_key_here

# Discord Webhook (optional - for notifications)
DISCORD_WEBHOOK_URL=your_discord_webhook_url_here

# Base URL (required for production)
NEXT_PUBLIC_BASE_URL=http://localhost:3000

# Rate Limit Configuration (optional)
# Global rate limit: Total requests allowed across all users per day (default: 100)
GLOBAL_RATE_LIMIT_REQUESTS=100
# IP rate limit: Requests allowed per IP address per day (default: 5)
IP_RATE_LIMIT_REQUESTS=5

# Debug Mode (optional, defaults to false in production)
# Set to "true" to enable debug logging
# Defaults to true in development, false in production
NEXT_PUBLIC_IS_DEBUG=false

# Rakuten Developers API (optional - for hotel affiliate)
# Get your credentials from: https://webservice.rakuten.co.jp/
RAKUTEN_APP_ID=your_rakuten_app_id_here
RAKUTEN_AFFILIATE_ID=your_rakuten_affiliate_id_here
</file>

<file path="next.config.ts">
import type { NextConfig } from 'next'

const nextConfig: NextConfig = {
  images: {
    remotePatterns: [
      {
        protocol: 'https',
        hostname: 'images.unsplash.com',
      },
      {
        protocol: 'https',
        hostname: 'source.unsplash.com',
      },
    ],
  },
  // Disable compression for streaming API routes to prevent buffering
  compress: false,
}

export default nextConfig
</file>

<file path="src/app/api/plans/route.ts">
import { NextRequest } from 'next/server'
import { OptimizedPlanSchema, type OptimizedPlan } from '@/types/plan'
import { planRepository } from '@/lib/repositories/plan-repository'
import { debugLog } from '@/lib/debug'

export const runtime = 'nodejs'

/**
 * POST /api/plans
 * Saves a generated OptimizedPlan (V3) to the repository
 *
 * This endpoint is called by the client after successfully receiving
 * an OptimizedPlan from the streaming API to ensure data persistence.
 *
 * @param request - Next.js request object containing the OptimizedPlan data
 * @returns JSON response with the saved plan's slug
 */
export async function POST(request: NextRequest) {
  try {
    const body = await request.json()

    // Validate the OptimizedPlan (V3) data
    const optimizedPlan = OptimizedPlanSchema.parse(body)

    // Save the OptimizedPlan to Redis (V3 namespace)
    const slug = await planRepository.saveV3(optimizedPlan as OptimizedPlan)

    debugLog('[DEBUG] OptimizedPlan saved successfully:', slug)

    return new Response(
      JSON.stringify({
        success: true,
        slug,
      }),
      {
        status: 200,
        headers: { 'Content-Type': 'application/json' },
      }
    )
  } catch (error) {
    console.error('Error saving OptimizedPlan:', error)

    return new Response(
      JSON.stringify({
        success: false,
        error: 'Failed to save OptimizedPlan',
        details: error instanceof Error ? error.message : 'Unknown error',
      }),
      {
        status: 500,
        headers: { 'Content-Type': 'application/json' },
      }
    )
  }
}
</file>

<file path="src/app/plans/page.tsx">
import Link from 'next/link'
import {
  planRepository,
  type PlanMetadata,
} from '@/lib/repositories/plan-repository'
import {
  ChevronLeft,
  ChevronRight,
  FolderOpen,
  Home,
  MapPin,
  Calendar,
} from 'lucide-react'

const PLANS_PER_PAGE = 20

interface PlansPageProps {
  searchParams: Promise<{ page?: string }>
}

export default async function PlansPage({ searchParams }: PlansPageProps) {
  const params = await searchParams
  const currentPage = Math.max(1, Number(params.page) || 1)
  const offset = (currentPage - 1) * PLANS_PER_PAGE

  const [plans, totalCount] = await Promise.all([
    planRepository.getRecentPlansV3(PLANS_PER_PAGE, offset),
    planRepository.getTotalCountV3(),
  ])

  const totalPages = Math.ceil(totalCount / PLANS_PER_PAGE)
  const hasPrevious = currentPage > 1
  const hasNext = currentPage < totalPages

  return (
    <div className="min-h-screen bg-gray-50 p-4 sm:p-6">
      <div className="container mx-auto max-w-4xl">
        {/* Header */}
        <div className="bg-white rounded-xl p-6 shadow-sm mb-6">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <FolderOpen className="w-6 h-6 text-blue-600" />
              <div>
                <h1 className="text-xl font-bold text-gray-900">
                  ãƒ—ãƒ©ãƒ³ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
                </h1>
                <p className="text-sm text-gray-500">
                  {totalCount}ä»¶ã®ãƒ—ãƒ©ãƒ³ | ãƒšãƒ¼ã‚¸ {currentPage}/
                  {totalPages || 1}
                </p>
              </div>
            </div>
            <Link href="/">
              <button className="flex items-center gap-2 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                <Home className="w-4 h-4" />
                ãƒ›ãƒ¼ãƒ 
              </button>
            </Link>
          </div>
        </div>

        {plans.length === 0 ? (
          <div className="bg-white rounded-xl p-12 shadow-sm text-center">
            <p className="text-gray-600 mb-2">ä¿å­˜ã•ã‚ŒãŸãƒ—ãƒ©ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“</p>
            <Link
              href="/"
              className="text-blue-600 hover:underline text-sm font-medium"
            >
              æ–°ã—ã„ãƒ—ãƒ©ãƒ³ã‚’ä½œæˆã™ã‚‹
            </Link>
          </div>
        ) : (
          <>
            {/* Plan List */}
            <div className="space-y-3 mb-6">
              {plans.map(plan => (
                <PlanArchiveEntry key={plan.id} plan={plan} />
              ))}
            </div>

            {/* Pagination Controls */}
            {totalPages > 1 && (
              <div className="bg-white rounded-xl p-4 shadow-sm">
                <div className="flex justify-center items-center gap-4">
                  <Link
                    href={`/plans?page=${currentPage - 1}`}
                    className={
                      !hasPrevious ? 'pointer-events-none opacity-30' : ''
                    }
                  >
                    <button
                      className="flex items-center gap-1 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors text-sm"
                      disabled={!hasPrevious}
                    >
                      <ChevronLeft className="h-4 w-4" />
                      å‰ã¸
                    </button>
                  </Link>

                  <span className="text-sm text-gray-600">
                    {currentPage} / {totalPages}
                  </span>

                  <Link
                    href={`/plans?page=${currentPage + 1}`}
                    className={!hasNext ? 'pointer-events-none opacity-30' : ''}
                  >
                    <button
                      className="flex items-center gap-1 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors text-sm"
                      disabled={!hasNext}
                    >
                      æ¬¡ã¸
                      <ChevronRight className="h-4 w-4" />
                    </button>
                  </Link>
                </div>
              </div>
            )}
          </>
        )}
      </div>
    </div>
  )
}

function PlanArchiveEntry({ plan }: { plan: PlanMetadata }) {
  const formatDate = (timestamp: number) => {
    const d = new Date(timestamp)
    return d.toLocaleDateString('ja-JP', {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
    })
  }

  return (
    <Link href={`/plans/${plan.id}`}>
      <div className="bg-white rounded-xl p-4 shadow-sm border border-gray-100 hover:shadow-md hover:border-gray-200 transition-all cursor-pointer group">
        <div className="flex items-center gap-4">
          <div className="flex-1 min-w-0">
            <h3 className="font-medium text-gray-900 truncate">{plan.title}</h3>
            <div className="flex items-center gap-4 mt-1 text-sm text-gray-500">
              <span className="flex items-center gap-1">
                <MapPin className="w-3.5 h-3.5" />
                {plan.destination}
              </span>
              <span className="flex items-center gap-1">
                <Calendar className="w-3.5 h-3.5" />
                {plan.days}æ—¥é–“
              </span>
            </div>
          </div>
          <div className="flex items-center gap-3 shrink-0">
            <span className="text-sm text-gray-400">
              {formatDate(plan.createdAt)}
            </span>
            <ChevronRight className="w-5 h-5 text-gray-400 group-hover:text-blue-500 group-hover:translate-x-1 transition-all" />
          </div>
        </div>
      </div>
    </Link>
  )
}
</file>

<file path="src/app/globals.css">
@import 'tailwindcss';
@import 'tw-animate-css';

@custom-variant dark (&:is(.dark *));

@theme inline {
  --color-background: var(--background);
  --color-foreground: var(--foreground);
  --font-sans: var(--font-noto-sans-jp);
  --font-mono: var(--font-geist-mono);
  --color-sidebar-ring: var(--sidebar-ring);
  --color-sidebar-border: var(--sidebar-border);
  --color-sidebar-accent-foreground: var(--sidebar-accent-foreground);
  --color-sidebar-accent: var(--sidebar-accent);
  --color-sidebar-primary-foreground: var(--sidebar-primary-foreground);
  --color-sidebar-primary: var(--sidebar-primary);
  --color-sidebar-foreground: var(--sidebar-foreground);
  --color-sidebar: var(--sidebar);
  --color-chart-5: var(--chart-5);
  --color-chart-4: var(--chart-4);
  --color-chart-3: var(--chart-3);
  --color-chart-2: var(--chart-2);
  --color-chart-1: var(--chart-1);
  --color-ring: var(--ring);
  --color-input: var(--input);
  --color-border: var(--border);
  --color-destructive: var(--destructive);
  --color-accent-foreground: var(--accent-foreground);
  --color-accent: var(--accent);
  --color-muted-foreground: var(--muted-foreground);
  --color-muted: var(--muted);
  --color-secondary-foreground: var(--secondary-foreground);
  --color-secondary: var(--secondary);
  --color-primary-foreground: var(--primary-foreground);
  --color-primary: var(--primary);
  --color-popover-foreground: var(--popover-foreground);
  --color-popover: var(--popover);
  --color-card-foreground: var(--card-foreground);
  --color-card: var(--card);
  --radius-sm: calc(var(--radius) - 4px);
  --radius-md: calc(var(--radius) - 2px);
  --radius-lg: var(--radius);
  --radius-xl: calc(var(--radius) + 4px);
  --radius-2xl: calc(var(--radius) + 8px);
  --radius-3xl: calc(var(--radius) + 12px);
  --radius-4xl: calc(var(--radius) + 16px);
}

:root {
  --radius: 0.625rem;
  --background: oklch(1 0 0);
  --foreground: oklch(0.145 0 0);
  --card: oklch(1 0 0);
  --card-foreground: oklch(0.145 0 0);
  --popover: oklch(1 0 0);
  --popover-foreground: oklch(0.145 0 0);
  --primary: oklch(0.205 0 0);
  --primary-foreground: oklch(0.985 0 0);
  --secondary: oklch(0.97 0 0);
  --secondary-foreground: oklch(0.205 0 0);
  --muted: oklch(0.97 0 0);
  --muted-foreground: oklch(0.556 0 0);
  --accent: oklch(0.97 0 0);
  --accent-foreground: oklch(0.205 0 0);
  --destructive: oklch(0.577 0.245 27.325);
  --border: oklch(0.922 0 0);
  --input: oklch(0.922 0 0);
  --ring: oklch(0.708 0 0);
  --chart-1: oklch(0.646 0.222 41.116);
  --chart-2: oklch(0.6 0.118 184.704);
  --chart-3: oklch(0.398 0.07 227.392);
  --chart-4: oklch(0.828 0.189 84.429);
  --chart-5: oklch(0.769 0.188 70.08);
  --sidebar: oklch(0.985 0 0);
  --sidebar-foreground: oklch(0.145 0 0);
  --sidebar-primary: oklch(0.205 0 0);
  --sidebar-primary-foreground: oklch(0.985 0 0);
  --sidebar-accent: oklch(0.97 0 0);
  --sidebar-accent-foreground: oklch(0.205 0 0);
  --sidebar-border: oklch(0.922 0 0);
  --sidebar-ring: oklch(0.708 0 0);
}

.dark {
  --background: oklch(0.145 0 0);
  --foreground: oklch(0.985 0 0);
  --card: oklch(0.205 0 0);
  --card-foreground: oklch(0.985 0 0);
  --popover: oklch(0.205 0 0);
  --popover-foreground: oklch(0.985 0 0);
  --primary: oklch(0.922 0 0);
  --primary-foreground: oklch(0.205 0 0);
  --secondary: oklch(0.269 0 0);
  --secondary-foreground: oklch(0.985 0 0);
  --muted: oklch(0.269 0 0);
  --muted-foreground: oklch(0.708 0 0);
  --accent: oklch(0.269 0 0);
  --accent-foreground: oklch(0.985 0 0);
  --destructive: oklch(0.704 0.191 22.216);
  --border: oklch(1 0 0 / 10%);
  --input: oklch(1 0 0 / 15%);
  --ring: oklch(0.556 0 0);
  --chart-1: oklch(0.488 0.243 264.376);
  --chart-2: oklch(0.696 0.17 162.48);
  --chart-3: oklch(0.769 0.188 70.08);
  --chart-4: oklch(0.627 0.265 303.9);
  --chart-5: oklch(0.645 0.246 16.439);
  --sidebar: oklch(0.205 0 0);
  --sidebar-foreground: oklch(0.985 0 0);
  --sidebar-primary: oklch(0.488 0.243 264.376);
  --sidebar-primary-foreground: oklch(0.985 0 0);
  --sidebar-accent: oklch(0.269 0 0);
  --sidebar-accent-foreground: oklch(0.985 0 0);
  --sidebar-border: oklch(1 0 0 / 10%);
  --sidebar-ring: oklch(0.556 0 0);
}

@layer base {
  * {
    @apply border-border outline-ring/50;
  }
  body {
    @apply bg-background text-foreground;
  }
}

/* ============================================
   V3 Minimal White Theme
   ============================================ */
@layer components {
  /* Card styles */
  .v3-card {
    @apply bg-white rounded-xl shadow-sm border border-gray-100;
  }

  /* Input styles */
  .v3-input {
    @apply w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent placeholder:text-gray-400 transition-all;
  }

  /* Button styles */
  .v3-button-primary {
    @apply px-6 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors;
  }

  .v3-button-secondary {
    @apply px-6 py-3 bg-gray-100 text-gray-700 font-medium rounded-lg hover:bg-gray-200 transition-colors;
  }

  .v3-button-outline {
    @apply px-6 py-3 border-2 border-gray-200 text-gray-600 font-medium rounded-lg hover:border-gray-300 hover:bg-gray-50 transition-colors;
  }

  /* Timeline styles */
  .v3-timeline-line {
    @apply border-l-2 border-blue-200;
  }

  .v3-timeline-dot {
    @apply w-4 h-4 bg-blue-500 rounded-full border-4 border-white shadow-sm;
  }

  .v3-timeline-dot-food {
    @apply w-4 h-4 bg-orange-500 rounded-full border-4 border-white shadow-sm;
  }

  .v3-timeline-dot-move {
    @apply w-4 h-4 bg-gray-400 rounded-full border-4 border-white shadow-sm;
  }

  /* Badge styles */
  .v3-badge {
    @apply inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs font-medium;
  }

  .v3-badge-spot {
    @apply bg-blue-100 text-blue-700;
  }

  .v3-badge-food {
    @apply bg-orange-100 text-orange-700;
  }

  .v3-badge-move {
    @apply bg-gray-100 text-gray-600;
  }

  /* Text styles */
  .v3-heading {
    @apply text-2xl font-bold text-gray-900;
  }

  .v3-subheading {
    @apply text-lg font-semibold text-gray-900;
  }

  .v3-body {
    @apply text-gray-600 leading-relaxed;
  }

  .v3-caption {
    @apply text-sm text-gray-500;
  }
}
</file>

<file path="src/app/sitemap.ts">
import { MetadataRoute } from 'next'
import { planRepository } from '@/lib/repositories/plan-repository'

// Force dynamic rendering because planRepository fetches from Upstash with no-store
export const dynamic = 'force-dynamic'

/**
 * Generates sitemap.xml dynamically
 * Includes static pages and all dynamic plan pages from Redis
 */
export default async function sitemap(): Promise<MetadataRoute.Sitemap> {
  const baseUrl = 'https://www.trip-plan-architect.com'

  // Static pages
  const staticPages: MetadataRoute.Sitemap = [
    {
      url: baseUrl,
      lastModified: new Date(),
      changeFrequency: 'daily',
      priority: 1,
    },
    {
      url: `${baseUrl}/terms`,
      lastModified: new Date(),
      changeFrequency: 'monthly',
      priority: 0.5,
    },
    {
      url: `${baseUrl}/privacy`,
      lastModified: new Date(),
      changeFrequency: 'monthly',
      priority: 0.5,
    },
  ]

  // Dynamic plan pages from Redis (V3 namespace)
  try {
    const planSlugs = await planRepository.listV3()

    const planPages: MetadataRoute.Sitemap = planSlugs.map(slug => {
      // Extract timestamp from slug (format: "title-timestamp")
      const timestampStr = slug.split('-').pop()
      const timestamp = timestampStr ? Number(timestampStr) : Date.now()
      const lastModified = new Date(timestamp)

      return {
        url: `${baseUrl}/plans/${slug}`,
        lastModified,
        changeFrequency: 'weekly' as const,
        priority: 0.8,
      }
    })

    return [...staticPages, ...planPages]
  } catch (error) {
    console.error('Error generating sitemap:', error)
    // Return only static pages if Redis fails
    return staticPages
  }
}
</file>

<file path="src/components/recent-plans.tsx">
import Link from 'next/link'
import {
  planRepository,
  type PlanMetadata,
} from '@/lib/repositories/plan-repository'
import { ChevronRight, Calendar, MapPin } from 'lucide-react'

interface RecentPlansProps {
  limit?: number
}

export async function RecentPlans({ limit = 20 }: RecentPlansProps) {
  const plans = await planRepository.getRecentPlansV3(limit)

  return (
    <section className="mt-12">
      <div className="mb-6">
        <h2 className="text-xl font-bold text-gray-900">æœ€è¿‘ã®ãƒ—ãƒ©ãƒ³</h2>
        <p className="text-sm text-gray-500 mt-1">éå»ã«ä½œæˆã—ãŸæ—…è¡Œãƒ—ãƒ©ãƒ³</p>
      </div>
      {plans.length === 0 ? (
        <div className="bg-gray-50 rounded-xl p-8 text-center">
          <p className="text-gray-600 mb-2">ã¾ã ãƒ—ãƒ©ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“</p>
          <p className="text-sm text-gray-500">
            ä¸Šã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰æœ€åˆã®ãƒ—ãƒ©ãƒ³ã‚’ä½œæˆã—ã¾ã—ã‚‡ã†
          </p>
        </div>
      ) : (
        <div className="space-y-3">
          {plans.map(plan => (
            <PlanListItem key={plan.id} plan={plan} />
          ))}
        </div>
      )}
    </section>
  )
}

function PlanListItem({ plan }: { plan: PlanMetadata }) {
  const formatDate = (timestamp: number) => {
    const d = new Date(timestamp)
    return d.toLocaleDateString('ja-JP', {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
    })
  }

  return (
    <Link href={`/plans/${plan.id}`}>
      <div className="bg-white rounded-xl p-4 shadow-sm border border-gray-100 hover:shadow-md hover:border-gray-200 transition-all cursor-pointer group">
        <div className="flex items-center gap-4">
          <div className="flex-1 min-w-0">
            <h3 className="font-medium text-gray-900 truncate">{plan.title}</h3>
            <div className="flex items-center gap-4 mt-1 text-sm text-gray-500">
              <span className="flex items-center gap-1">
                <MapPin className="w-3.5 h-3.5" />
                {plan.destination}
              </span>
              <span className="flex items-center gap-1">
                <Calendar className="w-3.5 h-3.5" />
                {plan.days}æ—¥é–“
              </span>
            </div>
          </div>
          <div className="flex items-center gap-3 shrink-0">
            <span className="text-sm text-gray-400">
              {formatDate(plan.createdAt)}
            </span>
            <ChevronRight className="w-5 h-5 text-gray-400 group-hover:text-blue-500 group-hover:translate-x-1 transition-all" />
          </div>
        </div>
      </div>
    </Link>
  )
}
</file>

<file path="vercel.json">
{
  "functions": {
    "src/app/api/generate/route.ts": {
      "maxDuration": 60
    }
  },
  "headers": [
    {
      "source": "/api/generate",
      "headers": [
        {
          "key": "Content-Type",
          "value": "text/event-stream"
        },
        {
          "key": "Cache-Control",
          "value": "no-cache, no-transform"
        },
        {
          "key": "X-Content-Type-Options",
          "value": "nosniff"
        },
        {
          "key": "X-Accel-Buffering",
          "value": "no"
        }
      ]
    }
  ]
}
</file>

<file path="src/app/page.tsx">
import Link from 'next/link'
import { TripGenerator } from '@/components/trip-generator'
import { RecentPlans } from '@/components/recent-plans'
import { Button } from '@/components/ui/button'
import { ArrowRight } from 'lucide-react'

// Force dynamic rendering because RecentPlans fetches from Upstash with no-store
export const dynamic = 'force-dynamic'

export default function Home() {
  return (
    <div className="min-h-screen bg-gradient-to-b from-blue-50 to-white dark:from-gray-900 dark:to-gray-800">
      <div className="container mx-auto px-4 py-8 max-w-4xl">
        <header className="text-center mb-8">
          <h1 className="text-4xl font-bold text-gray-900 dark:text-white mb-2 notranslate">
            âœˆï¸ Trip Plan Architect
          </h1>
          <p className="text-gray-600 dark:text-gray-400">
            ä¼‘æ—¥ã‚’ã€ãƒ­ã‚¸ã‚«ãƒ«ã«æœ€é©åŒ–ã™ã‚‹ã€‚
          </p>
        </header>

        <TripGenerator />

        <RecentPlans limit={6} />

        <div className="text-center mt-8">
          <Link href="/plans">
            <Button variant="outline" size="lg" className="gap-2">
              å…¨ã¦ã®ãƒ—ãƒ©ãƒ³ã‚’è¦‹ã‚‹
              <ArrowRight className="h-4 w-4" />
            </Button>
          </Link>
        </div>
      </div>
    </div>
  )
}
</file>

<file path="src/env.ts">
import { z } from 'zod'

/**
 * Environment variables schema with validation and type safety
 */
const envSchema = z.object({
  // Unsplash Configuration (server-side only, optional)
  UNSPLASH_ACCESS_KEY: z.string().optional(),

  // LLM Model Configuration (optional, with defaults)
  // Using gpt-4o-mini for faster generation speed (2x faster than gpt-4o)
  OPENAI_MODEL: z.string().default('gpt-4o-mini'),
  // Using gemini-2.5-flash for stable, fast, and long-term supported model
  GEMINI_MODEL: z.string().default('gemini-2.5-flash'),

  // Rate Limit Configuration (coerce string to number, with defaults)
  // Global rate limit: Total requests allowed across all users per day
  GLOBAL_RATE_LIMIT_REQUESTS: z.coerce.number().default(100),
  // IP rate limit: Requests allowed per IP address per day
  IP_RATE_LIMIT_REQUESTS: z.coerce.number().default(5),

  // Debug Mode (transform string "true" to boolean, optional)
  NEXT_PUBLIC_IS_DEBUG: z
    .string()
    .transform(s => s === 'true')
    .optional(),

  // System environment variables
  NODE_ENV: z
    .enum(['development', 'production', 'test'])
    .default('development'),
})

/**
 * Parse and validate environment variables
 * Safely handles both server and client environments
 */
function parseEnv() {
  // In browser environment, only NEXT_PUBLIC_* variables are available
  // Use globalThis to safely check for window in both Node.js and browser
  const isBrowser =
    typeof globalThis !== 'undefined' &&
    'window' in globalThis &&
    (globalThis as { window?: unknown }).window !== undefined

  if (isBrowser) {
    const clientEnv = {
      NEXT_PUBLIC_IS_DEBUG: process.env.NEXT_PUBLIC_IS_DEBUG,
      NODE_ENV: process.env.NODE_ENV || 'development',
    }
    const parsed = envSchema.safeParse(clientEnv)
    return parsed.success ? parsed.data : ({} as z.infer<typeof envSchema>)
  }

  // Server-side: full validation
  const parsed = envSchema.safeParse(process.env)

  if (!parsed.success) {
    console.error('âŒ Invalid environment variables:')
    console.error(parsed.error.flatten().fieldErrors)
    throw new Error(
      'Environment validation failed. Check your .env file and ensure all required variables are set.'
    )
  }

  return parsed.data
}

/**
 * Validated and type-safe environment variables
 * Import this object instead of using process.env directly
 */
export const env = parseEnv()

/**
 * Log configuration on startup (server-side only, development mode only)
 */
// Use globalThis to safely check for window in both Node.js and browser
const isServer =
  typeof globalThis === 'undefined' ||
  !('window' in globalThis) ||
  (globalThis as { window?: unknown }).window === undefined

if (
  isServer &&
  (process.env.NODE_ENV === 'development' ||
    process.env.NEXT_PUBLIC_IS_DEBUG === 'true')
) {
  console.log('\n[Config] âœ… Loaded Configuration:')
  console.log(`  - Environment: ${env.NODE_ENV}`)
  console.log(
    `  - Global Rate Limit: ${env.GLOBAL_RATE_LIMIT_REQUESTS} requests/day`
  )
  console.log(`  - IP Rate Limit: ${env.IP_RATE_LIMIT_REQUESTS} requests/day`)
  console.log(`  - Debug Mode: ${env.NEXT_PUBLIC_IS_DEBUG || false}`)
  console.log(
    `  - Unsplash API Key: ${env.UNSPLASH_ACCESS_KEY ? `Set (${env.UNSPLASH_ACCESS_KEY.substring(0, 4)}***)` : 'NOT SET'}`
  )
  console.log('')
}
</file>

<file path="src/app/plans/[slug]/page.tsx">
import { Metadata } from 'next'
import { notFound } from 'next/navigation'
import { PlanRepository } from '@/lib/repositories/plan-repository'
import { OptimizedPlanView } from '@/components/optimized-plan-view'
import type { OptimizedPlan } from '@/types/plan'

interface PageProps {
  params: Promise<{
    slug: string
  }>
}

// Type guard to check if data is OptimizedPlan (V3)
function isOptimizedPlan(data: unknown): data is OptimizedPlan {
  return (
    typeof data === 'object' &&
    data !== null &&
    'itinerary' in data &&
    Array.isArray((data as OptimizedPlan).itinerary)
  )
}

// Force dynamic rendering since we use Redis (not compatible with static generation)
export const dynamic = 'force-dynamic'

// Disable static params generation for Redis-backed routes
// All plan pages are generated on-demand at runtime
export const dynamicParams = true

// Generate metadata for SEO
export async function generateMetadata({
  params,
}: PageProps): Promise<Metadata> {
  const { slug } = await params
  const repository = new PlanRepository()
  const data = await repository.getV3(slug)

  if (!data) {
    return {
      title: 'ãƒ—ãƒ©ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“',
    }
  }

  const description =
    data.intro ||
    `${data.itinerary.length}æ—¥é–“ã®${data.title}ã€‚åŠ¹ç‡çš„ãªä¸€äººæ—…ã®ãƒ—ãƒ©ãƒ³ã§ã™ã€‚`

  return {
    title: data.title,
    description,
    openGraph: {
      title: data.title,
      description,
      type: 'article',
      images: [
        {
          url: `/api/og?title=${encodeURIComponent(data.title)}&days=${data.itinerary.length}`,
          width: 1200,
          height: 630,
          alt: data.title,
        },
      ],
    },
    twitter: {
      card: 'summary_large_image',
      title: data.title,
      description,
      images: [
        `/api/og?title=${encodeURIComponent(data.title)}&days=${data.itinerary.length}`,
      ],
    },
  }
}

export default async function PlanPage({ params }: PageProps) {
  const { slug } = await params
  const repository = new PlanRepository()
  const data = await repository.getV3(slug)

  if (!data || !isOptimizedPlan(data)) {
    notFound()
  }

  return <OptimizedPlanView plan={data} />
}
</file>

<file path="src/lib/repositories/plan-repository.ts">
import { Redis } from '@upstash/redis'
import type { Plan, ScouterResponse, OptimizedPlan } from '@/types/plan'
import { debugLog } from '@/lib/debug'

/**
 * Redis key patterns for V2 (namespace-isolated from V1)
 * V1 uses: plan:slugs, plan:meta:{id}, plan:{id}
 * V2 uses: v2:mission:slugs, v2:mission:meta:{id}, v2:mission:data:{id}
 */
export const REDIS_KEYS_V2 = {
  /** Sorted set of all mission IDs (score = timestamp) */
  SLUGS: 'v2:mission:slugs',
  /** Metadata key pattern (replace {id} with actual ID) */
  META: (id: string) => `v2:mission:meta:${id}`,
  /** Full mission data key pattern (replace {id} with actual ID) */
  DATA: (id: string) => `v2:mission:data:${id}`,
} as const

/**
 * Redis key patterns for V3 (Optimized Solo Travel)
 * Completely isolated from V1 and V2 namespaces
 */
export const REDIS_KEYS_V3 = {
  /** Sorted set of all optimized plan IDs (score = timestamp) */
  SLUGS: 'v3:optimal:slugs',
  /** Metadata key pattern (replace {id} with actual ID) */
  META: (id: string) => `v3:optimal:meta:${id}`,
  /** Full plan data key pattern (replace {id} with actual ID) */
  DATA: (id: string) => `v3:optimal:data:${id}`,
} as const

/**
 * Plan metadata for listing pages
 */
export interface PlanMetadata {
  id: string
  title: string
  destination: string
  days: number
  target: 'engineer' | 'general'
  createdAt: number
  version?: 'v2' | 'v3'
}

/**
 * Interface for Plan repository operations
 * Now supports V1 (Plan), V2 (ScouterResponse), and V3 (OptimizedPlan) data
 */
export interface IPlanRepository {
  save(data: Plan | ScouterResponse): Promise<string>
  get(slug: string): Promise<Plan | ScouterResponse | null>
  list(): Promise<string[]>
  getRecent(limit?: number): Promise<string[]>
  getRecentPlans(limit?: number, offset?: number): Promise<PlanMetadata[]>
  getTotalCount(): Promise<number>
  // V3 methods
  saveV3(data: OptimizedPlan): Promise<string>
  getV3(slug: string): Promise<OptimizedPlan | null>
  listV3(): Promise<string[]>
  getRecentPlansV3(limit?: number, offset?: number): Promise<PlanMetadata[]>
  getTotalCountV3(): Promise<number>
}

/**
 * Redis-based implementation of Plan repository
 * Stores plans in Upstash Redis for serverless compatibility
 */
export class PlanRepository implements IPlanRepository {
  private readonly redis: Redis | null

  /**
   * @param redis - Optional Redis instance (for testing/dependency injection)
   */
  constructor(redis?: Redis) {
    // Use provided redis or create from environment variables
    if (redis) {
      this.redis = redis
    } else if (
      process.env.UPSTASH_REDIS_REST_URL &&
      process.env.UPSTASH_REDIS_REST_TOKEN
    ) {
      this.redis = Redis.fromEnv()
    } else {
      // Fallback for local development without Redis
      this.redis = null
    }
  }

  /**
   * Generates a URL-friendly slug from a plan title
   * Supports Japanese and other Unicode characters
   * @returns A slugified version of the title (timestamp-based)
   * @private
   */
  private generateSlug(): string {
    // Use timestamp-only slug for simplicity and reliability
    // This avoids issues with Japanese characters, Unicode normalization, etc.
    return `plan-${Date.now()}`
  }

  /**
   * Checks if data is ScouterResponse (V2) format
   * @private
   */
  private isScouterResponse(
    data: Plan | ScouterResponse
  ): data is ScouterResponse {
    return 'mission_title' in data && 'target_spot' in data && 'quests' in data
  }

  /**
   * Saves a plan or ScouterResponse to Redis (V2 namespace)
   * @param data - The Plan (V1) or ScouterResponse (V2) to save
   * @returns The slug of the saved data
   */
  async save(data: Plan | ScouterResponse): Promise<string> {
    const fullSlug = this.generateSlug()
    const timestamp = Date.now()

    if (!this.redis) {
      // For local development without Redis, just return the slug
      debugLog('Redis not configured, data not saved:', fullSlug)
      return fullSlug
    }

    // Prepare metadata for fast listing (only essential fields)
    let metadata: PlanMetadata

    if (this.isScouterResponse(data)) {
      // V2: ScouterResponse format
      metadata = {
        id: fullSlug,
        title: data.mission_title,
        destination: data.target_spot.n,
        days: 1, // V2 has no multi-day concept, using 1 as default
        target: 'engineer', // V2 is always engineer-focused
        createdAt: timestamp,
      }
    } else {
      // V1: Plan format (legacy)
      metadata = {
        id: fullSlug,
        title: data.title,
        destination: data.title.split(' ')[0] || 'Travel',
        days: data.days.length,
        target: data.target,
        createdAt: timestamp,
      }
    }

    // Use pipeline to save everything atomically (V2 namespace)
    const pipeline = this.redis.pipeline()

    // Save full data (for detail page) - V2 key pattern
    pipeline.set(REDIS_KEYS_V2.DATA(fullSlug), JSON.stringify(data))

    // Save lightweight metadata (for listing pages) - V2 key pattern
    pipeline.set(REDIS_KEYS_V2.META(fullSlug), JSON.stringify(metadata))

    // Add to sorted set for chronological ordering - V2 key pattern
    pipeline.zadd(REDIS_KEYS_V2.SLUGS, { score: timestamp, member: fullSlug })

    await pipeline.exec()

    return fullSlug
  }

  /**
   * Retrieves a plan or ScouterResponse by its slug (V2 namespace only)
   * @param slug - The slug of the plan
   * @returns The plan/ScouterResponse if found, null otherwise
   */
  async get(slug: string): Promise<Plan | ScouterResponse | null> {
    if (!this.redis) {
      return null
    }

    try {
      // V2 key pattern - will NOT read V1 data
      const data = await this.redis.get(REDIS_KEYS_V2.DATA(slug))
      if (!data) return null

      // Upstash Redis SDK may auto-parse JSON, so check the type
      if (typeof data === 'object' && data !== null) {
        // Already parsed as object
        return data as Plan | ScouterResponse
      }

      if (typeof data === 'string') {
        // Still a string, parse it
        return JSON.parse(data) as Plan | ScouterResponse
      }

      debugLog('Unexpected data type from Redis:', typeof data)
      return null
    } catch (error) {
      debugLog('Error retrieving plan:', error)
      return null
    }
  }

  /**
   * Lists all available plan slugs (V2 namespace only)
   * @returns Array of plan slugs (newest first)
   */
  async list(): Promise<string[]> {
    if (!this.redis) {
      return []
    }

    try {
      // Get all slugs from V2 sorted set, newest first
      const slugs = await this.redis.zrange<string[]>(
        REDIS_KEYS_V2.SLUGS,
        0,
        -1,
        {
          rev: true,
        }
      )
      return slugs
    } catch (error) {
      debugLog('Error listing plans:', error)
      return []
    }
  }

  /**
   * Gets recent plan slugs (V2 namespace only)
   * @param limit - Maximum number of slugs to return (default: 10)
   * @returns Array of recent plan slugs (newest first)
   */
  async getRecent(limit: number = 10): Promise<string[]> {
    if (!this.redis) {
      return []
    }

    try {
      // Get most recent slugs from V2 sorted set
      const slugs = await this.redis.zrange<string[]>(
        REDIS_KEYS_V2.SLUGS,
        0,
        limit - 1,
        {
          rev: true,
        }
      )
      return slugs
    } catch (error) {
      debugLog('Error getting recent plans:', error)
      return []
    }
  }

  /**
   * Gets recent plans with metadata (V2 namespace only)
   * @param limit - Maximum number of plans to return (default: 20, max: 100)
   * @param offset - Number of plans to skip (default: 0)
   * @returns Array of plan metadata (newest first)
   */
  async getRecentPlans(
    limit: number = 20,
    offset: number = 0
  ): Promise<PlanMetadata[]> {
    if (!this.redis) {
      return []
    }

    try {
      console.time('[PERF] getRecentPlans:total')

      // Limit to 100 to prevent performance issues
      const actualLimit = Math.min(limit, 100)

      // Calculate Redis range: offset to (offset + limit - 1)
      const start = offset
      const end = offset + actualLimit - 1

      console.time('[PERF] getRecentPlans:zrange')
      // Get recent slugs from V2 namespace (DB-level pagination)
      const slugs = await this.redis.zrange<string[]>(
        REDIS_KEYS_V2.SLUGS,
        start,
        end,
        {
          rev: true,
        }
      )
      console.timeEnd('[PERF] getRecentPlans:zrange')

      if (slugs.length === 0) {
        console.timeEnd('[PERF] getRecentPlans:total')
        return []
      }

      console.time('[PERF] getRecentPlans:pipeline')
      // Use pipeline to fetch lightweight metadata (not full plans) - V2 keys
      const pipeline = this.redis.pipeline()
      slugs.forEach(slug => {
        pipeline.get(REDIS_KEYS_V2.META(slug))
      })

      const metadataResults = await pipeline.exec<(PlanMetadata | null)[]>()
      console.timeEnd('[PERF] getRecentPlans:pipeline')

      console.time('[PERF] getRecentPlans:parse')
      // Collect slugs that need fallback (missing metadata)
      const metadata: PlanMetadata[] = []
      const slugsNeedingFallback: string[] = []

      for (let i = 0; i < metadataResults.length; i++) {
        const meta = metadataResults[i]
        const slug = slugs[i]

        if (meta && typeof meta === 'object') {
          // Upstash already parsed JSON
          metadata.push(meta as PlanMetadata)
        } else if (typeof meta === 'string') {
          // Fallback: manual parse
          try {
            metadata.push(JSON.parse(meta) as PlanMetadata)
          } catch {
            debugLog('Failed to parse metadata for slug:', slug)
            slugsNeedingFallback.push(slug)
          }
        } else {
          // No metadata key exists - need to fetch full plan (legacy data)
          slugsNeedingFallback.push(slug)
        }
      }
      console.timeEnd('[PERF] getRecentPlans:parse')

      // Fallback: fetch full plans for legacy data without metadata (V2 keys)
      if (slugsNeedingFallback.length > 0) {
        console.time('[PERF] getRecentPlans:fallback')
        const fallbackPipeline = this.redis.pipeline()
        slugsNeedingFallback.forEach(slug => {
          fallbackPipeline.get(REDIS_KEYS_V2.DATA(slug))
        })

        const planResults = await fallbackPipeline.exec<(Plan | null)[]>()

        for (let i = 0; i < planResults.length; i++) {
          const plan = planResults[i]
          const slug = slugsNeedingFallback[i]

          if (plan && typeof plan === 'object') {
            // Extract metadata from full plan
            const destination = plan.title?.split(' ')[0] || 'Travel'
            const timestamp = Number(slug.split('-').pop()) || Date.now()

            metadata.push({
              id: slug,
              title: plan.title || '',
              destination,
              days: Array.isArray(plan.days) ? plan.days.length : 0,
              target: plan.target || 'general',
              createdAt: timestamp,
            })
          }
        }
        console.timeEnd('[PERF] getRecentPlans:fallback')
      }

      console.timeEnd('[PERF] getRecentPlans:total')
      console.log(
        `[PERF] Fetched ${metadata.length} plans (requested: ${slugs.length}, fallback: ${slugsNeedingFallback.length})`
      )

      // Sort by createdAt descending to maintain order
      return metadata.sort((a, b) => b.createdAt - a.createdAt)
    } catch (error) {
      debugLog('Error getting recent plans metadata:', error)
      return []
    }
  }

  /**
   * Gets the total number of plans stored (V2 namespace only)
   * @returns Total count of plans
   */
  async getTotalCount(): Promise<number> {
    if (!this.redis) {
      return 0
    }

    try {
      const count = await this.redis.zcard(REDIS_KEYS_V2.SLUGS)
      return count
    } catch (error) {
      debugLog('Error getting total plan count:', error)
      return 0
    }
  }

  // ============================================
  // V3 Methods: Optimized Solo Travel
  // ============================================

  /**
   * Checks if data is OptimizedPlan (V3) format
   * @private
   */
  private isOptimizedPlan(data: unknown): data is OptimizedPlan {
    return (
      typeof data === 'object' &&
      data !== null &&
      'itinerary' in data &&
      Array.isArray((data as OptimizedPlan).itinerary)
    )
  }

  /**
   * Saves an OptimizedPlan to Redis (V3 namespace)
   * @param data - The OptimizedPlan to save
   * @returns The slug of the saved plan
   */
  async saveV3(data: OptimizedPlan): Promise<string> {
    const fullSlug = this.generateSlug()
    const timestamp = Date.now()

    if (!this.redis) {
      debugLog('Redis not configured, data not saved:', fullSlug)
      return fullSlug
    }

    // Prepare metadata for fast listing (lightweight)
    const metadata: PlanMetadata = {
      id: fullSlug,
      title: data.title,
      destination: data.title.split(' ')[0] || 'Travel',
      days: data.itinerary?.length || 1,
      target: 'general',
      createdAt: timestamp,
      version: 'v3',
    }

    // Use pipeline to save atomically (V3 namespace)
    const pipeline = this.redis.pipeline()

    // Save full data - V3 key pattern
    pipeline.set(REDIS_KEYS_V3.DATA(fullSlug), JSON.stringify(data))

    // Save lightweight metadata (for listing pages) - V3 key pattern
    pipeline.set(REDIS_KEYS_V3.META(fullSlug), JSON.stringify(metadata))

    // Add to sorted set for chronological ordering - V3 key pattern
    pipeline.zadd(REDIS_KEYS_V3.SLUGS, { score: timestamp, member: fullSlug })

    await pipeline.exec()

    return fullSlug
  }

  /**
   * Retrieves an OptimizedPlan by its slug (V3 namespace only)
   * @param slug - The slug of the plan
   * @returns The OptimizedPlan if found, null otherwise
   */
  async getV3(slug: string): Promise<OptimizedPlan | null> {
    if (!this.redis) {
      return null
    }

    try {
      const data = await this.redis.get(REDIS_KEYS_V3.DATA(slug))
      if (!data) return null

      if (typeof data === 'object' && data !== null) {
        return data as OptimizedPlan
      }

      if (typeof data === 'string') {
        return JSON.parse(data) as OptimizedPlan
      }

      debugLog('Unexpected data type from Redis:', typeof data)
      return null
    } catch (error) {
      debugLog('Error retrieving V3 plan:', error)
      return null
    }
  }

  /**
   * Lists all available V3 plan slugs
   * @returns Array of plan slugs (newest first)
   */
  async listV3(): Promise<string[]> {
    if (!this.redis) {
      return []
    }

    try {
      // Get all slugs from V3 sorted set, newest first
      const slugs = await this.redis.zrange<string[]>(
        REDIS_KEYS_V3.SLUGS,
        0,
        -1,
        {
          rev: true,
        }
      )
      return slugs
    } catch (error) {
      debugLog('Error listing V3 plans:', error)
      return []
    }
  }

  /**
   * Gets recent V3 plans with metadata
   * @param limit - Maximum number of plans to return (default: 20, max: 100)
   * @param offset - Number of plans to skip (default: 0)
   * @returns Array of plan metadata (newest first)
   */
  async getRecentPlansV3(
    limit: number = 20,
    offset: number = 0
  ): Promise<PlanMetadata[]> {
    if (!this.redis) {
      return []
    }

    try {
      const actualLimit = Math.min(limit, 100)
      const start = offset
      const end = offset + actualLimit - 1

      // Get recent slugs from V3 namespace
      const slugs = await this.redis.zrange<string[]>(
        REDIS_KEYS_V3.SLUGS,
        start,
        end,
        { rev: true }
      )

      if (slugs.length === 0) {
        return []
      }

      // First, try to fetch lightweight metadata
      const metaPipeline = this.redis.pipeline()
      slugs.forEach(slug => {
        metaPipeline.get(REDIS_KEYS_V3.META(slug))
      })

      const metaResults = await metaPipeline.exec<(PlanMetadata | null)[]>()

      const metadata: PlanMetadata[] = []
      const slugsNeedingFallback: string[] = []

      for (let i = 0; i < metaResults.length; i++) {
        const meta = metaResults[i]
        const slug = slugs[i]

        if (meta && typeof meta === 'object') {
          metadata.push(meta as PlanMetadata)
        } else if (typeof meta === 'string') {
          try {
            metadata.push(JSON.parse(meta) as PlanMetadata)
          } catch {
            slugsNeedingFallback.push(slug)
          }
        } else {
          // No metadata key exists - need fallback to full data
          slugsNeedingFallback.push(slug)
        }
      }

      // Fallback: fetch full data for legacy plans without metadata
      if (slugsNeedingFallback.length > 0) {
        const fallbackPipeline = this.redis.pipeline()
        slugsNeedingFallback.forEach(slug => {
          fallbackPipeline.get(REDIS_KEYS_V3.DATA(slug))
        })

        const fallbackResults =
          await fallbackPipeline.exec<(OptimizedPlan | null)[]>()

        for (let i = 0; i < fallbackResults.length; i++) {
          const plan = fallbackResults[i]
          const slug = slugsNeedingFallback[i]

          if (plan && this.isOptimizedPlan(plan)) {
            const timestamp = Number(slug.split('-').pop()) || Date.now()
            metadata.push({
              id: slug,
              title: plan.title,
              destination: plan.title.split(' ')[0] || 'Travel',
              days: plan.itinerary.length,
              target: 'general',
              createdAt: timestamp,
              version: 'v3',
            })
          }
        }
      }

      return metadata.sort((a, b) => b.createdAt - a.createdAt)
    } catch (error) {
      debugLog('Error getting recent V3 plans:', error)
      return []
    }
  }

  /**
   * Gets the total number of V3 plans stored
   * @returns Total count of V3 plans
   */
  async getTotalCountV3(): Promise<number> {
    if (!this.redis) {
      return 0
    }

    try {
      const count = await this.redis.zcard(REDIS_KEYS_V3.SLUGS)
      return count
    } catch (error) {
      debugLog('Error getting total V3 plan count:', error)
      return 0
    }
  }
}

/**
 * Default singleton instance for convenience
 */
export const planRepository = new PlanRepository()
</file>

<file path="package.json">
{
  "name": "trip-plan-architect",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint",
    "type-check": "tsc --noEmit",
    "test": "vitest run",
    "test:watch": "vitest",
    "test:e2e": "playwright test",
    "format": "prettier --write .",
    "format:check": "prettier --check .",
    "generate:daily": "ts-node scripts/generate-daily.ts",
    "prepare": "husky"
  },
  "lint-staged": {
    "*.{js,jsx,ts,tsx}": [
      "eslint --fix",
      "prettier --write"
    ],
    "*.{json,md,css}": [
      "prettier --write"
    ]
  },
  "dependencies": {
    "@ai-sdk/google": "^3.0.6",
    "@ai-sdk/openai": "^3.0.2",
    "@ai-sdk/react": "^3.0.6",
    "@next/third-parties": "^16.1.1",
    "@radix-ui/react-dialog": "^1.1.15",
    "@radix-ui/react-slot": "^1.2.4",
    "@upstash/ratelimit": "^2.0.7",
    "@upstash/redis": "^1.36.0",
    "ai": "^6.0.6",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "lucide-react": "^0.562.0",
    "next": "16.1.1",
    "next-themes": "^0.4.6",
    "openai": "^6.15.0",
    "react": "19.2.3",
    "react-dom": "19.2.3",
    "sonner": "^2.0.7",
    "tailwind-merge": "^3.4.0",
    "zod": "^3.24.1"
  },
  "devDependencies": {
    "@playwright/test": "^1.57.0",
    "@tailwindcss/postcss": "^4",
    "@testing-library/jest-dom": "^6.9.1",
    "@testing-library/react": "^16.3.1",
    "@types/node": "^20.19.27",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "@vitejs/plugin-react": "^5.1.2",
    "eslint": "^9",
    "eslint-config-next": "16.1.1",
    "eslint-config-prettier": "^10.1.8",
    "eslint-plugin-unused-imports": "^4.3.0",
    "husky": "^9.1.7",
    "jsdom": "^27.4.0",
    "knip": "^5.79.0",
    "lint-staged": "^16.2.7",
    "prettier": "^3.7.4",
    "tailwindcss": "^4",
    "ts-node": "^10.9.2",
    "tsconfig-paths": "^4.2.0",
    "tw-animate-css": "^1.4.0",
    "typescript": "^5",
    "vitest": "^4.0.16"
  }
}
</file>

<file path="src/lib/repositories/__tests__/plan-repository.test.ts">
import { describe, it, expect, beforeEach, vi } from 'vitest'
import { PlanRepository, REDIS_KEYS_V2 } from '../plan-repository'
import type { Plan } from '@/types/plan'

// Mock Redis with pipeline support
const createMockPipeline = () => {
  const commands: Array<() => Promise<unknown>> = []
  return {
    set: vi.fn((...args) => {
      commands.push(() => mockRedis.set(...args))
      return createMockPipeline()
    }),
    get: vi.fn((...args) => {
      commands.push(() => mockRedis.get(...args))
      return createMockPipeline()
    }),
    zadd: vi.fn((...args) => {
      commands.push(() => mockRedis.zadd(...args))
      return createMockPipeline()
    }),
    exec: vi.fn(async () => {
      return Promise.all(commands.map(cmd => cmd()))
    }),
  }
}

const mockRedis = {
  set: vi.fn(),
  get: vi.fn(),
  zadd: vi.fn(),
  zrange: vi.fn(),
  pipeline: vi.fn(() => createMockPipeline()),
}

describe('PlanRepository', () => {
  let repository: PlanRepository

  const mockPlan: Plan = {
    title: 'Test Tokyo Trip',
    intro:
      'ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã®ãŸã‚ã®æ±äº¬æ—…è¡Œãƒ—ãƒ©ãƒ³ã€‚åŠ¹ç‡çš„ãªç§»å‹•ã¨é›†ä¸­ã§ãã‚‹ç’°å¢ƒã‚’é‡è¦–ã—ã€æŠ€è¡“ã®è¡—ãƒ»æ¸‹è°·ã‚’ä¸­å¿ƒã«å·¡ã‚Šã¾ã™ã€‚Wi-Fiå®Œå‚™ã®ã‚«ãƒ•ã‚§ã‚„ã‚³ãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ã‚¹ãƒšãƒ¼ã‚¹ã‚’å³é¸ã—ã¾ã—ãŸã€‚',
    target: 'engineer',
    days: [
      {
        day: 1,
        events: [
          {
            t: '09:00',
            n: 'Shibuya Crossing',
            a: 'Visit Shibuya Crossing',
            tp: 'spot',
            nt: 'Famous scramble crossing',
            q: 'Shibuya Crossing Tokyo',
          },
          {
            t: '12:00',
            n: 'Ramen Shop',
            a: 'Lunch at Ramen Shop',
            tp: 'food',
            nt: 'Try tonkotsu ramen',
            q: null,
          },
        ],
      },
      {
        day: 2,
        events: [
          {
            t: '10:00',
            n: 'Tokyo Tower',
            a: 'Visit Tokyo Tower',
            tp: 'spot',
            nt: 'Great city views',
            q: 'Tokyo Tower',
          },
        ],
      },
    ],
  }

  beforeEach(() => {
    vi.clearAllMocks()
    repository = new PlanRepository(mockRedis as never)
  })

  describe('save', () => {
    it('should save a plan and return a slug', async () => {
      mockRedis.set.mockResolvedValue('OK')
      mockRedis.zadd.mockResolvedValue(1)

      const slug = await repository.save(mockPlan)

      expect(slug).toBeTruthy()
      expect(slug).toMatch(/^plan-\d+$/)

      // Verify pipeline was used
      expect(mockRedis.pipeline).toHaveBeenCalled()
      // Verify the actual Redis commands were called (via pipeline)
      expect(mockRedis.set).toHaveBeenCalledTimes(2) // plan + metadata
      expect(mockRedis.zadd).toHaveBeenCalled()
    })

    it('should generate unique slugs for plans with the same title', async () => {
      mockRedis.set.mockResolvedValue('OK')
      mockRedis.zadd.mockResolvedValue(1)

      const slug1 = await repository.save(mockPlan)
      await new Promise(resolve => setTimeout(resolve, 10))
      const slug2 = await repository.save(mockPlan)

      expect(slug1).not.toBe(slug2)
      expect(mockRedis.pipeline).toHaveBeenCalledTimes(2)
    })
  })

  describe('get', () => {
    it('should retrieve a saved plan by slug', async () => {
      const slug = 'test-tokyo-trip-1234567890'
      mockRedis.get.mockResolvedValue(JSON.stringify(mockPlan))

      const retrievedPlan = await repository.get(slug)

      expect(retrievedPlan).toEqual(mockPlan)
      expect(mockRedis.get).toHaveBeenCalledWith(REDIS_KEYS_V2.DATA(slug))
    })

    it('should return null for non-existent plan', async () => {
      mockRedis.get.mockResolvedValue(null)

      const plan = await repository.get('non-existent-plan')

      expect(plan).toBeNull()
    })

    it('should return null if Redis is not configured', async () => {
      const repoWithoutRedis = new PlanRepository()
      const plan = await repoWithoutRedis.get('some-slug')

      expect(plan).toBeNull()
    })
  })

  describe('list', () => {
    it('should return empty array when no plans exist', async () => {
      mockRedis.zrange.mockResolvedValue([])

      const plans = await repository.list()

      expect(plans).toEqual([])
    })

    it('should list all saved plans', async () => {
      const slugs = ['test-tokyo-trip-123', 'another-plan-456']
      mockRedis.zrange.mockResolvedValue(slugs)

      const plans = await repository.list()

      expect(plans).toEqual(slugs)
      expect(mockRedis.zrange).toHaveBeenCalledWith(
        REDIS_KEYS_V2.SLUGS,
        0,
        -1,
        {
          rev: true,
        }
      )
    })
  })

  describe('getRecent', () => {
    it('should get recent plans with default limit', async () => {
      const slugs = Array.from({ length: 10 }, (_, i) => `plan-${i}`)
      mockRedis.zrange.mockResolvedValue(slugs)

      const recent = await repository.getRecent()

      expect(recent).toEqual(slugs)
      expect(mockRedis.zrange).toHaveBeenCalledWith(REDIS_KEYS_V2.SLUGS, 0, 9, {
        rev: true,
      })
    })

    it('should respect custom limit', async () => {
      const slugs = Array.from({ length: 5 }, (_, i) => `plan-${i}`)
      mockRedis.zrange.mockResolvedValue(slugs)

      const recent = await repository.getRecent(5)

      expect(recent).toEqual(slugs)
      expect(mockRedis.zrange).toHaveBeenCalledWith(REDIS_KEYS_V2.SLUGS, 0, 4, {
        rev: true,
      })
    })
  })
})
</file>

<file path="src/components/rakuten-hotel-card.tsx">
'use client'

import { useState, useEffect } from 'react'
import { ExternalLink, Star, MapPin, Building2 } from 'lucide-react'
import type {
  HotelItem,
  RakutenSearchResponse,
} from '@/app/api/rakuten/search/route'

interface RakutenHotelCardProps {
  keyword: string
}

/**
 * æ¥½å¤©ãƒˆãƒ©ãƒ™ãƒ«ã®ãƒ›ãƒ†ãƒ«æƒ…å ±ã‚’è¡¨ç¤ºã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
 * APIãŒå¤±æ•—ã—ãŸå ´åˆã¯Fallbackæ¤œç´¢ãƒªãƒ³ã‚¯ã‚’è¡¨ç¤º
 */
export function RakutenHotelCard({ keyword }: RakutenHotelCardProps) {
  const [hotel, setHotel] = useState<HotelItem | null>(null)
  const [fallbackUrl, setFallbackUrl] = useState<string>('')
  const [isLoading, setIsLoading] = useState(true)
  const [hasError, setHasError] = useState(false)

  useEffect(() => {
    let isActive = true

    const fetchHotel = async () => {
      if (!keyword) {
        setIsLoading(false)
        return
      }

      try {
        const response = await fetch(
          `/api/rakuten/search?keyword=${encodeURIComponent(keyword)}`
        )

        if (!isActive) return

        if (response.ok) {
          const data: RakutenSearchResponse = await response.json()
          setFallbackUrl(data.fallbackUrl)

          if (data.items.length > 0) {
            setHotel(data.items[0]) // ä¸Šä½1ä»¶ã‚’è¡¨ç¤º
          } else {
            setHasError(true)
          }
        } else {
          setHasError(true)
        }
      } catch {
        if (isActive) {
          setHasError(true)
        }
      } finally {
        if (isActive) {
          setIsLoading(false)
        }
      }
    }

    fetchHotel()

    return () => {
      isActive = false
    }
  }, [keyword])

  // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¸­
  if (isLoading) {
    return (
      <div className="mt-3 p-3 bg-gray-50 rounded-lg animate-pulse">
        <div className="flex gap-3">
          <div className="w-20 h-20 bg-gray-200 rounded-lg" />
          <div className="flex-1 space-y-2">
            <div className="h-4 bg-gray-200 rounded w-3/4" />
            <div className="h-3 bg-gray-200 rounded w-1/2" />
            <div className="h-3 bg-gray-200 rounded w-1/4" />
          </div>
        </div>
      </div>
    )
  }

  // ã‚¨ãƒ©ãƒ¼æ™‚ãƒ»ãƒ‡ãƒ¼ã‚¿ãªã—æ™‚ï¼šFallbackãƒªãƒ³ã‚¯è¡¨ç¤º
  if (hasError || !hotel) {
    // çµµæ–‡å­—ã‚„ç‰¹æ®Šè¨˜å·ã‚’é™¤å»ã—ã¦ã‹ã‚‰URLã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
    const sanitizedKeyword = keyword
      .replace(
        /[\u2600-\u26FF]|[\u2700-\u27BF]|[\uE000-\uF8FF]|\uD83C[\uDC00-\uDFFF]|\uD83D[\uDC00-\uDFFF]|\uD83E[\uDD10-\uDDFF]/g,
        ''
      )
      .trim()

    const finalFallbackUrl =
      fallbackUrl ||
      `https://search.travel.rakuten.co.jp/ds/simple/search?f_query=${encodeURIComponent(sanitizedKeyword)}`

    return (
      <a
        href={finalFallbackUrl}
        target="_blank"
        rel="noopener noreferrer"
        className="mt-3 flex items-center justify-center gap-2 w-full py-3 px-4 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-lg hover:from-red-600 hover:to-red-700 transition-all font-medium text-sm shadow-sm"
      >
        <Building2 className="w-4 h-4" />
        æ¥½å¤©ãƒˆãƒ©ãƒ™ãƒ«ã§ã€{keyword}ã€ã®å®¿ã‚’æ¢ã™
        <ExternalLink className="w-3.5 h-3.5" />
      </a>
    )
  }

  // æˆåŠŸæ™‚ï¼šãƒ›ãƒ†ãƒ«ã‚«ãƒ¼ãƒ‰è¡¨ç¤º
  // çµµæ–‡å­—ã‚„ç‰¹æ®Šè¨˜å·ã‚’é™¤å»ã—ã¦ã‹ã‚‰URLã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ï¼ˆFallback URLã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
  const sanitizedKeyword = keyword
    .replace(
      /[\u2600-\u26FF]|[\u2700-\u27BF]|[\uE000-\uF8FF]|\uD83C[\uDC00-\uDFFF]|\uD83D[\uDC00-\uDFFF]|\uD83E[\uDD10-\uDDFF]/g,
      ''
    )
    .trim()
  const searchListUrl =
    fallbackUrl ||
    `https://search.travel.rakuten.co.jp/ds/simple/search?f_query=${encodeURIComponent(sanitizedKeyword)}`

  return (
    <div className="mt-3 space-y-2">
      <a
        href={hotel.affiliateUrl}
        target="_blank"
        rel="noopener noreferrer"
        className="block border border-gray-200 rounded-lg overflow-hidden hover:shadow-md transition-shadow bg-white"
      >
        <div className="flex gap-3 p-3">
          {/* ãƒ›ãƒ†ãƒ«ç”»åƒ */}
          {hotel.hotelImageUrl ? (
            <img
              src={hotel.hotelImageUrl}
              alt={hotel.hotelName}
              className="w-20 h-20 object-cover rounded-lg flex-shrink-0"
            />
          ) : (
            <div className="w-20 h-20 bg-gray-100 rounded-lg flex-shrink-0 flex items-center justify-center">
              <Building2 className="w-8 h-8 text-gray-400" />
            </div>
          )}

          {/* ãƒ›ãƒ†ãƒ«æƒ…å ± */}
          <div className="flex-1 min-w-0">
            <h4 className="font-medium text-gray-900 text-sm line-clamp-2">
              {hotel.hotelName}
            </h4>

            {/* ãƒ¬ãƒ“ãƒ¥ãƒ¼ */}
            {hotel.reviewAverage > 0 && (
              <div className="flex items-center gap-1 mt-1">
                <Star className="w-3.5 h-3.5 text-yellow-500 fill-yellow-500" />
                <span className="text-xs font-medium text-gray-700">
                  {hotel.reviewAverage.toFixed(1)}
                </span>
                {hotel.reviewCount > 0 && (
                  <span className="text-xs text-gray-500">
                    ({hotel.reviewCount}ä»¶)
                  </span>
                )}
              </div>
            )}

            {/* æœ€å®‰å€¤ */}
            {hotel.minPrice > 0 && (
              <p className="mt-1 text-sm">
                <span className="text-gray-500">æœ€å®‰</span>
                <span className="ml-1 font-bold text-red-600">
                  Â¥{hotel.minPrice.toLocaleString()}ã€œ
                </span>
              </p>
            )}

            {/* ä½æ‰€ */}
            {hotel.address && (
              <p className="flex items-center gap-1 mt-1 text-xs text-gray-500 line-clamp-1">
                <MapPin className="w-3 h-3 flex-shrink-0" />
                {hotel.address}
              </p>
            )}
          </div>

          {/* å¤–éƒ¨ãƒªãƒ³ã‚¯ã‚¢ã‚¤ã‚³ãƒ³ */}
          <div className="flex-shrink-0 self-center">
            <ExternalLink className="w-4 h-4 text-gray-400" />
          </div>
        </div>

        {/* æ¥½å¤©ãƒˆãƒ©ãƒ™ãƒ«ãƒãƒƒã‚¸ */}
        <div className="px-3 py-2 bg-gradient-to-r from-red-50 to-red-100 border-t border-red-100">
          <p className="text-xs text-red-700 font-medium text-center">
            ğŸ¨ æ¥½å¤©ãƒˆãƒ©ãƒ™ãƒ«ã§äºˆç´„
          </p>
        </div>
      </a>

      {/* ä»–ã®å®¿ã‚‚æ¢ã™ãƒªãƒ³ã‚¯ */}
      <a
        href={searchListUrl}
        target="_blank"
        rel="noopener noreferrer"
        className="inline-flex items-center gap-1 text-xs text-gray-500 hover:text-gray-700 underline transition-colors"
      >
        ğŸ¨ æ¥½å¤©ãƒˆãƒ©ãƒ™ãƒ«ã§ã€{keyword}ã€ã®ä»–ã®å®¿ã‚‚æ¢ã™
      </a>
    </div>
  )
}
</file>

<file path="src/app/api/plans/__tests__/route.test.ts">
import { describe, it, expect, vi, beforeEach } from 'vitest'
import { POST } from '../route'
import { planRepository } from '@/lib/repositories/plan-repository'
import type { OptimizedPlan } from '@/types/plan'

// Mock the plan repository
vi.mock('@/lib/repositories/plan-repository', () => ({
  planRepository: {
    saveV3: vi.fn(),
  },
}))

describe('POST /api/plans', () => {
  // V3 format: OptimizedPlan
  const mockOptimizedPlan: OptimizedPlan = {
    title: 'é•·å´ãƒ»ä½ä¸–ä¿ æ¹¾å²¸ãƒ‰ãƒ©ã‚¤ãƒ–å‘¨éŠ',
    base_area: 'é•·å´é§…',
    image_query: 'Nagasaki, Japan',
    intro:
      'æ‹ ç‚¹ã®é•·å´é§…ã‹ã‚‰å‡ºç™ºã—ã€ã‚°ãƒ©ãƒãƒ¼åœ’ã€å‡ºå³¶ã€å¹³å’Œå…¬åœ’ã‚’åŠ¹ç‡çš„ã«å·¡ã‚‹1æ—¥ãƒ—ãƒ©ãƒ³ã§ã™ã€‚',
    target: 'general',
    itinerary: [
      {
        day: 1,
        events: [
          {
            time: '09:00',
            spot: 'ã‚°ãƒ©ãƒãƒ¼åœ’',
            query: 'ã‚°ãƒ©ãƒãƒ¼åœ’ é•·å´',
            description: 'æ­´å²çš„ãªæ´‹é¤¨ç¾¤ã‚’è¦‹å­¦',
            type: 'spot',
            search_keyword: null,
            is_stay: false,
          },
          {
            time: '12:00',
            spot: 'å‡ºå³¶å‘¨è¾º',
            query: 'å‡ºå³¶ é•·å´',
            description: 'ã“ã®ã‚¨ãƒªã‚¢ã§ã¯é•·å´ã¡ã‚ƒã‚“ã½ã‚“ãŒãŠã™ã™ã‚',
            type: 'food',
            search_keyword: 'å‡ºå³¶ é•·å´ã¡ã‚ƒã‚“ã½ã‚“',
            is_stay: false,
          },
          {
            time: '14:00',
            spot: 'å¹³å’Œå…¬åœ’',
            query: 'å¹³å’Œå…¬åœ’ é•·å´',
            description: 'å¹³å’Œç¥ˆå¿µåƒã¨è³‡æ–™é¤¨ã‚’è¨ªå•',
            type: 'spot',
            search_keyword: null,
            is_stay: false,
          },
        ],
      },
    ],
    affiliate: {
      label: 'æ¥½å¤©ãƒˆãƒ©ãƒ™ãƒ« - é•·å´ã®ãƒ›ãƒ†ãƒ«äºˆç´„',
      url: 'https://travel.rakuten.co.jp/nagasaki',
    },
  }

  beforeEach(() => {
    vi.clearAllMocks()
  })

  it('should save a valid OptimizedPlan and return success with slug', async () => {
    const mockSlug = 'plan-1234567890'
    vi.mocked(planRepository.saveV3).mockResolvedValue(mockSlug)

    const request = new Request('http://localhost:3000/api/plans', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(mockOptimizedPlan),
    })

    const response = await POST(request as never)
    const data = await response.json()

    expect(response.status).toBe(200)
    expect(data.success).toBe(true)
    expect(data.slug).toBe(mockSlug)
    expect(planRepository.saveV3).toHaveBeenCalledWith(mockOptimizedPlan)
  })

  it('should return 500 if OptimizedPlan validation fails', async () => {
    const invalidResponse = {
      title: 'Invalid Plan',
      // Missing required fields: intro, target, itinerary, affiliate
    }

    const request = new Request('http://localhost:3000/api/plans', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(invalidResponse),
    })

    const response = await POST(request as never)
    const data = await response.json()

    expect(response.status).toBe(500)
    expect(data.success).toBe(false)
    expect(data.error).toBe('Failed to save OptimizedPlan')
    expect(planRepository.saveV3).not.toHaveBeenCalled()
  })

  it('should return 500 if repository save fails', async () => {
    vi.mocked(planRepository.saveV3).mockRejectedValue(
      new Error('Redis connection failed')
    )

    const request = new Request('http://localhost:3000/api/plans', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(mockOptimizedPlan),
    })

    const response = await POST(request as never)
    const data = await response.json()

    expect(response.status).toBe(500)
    expect(data.success).toBe(false)
    expect(data.error).toBe('Failed to save OptimizedPlan')
    expect(data.details).toBe('Redis connection failed')
  })

  it('should handle malformed JSON gracefully', async () => {
    const request = new Request('http://localhost:3000/api/plans', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: 'invalid json',
    })

    const response = await POST(request as never)
    const data = await response.json()

    expect(response.status).toBe(500)
    expect(data.success).toBe(false)
    expect(data.error).toBe('Failed to save OptimizedPlan')
    expect(planRepository.saveV3).not.toHaveBeenCalled()
  })
})
</file>

<file path="src/app/api/rakuten/search/route.ts">
import { NextRequest, NextResponse } from 'next/server'

export const runtime = 'edge'

/**
 * æ¥½å¤©ãƒˆãƒ©ãƒ™ãƒ«APIã®ãƒ›ãƒ†ãƒ«æƒ…å ±å‹å®šç¾©
 */
interface RakutenHotelBasicInfo {
  hotelNo: number
  hotelName: string
  hotelInformationUrl: string
  hotelMinCharge: number
  reviewAverage: number
  reviewCount: number
  hotelImageUrl: string
  hotelThumbnailUrl: string
  address1: string
  address2: string
  telephoneNo: string
  access: string
}

interface RakutenHotel {
  hotel: Array<{
    hotelBasicInfo?: RakutenHotelBasicInfo
  }>
}

interface RakutenAPIResponse {
  pagingInfo?: {
    recordCount: number
    pageCount: number
    page: number
    first: number
    last: number
  }
  hotels?: RakutenHotel[]
  error?: string
  error_description?: string
}

/**
 * ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å‘ã‘ã®ãƒ›ãƒ†ãƒ«æƒ…å ±å‹
 */
export interface HotelItem {
  hotelName: string
  hotelImageUrl: string
  minPrice: number
  reviewAverage: number
  reviewCount: number
  affiliateUrl: string
  address: string
  access: string
}

/**
 * APIãƒ¬ã‚¹ãƒãƒ³ã‚¹å‹
 */
export interface RakutenSearchResponse {
  items: HotelItem[]
  fallbackUrl: string
}

/**
 * çµµæ–‡å­—ã‚„ç‰¹æ®Šè¨˜å·ã‚’é™¤å»ã—ã¦æ¥½å¤©APIç”¨ã«ã‚µãƒ‹ã‚¿ã‚¤ã‚º
 */
function sanitizeKeyword(keyword: string): string {
  return keyword
    .replace(
      /[\u2600-\u26FF]|[\u2700-\u27BF]|[\uE000-\uF8FF]|\uD83C[\uDC00-\uDFFF]|\uD83D[\uDC00-\uDFFF]|\uD83E[\uDD10-\uDDFF]/g,
      ''
    )
    .trim()
}

/**
 * GET /api/rakuten/search
 * æ¥½å¤©ãƒˆãƒ©ãƒ™ãƒ«APIã‚’ãƒ—ãƒ­ã‚­ã‚·ã—ã€ãƒ›ãƒ†ãƒ«æƒ…å ±ã‚’å–å¾—
 *
 * Query Parameters:
 * - keyword: æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆã‚¨ãƒªã‚¢åã‚„ãƒ›ãƒ†ãƒ«åï¼‰
 *
 * @returns JSON with items[] and fallbackUrl
 */
export async function GET(request: NextRequest) {
  const { searchParams } = request.nextUrl
  const rawKeyword = searchParams.get('keyword')

  // ç’°å¢ƒå¤‰æ•°å–å¾—
  const appId = process.env.RAKUTEN_APP_ID
  const affiliateId = process.env.RAKUTEN_AFFILIATE_ID

  // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ã‚µãƒ‹ã‚¿ã‚¤ã‚º
  const keyword = rawKeyword ? sanitizeKeyword(rawKeyword) : ''

  // Fallback URLç”Ÿæˆï¼ˆAPIãŒå¤±æ•—ã—ã¦ã‚‚ã“ã‚Œã‚’è¿”ã™ï¼‰
  // 1. æ­£ã—ã„ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§æ¤œç´¢URLã‚’ä½œæˆ
  const searchUrl = `https://search.travel.rakuten.co.jp/ds/simple/search?f_dai=japan&f_query=${encodeURIComponent(keyword)}`

  // 2. affiliateIdãŒã‚ã‚‹å ´åˆã¯ã€hb.afl.rakuten.co.jp ã§ãƒ©ãƒƒãƒ—ã™ã‚‹
  const fallbackUrl = affiliateId
    ? `https://hb.afl.rakuten.co.jp/hgc/${affiliateId}/?pc=${encodeURIComponent(searchUrl)}`
    : searchUrl

  // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  if (!keyword) {
    return NextResponse.json<RakutenSearchResponse>(
      { items: [], fallbackUrl },
      { status: 200 }
    )
  }

  // ç’°å¢ƒå¤‰æ•°ãƒã‚§ãƒƒã‚¯
  if (!appId) {
    console.error('[Rakuten API] RAKUTEN_APP_ID is not configured')
    return NextResponse.json<RakutenSearchResponse>(
      { items: [], fallbackUrl },
      { status: 200 }
    )
  }

  try {
    // æ¥½å¤©ãƒˆãƒ©ãƒ™ãƒ« KeywordHotelSearch API
    const apiUrl = new URL(
      'https://app.rakuten.co.jp/services/api/Travel/KeywordHotelSearch/20170426'
    )
    apiUrl.searchParams.set('format', 'json')
    apiUrl.searchParams.set('keyword', keyword)
    apiUrl.searchParams.set('applicationId', appId)
    apiUrl.searchParams.set('hits', '3') // ä¸Šä½3ä»¶å–å¾—

    if (affiliateId) {
      apiUrl.searchParams.set('affiliateId', affiliateId)
    }

    console.log(`[Rakuten API] Fetching: keyword="${keyword}"`)

    const response = await fetch(apiUrl.toString(), {
      method: 'GET',
      headers: {
        Accept: 'application/json',
      },
    })

    // 404ã¯ã€Œãƒ’ãƒƒãƒˆãªã—ã€ã¨ã—ã¦æ­£å¸¸ã«å‡¦ç†ï¼ˆã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’å‡ºã•ãªã„ï¼‰
    if (response.status === 404) {
      console.log(`[Rakuten API] No hotels found (404) for: "${keyword}"`)
      return NextResponse.json<RakutenSearchResponse>(
        { items: [], fallbackUrl },
        { status: 200 }
      )
    }

    // APIã‚¨ãƒ©ãƒ¼ï¼ˆ429 Too Many Requests, 5xxãªã©ï¼‰
    if (!response.ok) {
      console.error(
        `[Rakuten API] HTTP Error: ${response.status} ${response.statusText}`
      )
      return NextResponse.json<RakutenSearchResponse>(
        { items: [], fallbackUrl },
        { status: 200 }
      )
    }

    const data: RakutenAPIResponse = await response.json()

    // APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¨ãƒ©ãƒ¼
    if (data.error) {
      console.error(`[Rakuten API] API Error: ${data.error_description}`)
      return NextResponse.json<RakutenSearchResponse>(
        { items: [], fallbackUrl },
        { status: 200 }
      )
    }

    // æ¤œç´¢çµæœãŒ0ä»¶
    if (!data.hotels || data.hotels.length === 0) {
      console.log(`[Rakuten API] No hotels found for: "${keyword}"`)
      return NextResponse.json<RakutenSearchResponse>(
        { items: [], fallbackUrl },
        { status: 200 }
      )
    }

    // ãƒ›ãƒ†ãƒ«æƒ…å ±ã‚’æ•´å½¢
    const items: HotelItem[] = data.hotels
      .map(hotel => {
        const basicInfo = hotel.hotel?.[0]?.hotelBasicInfo
        if (!basicInfo) return null

        return {
          hotelName: basicInfo.hotelName,
          hotelImageUrl:
            basicInfo.hotelImageUrl || basicInfo.hotelThumbnailUrl || '',
          minPrice: basicInfo.hotelMinCharge || 0,
          reviewAverage: basicInfo.reviewAverage || 0,
          reviewCount: basicInfo.reviewCount || 0,
          affiliateUrl: basicInfo.hotelInformationUrl,
          address: `${basicInfo.address1 || ''}${basicInfo.address2 || ''}`,
          access: basicInfo.access || '',
        }
      })
      .filter((item): item is HotelItem => item !== null)

    console.log(
      `[Rakuten API] Success: Found ${items.length} hotels for "${keyword}"`
    )

    return NextResponse.json<RakutenSearchResponse>({
      items,
      fallbackUrl,
    })
  } catch (error) {
    console.error('[Rakuten API] Unexpected error:', error)
    return NextResponse.json<RakutenSearchResponse>(
      { items: [], fallbackUrl },
      { status: 200 }
    )
  }
}
</file>

<file path="src/components/optimized-plan-view.tsx">
'use client'

import { useState, useEffect, useRef } from 'react'
import type { DeepPartial } from 'ai'
import type { OptimizedPlan, ItineraryDay } from '@/types/plan'
import {
  MapPin,
  Clock,
  Copy,
  Check,
  ArrowLeft,
  ExternalLink,
  Utensils,
  Navigation,
  Search,
} from 'lucide-react'
import { toast } from 'sonner'
import { RakutenHotelCard } from './rakuten-hotel-card'

interface OptimizedPlanViewProps {
  plan: DeepPartial<OptimizedPlan>
}

/**
 * Generate Google Maps directions URL from base_area and events
 * Single Source of Truth: URL is always consistent with displayed events
 */
function generateGoogleMapsUrl(
  baseArea: string,
  day: DeepPartial<ItineraryDay>
): string {
  // Filter events: only 'spot' type (exclude 'food' to avoid vague area references like "â—‹â—‹é§…å‘¨è¾º")
  const waypoints =
    day.events
      ?.filter(event => event?.type === 'spot')
      .map(event => event?.spot)
      .filter((spot): spot is string => !!spot) || []

  // Build URL with origin, destination (both base_area), and waypoints
  const params = new URLSearchParams()
  params.set('api', '1')
  params.set('origin', baseArea)
  params.set('destination', baseArea)

  if (waypoints.length > 0) {
    params.set('waypoints', waypoints.join('|'))
  }

  // Corrected: Use standard Google Maps Directions URL format
  // Format: https://www.google.com/maps/dir/?api=1&origin=...&destination=...&waypoints=...
  return `https://www.google.com/maps/dir/?${params.toString()}`
}

/**
 * ã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰åœ°åã®ã¿ã‚’æŠ½å‡ºã™ã‚‹ï¼ˆå¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
 * ä¾‹: "æ¾æ±Ÿé§…å‘¨è¾ºã®é­…åŠ›ã‚’å·¡ã‚‹ãƒ‰ãƒ©ã‚¤ãƒ–" -> "æ¾æ±Ÿ"
 * @deprecated image_query ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å„ªå…ˆä½¿ç”¨
 */
function extractLocationFromTitle(title: string): string {
  // 1. åŒºåˆ‡ã‚Šæ–‡å­—ã§åˆ†å‰²ã—ã€å…ˆé ­ã®è¦ç´ ã‚’å–å¾—
  const delimiters = /[ãƒ» ã€€ã®]/
  const parts = title.split(delimiters)
  let location = parts[0] || ''

  // 2. æ¤œç´¢ã«ä¸è¦ãªæ¥å°¾è¾ã‚’å‰Šé™¤
  const suffixes = ['é§…', 'å‘¨è¾º', 'å¸‚', 'çœŒ', 'è¦³å…‰', 'æ—…è¡Œ', 'æ—…', 'ãƒ‰ãƒ©ã‚¤ãƒ–']
  for (const suffix of suffixes) {
    if (location.endsWith(suffix)) {
      location = location.slice(0, -suffix.length)
    }
  }

  // 3. ç©ºæ–‡å­—ã«ãªã£ãŸå ´åˆã¯å…ƒã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¿”ã™
  return location.trim() || title
}

export function OptimizedPlanView({ plan }: OptimizedPlanViewProps) {
  const [copied, setCopied] = useState(false)
  const [imageUrl, setImageUrl] = useState<string | null>(null)

  // è‹±èªã‚¯ã‚¨ãƒªã§å–å¾—æ¸ˆã¿ã‹ã©ã†ã‹ï¼ˆä¸€åº¦trueã«ãªã£ãŸã‚‰æ—¥æœ¬èªæ¤œç´¢ã«ã¯æˆ»ã‚‰ãªã„ï¼‰
  const hasEnglishQueryImageRef = useRef(false)
  // æœ€å¾Œã«å–å¾—ã—ãŸã‚¯ã‚¨ãƒªï¼ˆé‡è¤‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆé˜²æ­¢ï¼‰
  const lastFetchedQueryRef = useRef<string | null>(null)

  // Fetch destination image from Unsplash
  // å„ªå…ˆé †ä½: 1. plan.image_queryï¼ˆAIç”Ÿæˆã®è‹±èªã‚¯ã‚¨ãƒªï¼‰ 2. extractLocationFromTitleï¼ˆå¾Œæ–¹äº’æ›ï¼‰
  useEffect(() => {
    let isActive = true // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ç”¨ãƒ•ãƒ©ã‚°ï¼ˆRace Conditionå¯¾ç­–ï¼‰

    const fetchImage = async () => {
      // 1. ã‚¯ã‚¨ãƒªã®æ±ºå®šï¼ˆè‹±èªã‚¯ã‚¨ãƒªæœ€å„ªå…ˆï¼‰
      let query: string | null = null
      let isEnglishQuery = false

      if (plan.image_query && plan.image_query.length >= 2) {
        query = plan.image_query
        isEnglishQuery = true
      } else if (plan.title && plan.title.length >= 2) {
        // è‹±èªã‚¯ã‚¨ãƒªã§æ—¢ã«ç”»åƒå–å¾—æ¸ˆã¿ãªã‚‰ã€æ—¥æœ¬èªãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¯å®Ÿè¡Œã—ãªã„
        if (hasEnglishQueryImageRef.current) {
          return
        }
        query = extractLocationFromTitle(plan.title)
      }

      if (!query) return

      // åŒã˜ã‚¯ã‚¨ãƒªã§æ—¢ã«å–å¾—æ¸ˆã¿ãªã‚‰ã‚¹ã‚­ãƒƒãƒ—
      if (lastFetchedQueryRef.current === query) return

      try {
        console.log(
          `[Image Search] Query: "${query}" (${isEnglishQuery ? 'English' : 'Japanese fallback'})`
        )
        const response = await fetch(
          `/api/unsplash?query=${encodeURIComponent(query)}`
        )

        // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—æ¸ˆã¿ï¼ˆæ–°ã—ã„ã‚¯ã‚¨ãƒªã§å†å®Ÿè¡Œã•ã‚ŒãŸï¼‰ãªã‚‰çµæœã‚’ç„¡è¦–
        if (!isActive) {
          console.log(`[Image Search] Ignoring stale response for: "${query}"`)
          return
        }

        if (response.ok) {
          const data = await response.json()
          if (data.imageUrl && isActive) {
            setImageUrl(data.imageUrl)
            lastFetchedQueryRef.current = query

            // è‹±èªã‚¯ã‚¨ãƒªã§å–å¾—æˆåŠŸã—ãŸã‚‰ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
            if (isEnglishQuery) {
              hasEnglishQueryImageRef.current = true
            }
          }
        }
      } catch (error) {
        if (isActive) {
          console.error('Failed to fetch Unsplash image:', error)
        }
      }
    }

    fetchImage()

    return () => {
      isActive = false // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—: å¤ã„éåŒæœŸå‡¦ç†ã®çµæœã‚’ç„¡è¦–
    }
  }, [plan.image_query, plan.title])

  const copyPlanText = () => {
    if (!plan.title) return

    const text = `${plan.title}

${plan.intro || ''}

${
  plan.itinerary
    ?.map(
      day => `
ã€Day ${day?.day}ã€‘
${day?.events?.map(e => `${e?.time} ${e?.spot}: ${e?.description}`).join('\n') || ''}`
    )
    .join('\n') || ''
}

${plan.affiliate ? `ãŠã™ã™ã‚: ${plan.affiliate.label}` : ''}`

    navigator.clipboard.writeText(text)
    setCopied(true)
    toast.success('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ')
    setTimeout(() => setCopied(false), 2000)
  }

  const getEventIcon = (type?: string) => {
    switch (type) {
      case 'food':
        return <Utensils className="w-4 h-4" />
      case 'move':
        return <Navigation className="w-4 h-4" />
      default:
        return <MapPin className="w-4 h-4" />
    }
  }

  const getEventColor = (type?: string) => {
    switch (type) {
      case 'food':
        return 'bg-orange-500'
      case 'move':
        return 'bg-gray-400'
      default:
        return 'bg-blue-500'
    }
  }

  // Loading state
  if (!plan.title && !plan.itinerary?.length) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="flex items-center gap-3 text-gray-500">
          <div className="w-5 h-5 border-2 border-blue-500 border-t-transparent rounded-full animate-spin" />
          ãƒ—ãƒ©ãƒ³ã‚’ä½œæˆä¸­...
        </div>
      </div>
    )
  }

  return (
    <div className="min-h-screen bg-gray-50 p-4 sm:p-6">
      <div className="max-w-3xl mx-auto space-y-6">
        {/* Destination Image */}
        {imageUrl && (
          <img
            src={imageUrl}
            alt={plan.title || 'æ—…è¡Œå…ˆã®ã‚¤ãƒ¡ãƒ¼ã‚¸'}
            className="w-full h-48 sm:h-64 object-cover rounded-xl shadow-sm mb-6"
          />
        )}

        {/* Header Card */}
        <div className="bg-white rounded-xl p-6 shadow-sm">
          <div className="flex items-start justify-between gap-4">
            <div className="flex-1">
              <h1 className="text-2xl font-bold text-gray-900">
                {plan.title || 'ãƒ—ãƒ©ãƒ³ä½œæˆä¸­...'}
              </h1>
              {plan.intro && (
                <p className="mt-3 text-gray-600 leading-relaxed">
                  {plan.intro}
                </p>
              )}
            </div>
            <button
              onClick={copyPlanText}
              className="flex-shrink-0 p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors"
              title="ãƒ—ãƒ©ãƒ³ã‚’ã‚³ãƒ”ãƒ¼"
            >
              {copied ? (
                <Check className="w-5 h-5 text-green-500" />
              ) : (
                <Copy className="w-5 h-5" />
              )}
            </button>
          </div>
        </div>

        {/* Itinerary Days */}
        {plan.itinerary?.map((day, dayIndex) => (
          <div
            key={dayIndex}
            className="bg-white rounded-xl shadow-sm overflow-hidden"
          >
            {/* Day Header with Google Maps CTA */}
            <div className="p-4 border-b border-gray-100 flex flex-col sm:flex-row sm:items-center justify-between gap-3">
              <h2 className="text-lg font-semibold text-gray-900">
                Day {day?.day || dayIndex + 1}
              </h2>
              {plan.base_area && day?.events && day.events.length > 0 && (
                <a
                  href={generateGoogleMapsUrl(plan.base_area, day)}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="inline-flex items-center justify-center gap-2 px-5 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
                >
                  <MapPin className="w-4 h-4" />
                  Google Mapsã§é–‹ã
                  <ExternalLink className="w-3.5 h-3.5" />
                </a>
              )}
            </div>

            {/* Timeline Events */}
            <div className="p-4 sm:p-6">
              <div className="relative pl-8 space-y-6">
                {/* Timeline line */}
                <div className="absolute left-[7px] top-2 bottom-2 w-0.5 bg-blue-100" />

                {day?.events?.map((event, eventIndex) => (
                  <div key={eventIndex} className="relative">
                    {/* Timeline dot */}
                    <div
                      className={`absolute -left-8 w-4 h-4 ${getEventColor(event?.type)} rounded-full border-4 border-white shadow-sm`}
                    />

                    {/* Event content */}
                    <div className="space-y-1.5">
                      <div className="flex flex-wrap items-center gap-2 text-sm">
                        <span className="flex items-center gap-1 text-gray-500">
                          <Clock className="w-3.5 h-3.5" />
                          {event?.time}
                        </span>
                        <span
                          className={`inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs font-medium ${
                            event?.type === 'food'
                              ? 'bg-orange-100 text-orange-700'
                              : event?.type === 'move'
                                ? 'bg-gray-100 text-gray-600'
                                : 'bg-blue-100 text-blue-700'
                          }`}
                        >
                          {getEventIcon(event?.type)}
                          {event?.type === 'food'
                            ? 'é£Ÿäº‹'
                            : event?.type === 'move'
                              ? 'ç§»å‹•'
                              : 'ã‚¹ãƒãƒƒãƒˆ'}
                        </span>
                      </div>
                      <h3 className="font-medium text-gray-900 text-lg">
                        {event?.spot}
                      </h3>
                      <p className="text-sm text-gray-600 leading-relaxed">
                        {event?.description}
                      </p>
                      {/* Search Link / Rakuten Hotel Card - different by event type */}
                      {(event?.type === 'spot' || event?.type === 'food') &&
                        event?.spot &&
                        (() => {
                          // å®¿æ³Šæ–½è¨­ã®å ´åˆï¼šæ¥½å¤©ãƒˆãƒ©ãƒ™ãƒ«ã‚«ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
                          // is_stay ãƒ•ãƒ©ã‚°ã§åˆ¤å®šï¼ˆæ—¥å¸°ã‚Šæ¸©æ³‰ç­‰ã¨ã®æ··åŒã‚’é˜²ãï¼‰
                          if (event.type === 'spot' && event.is_stay === true) {
                            return (
                              <RakutenHotelCard
                                keyword={event.search_keyword || event.spot}
                              />
                            )
                          }

                          // ãã‚Œä»¥å¤–ï¼šGoogleæ¤œç´¢ãƒªãƒ³ã‚¯
                          const getSearchQuery = () => {
                            if (event.type === 'food')
                              return event.spot + ' ã‚°ãƒ«ãƒ¡'
                            return event.spot + ' è¦³å…‰'
                          }
                          const getSearchLabel = () => {
                            if (event.type === 'food')
                              return 'ã“ã®ã‚¨ãƒªã‚¢ã®äººæ°—åº—ã‚’æ¢ã™'
                            return 'æœ€æ–°æƒ…å ±ãƒ»å…¬å¼HPã‚’æ¤œç´¢'
                          }
                          return (
                            <a
                              href={`https://www.google.com/search?q=${encodeURIComponent(getSearchQuery())}`}
                              target="_blank"
                              rel="noopener noreferrer"
                              className="inline-flex items-center gap-1 mt-3 text-xs font-medium text-blue-600 hover:text-blue-800 transition-colors"
                            >
                              <Search className="w-3 h-3" />
                              {getSearchLabel()}
                            </a>
                          )
                        })()}
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        ))}

        {/* Affiliate Card */}
        {plan.affiliate?.label && (
          <div className="bg-white rounded-xl p-6 shadow-sm border-2 border-blue-100">
            <h3 className="text-sm font-bold text-gray-500 mb-3 uppercase tracking-wider">
              Recommended
            </h3>
            <a
              href={plan.affiliate.url || '#'}
              target="_blank"
              rel="noopener noreferrer"
              className="flex items-center justify-center gap-2 w-full py-4 bg-gradient-to-r from-blue-600 to-blue-500 text-white font-bold rounded-lg shadow-md hover:shadow-lg hover:from-blue-700 hover:to-blue-600 transition-all transform hover:-translate-y-0.5"
            >
              {plan.affiliate.label}
              <ExternalLink className="w-5 h-5" />
            </a>
          </div>
        )}

        {/* Back Button */}
        <button
          onClick={() => {
            window.location.href = '/'
          }}
          className="w-full py-4 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors flex items-center justify-center gap-2 font-medium"
        >
          <ArrowLeft className="w-4 h-4" />
          æ–°ã—ã„ãƒ—ãƒ©ãƒ³ã‚’ä½œæˆ
        </button>
      </div>
    </div>
  )
}
</file>

<file path="src/components/trip-generator.tsx">
'use client'

import { useState } from 'react'
import { experimental_useObject as useObject } from '@ai-sdk/react'
import { type OptimizedPlan, OptimizedPlanSchema } from '@/types/plan'
import { OptimizedPlanView } from '@/components/optimized-plan-view'
import { toast } from 'sonner'
import { debugLog, debugError } from '@/lib/debug'
import { MapPin, Navigation, Car, Train, Calendar } from 'lucide-react'

export function TripGenerator() {
  const [destination, setDestination] = useState('')
  const [baseArea, setBaseArea] = useState('')
  const [transportation, setTransportation] = useState<'car' | 'transit'>(
    'transit'
  )
  const [days, setDays] = useState<number>(2)

  const { object, submit, isLoading } = useObject({
    api: '/api/generate',
    schema: OptimizedPlanSchema,
    onFinish: async ({ object }) => {
      console.log('[Streaming] Finished')
      debugLog('[DEBUG] Stream finished with complete optimized plan')
      debugLog('[DEBUG] Object:', object)

      // Save OptimizedPlan (V3) to database
      if (object) {
        try {
          debugLog('[DEBUG] Saving V3 OptimizedPlan to database...')

          const response = await fetch('/api/plans', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(object),
          })

          const result = await response.json()

          if (result.success) {
            debugLog('[DEBUG] OptimizedPlan saved successfully:', result.slug)
            toast.success('ãƒ—ãƒ©ãƒ³ã‚’ä¿å­˜ã—ã¾ã—ãŸ', {
              description: 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã•ã‚Œã¾ã—ãŸã€‚',
              duration: 3000,
            })
          } else {
            debugError('[DEBUG] Failed to save OptimizedPlan:', result.error)
            toast.error('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', {
              description: 'ãƒ—ãƒ©ãƒ³ã¯ç”Ÿæˆã•ã‚Œã¾ã—ãŸãŒã€ä¿å­˜ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚',
              duration: 5000,
            })
          }
        } catch (error) {
          debugError('[DEBUG] Error saving OptimizedPlan:', error)
          toast.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼', {
            description: 'ãƒ—ãƒ©ãƒ³ã¯ç”Ÿæˆã•ã‚Œã¾ã—ãŸãŒã€ä¿å­˜ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚',
            duration: 5000,
          })
        }
      }
    },
    onError: error => {
      debugError('[DEBUG] Generation error:', error)

      const errorMessage = error.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'

      if (
        errorMessage.includes('Rate limit exceeded') ||
        errorMessage.includes('429')
      ) {
        toast.error('ãƒªã‚¯ã‚¨ã‚¹ãƒˆåˆ¶é™', {
          description: 'ã—ã°ã‚‰ãæ™‚é–“ã‚’ãŠã„ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚',
          duration: 5000,
        })
      } else if (
        errorMessage.includes('timeout') ||
        errorMessage.includes('504')
      ) {
        toast.error('ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ', {
          description: 'å‡¦ç†ã«æ™‚é–“ãŒã‹ã‹ã‚Šã™ãã¾ã—ãŸã€‚å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚',
          duration: 5000,
        })
      } else {
        toast.error('ç”Ÿæˆã‚¨ãƒ©ãƒ¼', {
          description: errorMessage,
          duration: 5000,
        })
      }
    },
  })

  const handleGenerate = async () => {
    debugLog('[DEBUG] handleGenerate called')
    debugLog('[DEBUG] Input data:', {
      destination,
      baseArea,
      transportation,
      days,
    })

    if (!destination.trim()) {
      toast.error('ç›®çš„åœ°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„')
      return
    }

    if (!baseArea.trim()) {
      toast.error('æ‹ ç‚¹ã‚¨ãƒªã‚¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„')
      return
    }

    try {
      debugLog('[DEBUG] Calling submit()...')
      submit({
        destination,
        base_area: baseArea,
        transportation,
        days,
      })
      debugLog('[DEBUG] submit() called')
    } catch (err) {
      debugError('[DEBUG] Submit error:', err)
    }
  }

  return (
    <>
      {!object && !isLoading ? (
        <div className="min-h-screen bg-white p-4 sm:p-6">
          <div className="max-w-2xl mx-auto space-y-8">
            {/* Header */}
            <header className="text-center pt-8 pb-4">
              <h1 className="text-3xl font-bold text-gray-900">
                Optimized Solo Travel
              </h1>
              <p className="text-gray-500 mt-2">
                åŠ¹ç‡çš„ãªä¸€äººæ—…ã®ãƒ«ãƒ¼ãƒˆã‚’è¨­è¨ˆã—ã¾ã™
              </p>
            </header>

            {/* Destination Input */}
            <div className="space-y-2">
              <label className="flex items-center gap-2 text-sm font-medium text-gray-700">
                <MapPin className="w-4 h-4" />
                ç›®çš„åœ°
              </label>
              <input
                type="text"
                value={destination}
                onChange={e => setDestination(e.target.value)}
                placeholder="ä¾‹: é•·å´, é‡‘æ²¢, å°¾é“..."
                className="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all placeholder:text-gray-400"
                autoFocus
              />
            </div>

            {/* Base Area Input */}
            <div className="space-y-2">
              <label className="flex items-center gap-2 text-sm font-medium text-gray-700">
                <Navigation className="w-4 h-4" />
                æ‹ ç‚¹ã‚¨ãƒªã‚¢ï¼ˆãƒ›ãƒ†ãƒ«å‘¨è¾ºï¼‰
              </label>
              <input
                type="text"
                value={baseArea}
                onChange={e => setBaseArea(e.target.value)}
                placeholder="ä¾‹: é•·å´é§…å‘¨è¾º, é‡‘æ²¢é§…æ±å£, å°¾é“é§…å‰..."
                className="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all placeholder:text-gray-400"
              />
              <p className="text-xs text-gray-500">
                ãƒ«ãƒ¼ãƒˆã®èµ·ç‚¹ãƒ»çµ‚ç‚¹ã¨ãªã‚‹ã‚¨ãƒªã‚¢ã‚’æŒ‡å®šã—ã¦ãã ã•ã„
              </p>
            </div>

            {/* Transportation Selection */}
            <div className="space-y-2">
              <label className="text-sm font-medium text-gray-700">
                ç§»å‹•æ‰‹æ®µ
              </label>
              <div className="grid grid-cols-2 gap-4">
                <button
                  onClick={() => setTransportation('transit')}
                  className={`flex items-center justify-center gap-2 py-4 rounded-lg border-2 transition-all ${
                    transportation === 'transit'
                      ? 'border-blue-500 bg-blue-50 text-blue-600'
                      : 'border-gray-200 text-gray-600 hover:border-gray-300'
                  }`}
                >
                  <Train className="w-5 h-5" />
                  <span className="font-medium">å…¬å…±äº¤é€š</span>
                </button>
                <button
                  onClick={() => setTransportation('car')}
                  className={`relative flex items-center justify-center gap-2 py-4 rounded-lg border-2 transition-all ${
                    transportation === 'car'
                      ? 'border-blue-500 bg-blue-50 text-blue-600'
                      : 'border-gray-200 text-gray-600 hover:border-gray-300'
                  }`}
                >
                  <span className="absolute -top-2 -right-2 px-2 py-0.5 bg-orange-500 text-white text-xs font-bold rounded-full">
                    ãŠã™ã™ã‚
                  </span>
                  <Car className="w-5 h-5" />
                  <span className="font-medium">è»Š / ãƒ¬ãƒ³ã‚¿ã‚«ãƒ¼</span>
                </button>
              </div>
            </div>

            {/* Days Selection */}
            <div className="space-y-2">
              <label className="flex items-center gap-2 text-sm font-medium text-gray-700">
                <Calendar className="w-4 h-4" />
                æ—…è¡Œæ—¥æ•°
              </label>
              <select
                value={days}
                onChange={e => setDays(Number(e.target.value))}
                className="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all bg-white"
              >
                <option value={1}>1æ—¥ï¼ˆæ—¥å¸°ã‚Šï¼‰</option>
                <option value={2}>2æ—¥ï¼ˆ1æ³Š2æ—¥ï¼‰</option>
                <option value={3}>3æ—¥ï¼ˆ2æ³Š3æ—¥ï¼‰</option>
                <option value={4}>4æ—¥ï¼ˆ3æ³Š4æ—¥ï¼‰</option>
              </select>
              <p className="text-xs text-gray-500">
                ç”Ÿæˆé€Ÿåº¦ã¨å“è³ªã®ãŸã‚ã€æœ€å¤§3æ³Š4æ—¥ã¾ã§ã¨ãªã‚Šã¾ã™
              </p>
            </div>

            {/* Generate Button */}
            <button
              onClick={handleGenerate}
              disabled={!destination.trim() || !baseArea.trim() || isLoading}
              className="w-full py-4 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
            >
              {isLoading ? (
                <span className="flex items-center justify-center gap-2">
                  <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin" />
                  ãƒ—ãƒ©ãƒ³ã‚’ä½œæˆä¸­...
                </span>
              ) : (
                'ãƒ—ãƒ©ãƒ³ã‚’ä½œæˆ'
              )}
            </button>

            {/* Disclaimer */}
            <div className="bg-gray-50 rounded-lg p-4">
              <details className="text-gray-600 text-sm">
                <summary className="cursor-pointer hover:text-gray-800 font-medium">
                  ã”åˆ©ç”¨ä¸Šã®æ³¨æ„
                </summary>
                <div className="space-y-2 pt-3 mt-3 border-t border-gray-200 text-xs leading-relaxed">
                  <p>
                    ãƒ»ã“ã®ã‚µãƒ¼ãƒ“ã‚¹ã¯ãƒ™ãƒ¼ã‚¿ç‰ˆã§ã™ã€‚AIãŒç”Ÿæˆã™ã‚‹æƒ…å ±ã¯ä¸æ­£ç¢ºãªå ´åˆãŒã‚ã‚Šã¾ã™ã€‚
                  </p>
                  <p>
                    ãƒ»1æ—¥ã‚ãŸã‚Šã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°ã«åˆ¶é™ãŒã‚ã‚Šã¾ã™ï¼ˆAPIåˆ¶ç´„ã®ãŸã‚ï¼‰ã€‚
                  </p>
                  <p>
                    ãƒ»è¨ªå•å‰ã«å–¶æ¥­æ™‚é–“ã€æ–™é‡‘ã€äºˆç´„ã®å¿…è¦æ€§ãªã©ã‚’å¿…ãšã”ç¢ºèªãã ã•ã„ã€‚
                  </p>
                </div>
              </details>
            </div>
          </div>
        </div>
      ) : object ? (
        <OptimizedPlanView plan={object as OptimizedPlan} />
      ) : null}
    </>
  )
}
</file>

<file path="src/types/plan.ts">
import { z } from 'zod'

// ============================================
// LEGACY SCHEMAS (for backward compatibility)
// ============================================

/**
 * Event type enum for categorizing activities
 * @deprecated Use ScouterResponse schema for new implementations
 */
export const EventTypeSchema = z.enum(['spot', 'food', 'work', 'move'])
export type EventType = z.infer<typeof EventTypeSchema>

/**
 * Target audience type for the travel plan
 * @deprecated Use ScouterResponse schema for new implementations
 */
export const TargetTypeSchema = z.enum(['engineer', 'general'])
export type TargetType = z.infer<typeof TargetTypeSchema>

/**
 * Schema for a single event in the itinerary (Short-key Object format)
 * @deprecated Use ScouterResponse schema for new implementations
 */
export const EventSchema = z.object({
  t: z.string().describe('Time of the event (e.g., "09:00")'),
  n: z.string().describe('Name of the place or activity'),
  a: z.string().describe('Description of the activity'),
  tp: EventTypeSchema.describe('Type of activity (spot/food/work/move)'),
  nt: z.string().describe('Additional notes or details'),
  q: z
    .string()
    .nullable()
    .describe(
      'English search query optimized for Unsplash API (only for type="spot", use null for other types)'
    ),
})
export type Event = z.infer<typeof EventSchema>

/**
 * Schema for a single day in the travel plan
 * @deprecated Use ScouterResponse schema for new implementations
 */
export const DaySchema = z.object({
  day: z.number().positive().describe('Day number (1-indexed)'),
  events: z.array(EventSchema).describe('List of events for this day'),
})
export type Day = z.infer<typeof DaySchema>

/**
 * Complete travel plan schema (LEGACY)
 * @deprecated Use ScouterResponse schema for new implementations
 */
export const PlanSchema = z.object({
  title: z.string().describe('Title of the travel plan'),
  intro: z
    .string()
    .describe(
      'Engaging introduction text (150-200 Japanese characters) explaining why this plan is ideal for the target audience, highlighting the trip theme and appeal'
    ),
  target: TargetTypeSchema.describe('Target audience for this plan'),
  days: z.array(DaySchema).describe('Array of daily itineraries'),
})
export type Plan = z.infer<typeof PlanSchema>

// ============================================
// V2 SCHEMA: Engineer's Scouter (DEPRECATED)
// ============================================

/**
 * Target spot with Google Maps search capability
 * @deprecated Use OptimizedPlanSchema for new implementations
 */
export const TargetSpotSchema = z.object({
  n: z.string().describe('Spot name in Japanese'),
  q: z
    .string()
    .describe(
      'Google Maps search query to verify the location exists (e.g., "å·å´å¸‚ å·¥å ´åœ°å¸¯" or specific facility name)'
    ),
})
export type TargetSpot = z.infer<typeof TargetSpotSchema>

/**
 * Quest (mission directive) for the agent
 * @deprecated Use OptimizedPlanSchema for new implementations
 */
export const QuestSchema = z.object({
  t: z.string().describe('Quest title/directive (e.g., "æ§‹é€ æ’®å½±æŒ‡ä»¤")'),
  d: z
    .string()
    .describe(
      'Detailed description of what to do, what to capture, or what to observe'
    ),
  gear: z
    .string()
    .describe(
      'Recommended equipment with SPECIFIC product names/model numbers (e.g., "Manfrotto PIXI ãƒŸãƒ‹ä¸‰è„š")'
    ),
})
export type Quest = z.infer<typeof QuestSchema>

/**
 * Affiliate recommendation (monetization)
 * @deprecated Use AffiliateV3Schema for new implementations
 */
export const AffiliateSchema = z.object({
  item: z
    .string()
    .describe(
      'Specific product name with model number (e.g., "Manfrotto PIXI EVO 2 Section")'
    ),
  reason: z
    .string()
    .describe(
      'Why this product is recommended for this mission (technical reasoning)'
    ),
  q: z
    .string()
    .describe(
      'Amazon/Rakuten search keyword for affiliate link generation (e.g., "Manfrotto PIXI")'
    ),
})
export type Affiliate = z.infer<typeof AffiliateSchema>

/**
 * Complete Scouter Response (Mission Briefing)
 * Replaces the old "travel plan" concept with "investigation mission"
 * @deprecated Use OptimizedPlanSchema for new implementations
 */
export const ScouterResponseSchema = z.object({
  mission_title: z
    .string()
    .describe('Mission operation name (e.g., "å·å´å·¥æ¥­åœ°å¸¯æ¢ç´¢ä½œæˆ¦")'),
  intro: z
    .string()
    .describe(
      'Mission briefing in SF/analytical tone (150-200 Japanese characters)'
    ),
  target_spot: TargetSpotSchema.describe(
    'Primary investigation location (must be real and verifiable on Google Maps)'
  ),
  atmosphere: z
    .string()
    .describe(
      'SF/engineering appeal of the location (structure, texture, industrial aesthetics, decay, etc.)'
    ),
  quests: z
    .array(QuestSchema)
    .min(2)
    .max(4)
    .describe('Mission objectives/directives (2-4 quests)'),
  affiliate: AffiliateSchema.describe(
    'Gear recommendation with specific product name/model'
  ),
})
export type ScouterResponse = z.infer<typeof ScouterResponseSchema>

/**
 * Input schema for generating a travel plan
 * @deprecated Use GenerateInputV3Schema for new implementations
 */
export const GenerateInputSchema = z.object({
  destination: z.string().min(1, 'Destination is required'),
  template: z.string().min(1, 'Template is required'),
  options: z.record(z.string(), z.unknown()).optional(),
})
export type GenerateInput = z.infer<typeof GenerateInputSchema>

// ============================================
// V3 SCHEMA: Optimized Solo Travel
// ============================================

/**
 * V3 Input schema for generating an optimized travel plan
 */
export const GenerateInputV3Schema = z.object({
  destination: z.string().min(1, 'Destination is required'),
  base_area: z.string().min(1, 'Base area is required'),
  transportation: z.enum(['car', 'transit']),
  days: z
    .number()
    .min(1)
    .max(4)
    .default(2)
    .describe('Number of days: 1=æ—¥å¸°ã‚Š, 2=1æ³Š2æ—¥, 3=2æ³Š3æ—¥, 4=3æ³Š4æ—¥'),
})
export type GenerateInputV3 = z.infer<typeof GenerateInputV3Schema>

/**
 * Event type for V3 itinerary
 */
export const EventTypeV3Schema = z.enum(['spot', 'food', 'move'])
export type EventTypeV3 = z.infer<typeof EventTypeV3Schema>

/**
 * Single event in V3 itinerary
 */
export const EventV3Schema = z.object({
  time: z.string().describe('Time of the event (e.g., "10:00")'),
  spot: z.string().describe('Spot name'),
  query: z.string().describe('Google Maps search query'),
  description: z.string().describe('Description of what to do at this spot'),
  type: EventTypeV3Schema.describe('Event type (spot/food/move)'),
  search_keyword: z
    .string()
    .nullable()
    .describe(
      'Search query for hotel/spot booking. Format: "Area Keyword" (space separated). No particles like "no", "ni". Example: "Ibusuki Sunamushi", "Tenmonkan Hotel". Use null if not needed for regular tourist spots.'
    ),
  is_stay: z
    .boolean()
    .describe(
      'True ONLY if this event is for overnight stay (check-in). False for day-use spots (e.g., day-trip hot springs, lunch at ryokan). This field is required.'
    ),
})
export type EventV3 = z.infer<typeof EventV3Schema>

/**
 * Single day in V3 itinerary
 * NOTE: google_maps_url was removed - URL is now generated on the frontend
 * from events array to ensure 100% consistency (Single Source of Truth)
 */
export const ItineraryDaySchema = z.object({
  day: z.number().positive().describe('Day number (1-indexed)'),
  events: z.array(EventV3Schema).describe('List of events for this day'),
})
export type ItineraryDay = z.infer<typeof ItineraryDaySchema>

/**
 * V3 Affiliate recommendation
 */
export const AffiliateV3Schema = z.object({
  label: z.string().describe('Display label for the affiliate link'),
  url: z.string().describe('Affiliate URL'),
})
export type AffiliateV3 = z.infer<typeof AffiliateV3Schema>

/**
 * Complete V3 Optimized Plan
 * Focuses on practical route optimization for solo travelers
 * NOTE: Google Maps URL is generated on frontend from base_area + events (Single Source of Truth)
 */
export const OptimizedPlanSchema = z.object({
  title: z
    .string()
    .describe('Trip title (e.g., "é•·å´ãƒ»ä½ä¸–ä¿ æ¹¾å²¸ãƒ‰ãƒ©ã‚¤ãƒ–å‘¨éŠ")'),
  base_area: z
    .string()
    .describe(
      'Base area (starting/ending point) specified by user - used for Google Maps URL generation on frontend'
    ),
  image_query: z
    .string()
    .describe(
      'English search query for Unsplash image (format: "City, Country", e.g., "Matsue, Japan"). Must be in English.'
    ),
  intro: z
    .string()
    .describe(
      'Introduction text emphasizing efficiency and freedom (100-150 Japanese characters)'
    ),
  target: z
    .literal('general')
    .describe('Target audience (always general for V3)'),
  itinerary: z.array(ItineraryDaySchema).describe('Array of daily itineraries'),
  affiliate: AffiliateV3Schema.describe(
    'Recommended service/product (rental car, hotel, etc.)'
  ),
})
export type OptimizedPlan = z.infer<typeof OptimizedPlanSchema>

// ============================================
// INPUT VALIDATION SCHEMA (Step 1: Pre-Check)
// ============================================

/**
 * Schema for validating and correcting user input (destination, base_area)
 * Used in Step 1 lightweight pre-check before main plan generation
 */
export const InputValidationResultSchema = z.object({
  isValid: z
    .boolean()
    .describe('Whether the input locations are valid and exist on Google Maps'),
  correctedDestination: z
    .string()
    .describe(
      'The corrected or validated destination (same as input if valid)'
    ),
  correctedBaseArea: z
    .string()
    .describe('The corrected or validated base area (same as input if valid)'),
  reason: z
    .string()
    .nullable()
    .describe(
      'Explanation of the correction if isValid is false (e.g., "å³¶æ ¹é§…ã¯å­˜åœ¨ã—ãªã„ãŸã‚æ¾æ±Ÿé§…ã«å¤‰æ›´")'
    ),
})
export type InputValidationResult = z.infer<typeof InputValidationResultSchema>
</file>

<file path="src/app/api/generate/route.ts">
import { NextRequest } from 'next/server'
import { generateObject, streamObject } from 'ai'
import { openai } from '@ai-sdk/openai'
import {
  GenerateInputV3Schema,
  OptimizedPlanSchema,
  InputValidationResultSchema,
} from '@/types/plan'
import {
  checkRateLimit,
  getClientIP,
  globalRateLimit,
  ipRateLimit,
} from '@/lib/rate-limit'
import { getLLMClient } from '@/lib/llm/client'

export const runtime = 'nodejs'
export const dynamic = 'force-dynamic' // Disable Next.js buffering for true streaming
export const maxDuration = 60 // Vercel Hobby plan max timeout (60 seconds)

// ============================================
// STEP 1: Input Validation Prompt (Lightweight)
// ============================================
const INPUT_VALIDATION_PROMPT = `ã‚ãªãŸã¯æ—¥æœ¬ã®åœ°åæ¤œè¨¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§ã™ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¥åŠ›ã—ãŸã€Œç›®çš„åœ°(destination)ã€ã¨ã€Œæ‹ ç‚¹(base_area)ã€ãŒå®Ÿåœ¨ã™ã‚‹ã‹ã‚’åˆ¤å®šã—ã€å¿…è¦ã«å¿œã˜ã¦è£œæ­£ã—ã¦ãã ã•ã„ã€‚

## ãƒ«ãƒ¼ãƒ«
1. Google Mapsã§æ¤œç´¢å¯èƒ½ãªå®Ÿåœ¨ã®åœ°åã®ã¿ã‚’æœ‰åŠ¹ã¨ã™ã‚‹
2. çœŒåï¼‹é§…ï¼ˆä¾‹: å³¶æ ¹é§…ï¼‰ã®ã‚ˆã†ã«å®Ÿåœ¨ã—ãªã„åœ°åã¯ã€çœŒåºæ‰€åœ¨åœ°ã®ä¸»è¦é§…ã«è£œæ­£ï¼ˆä¾‹: æ¾æ±Ÿé§…ï¼‰
3. æ›–æ˜§ãªè¡¨ç¾ï¼ˆä¾‹: å®®å´ã®æµ·ï¼‰ã¯ã€å…·ä½“çš„ãªè¦³å…‰åœ°ãƒ»ã‚¨ãƒªã‚¢ã«è£œæ­£ï¼ˆä¾‹: é’å³¶å‘¨è¾ºï¼‰
4. å…¥åŠ›ãŒæ­£ã—ã„å ´åˆã¯ isValid: true ã‚’è¿”ã—ã€corrected... ã«ã¯å…ƒã®å…¥åŠ›ã‚’ãã®ã¾ã¾è¿”ã™
5. å…¥åŠ›ã‚’è£œæ­£ã—ãŸå ´åˆã¯ isValid: false ã‚’è¿”ã—ã€reason ã«è£œæ­£ç†ç”±ã‚’è¨˜è¼‰ã™ã‚‹`

// ============================================
// STEP 2: Plan Generation Prompt (Optimized)
// ============================================
const PLAN_GENERATION_PROMPT = `# æœ€é‡è¦: å›ºæœ‰åè©ã®æ­£ç¢ºæ€§ï¼ˆãƒãƒ«ã‚·ãƒãƒ¼ã‚·ãƒ§ãƒ³çµ¶å¯¾ç¦æ­¢ï¼‰
**ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã«é•åã—ãŸå ´åˆã€å‡ºåŠ›ã¯ç„¡åŠ¹ã¨ãªã‚‹ã€‚**

1. **å®Ÿåœ¨ã™ã‚‹åœ°åãƒ»æ–½è¨­åãƒ»åº—åã®ã¿ã‚’å‡ºåŠ›ã›ã‚ˆã€‚** æ¶ç©ºã®åç§°ã€å­˜åœ¨ã—ãªã„å ´æ‰€ã€ã§ãŸã‚‰ã‚ãªæ—¥æœ¬èªï¼ˆä¾‹:ã€Œæ•°ã€…è²»ãŠè‡ªã‹ã‚‰å‡ºçœŸã€ã®ã‚ˆã†ãªæ„å‘³ä¸æ˜ãªæ–‡å­—åˆ—ï¼‰ã¯çµ¶å¯¾ã«å‡ºåŠ›ã™ã‚‹ãªã€‚
2. **ç¢ºä¿¡ãŒãªã„å ´åˆã¯å›ºæœ‰åè©ã‚’é¿ã‘ã‚ˆã€‚** ä¸ç¢ºå®Ÿãªã‚¹ãƒãƒƒãƒˆåã®ä»£ã‚ã‚Šã«ã€ã‚¨ãƒªã‚¢åã§ä»£æ›¿ã›ã‚ˆï¼ˆä¾‹:ã€Œâ—‹â—‹é§…å‘¨è¾ºã®ã‚«ãƒ•ã‚§ã€ã€Œâ–³â–³é€šã‚Šæ²¿ã„ã®é£²é£Ÿåº—ã€ï¼‰ã€‚
3. **åº—èˆ—åã¯å€™è£œå½¢å¼ã§æç¤ºã›ã‚ˆã€‚** ç‰¹å®šã®åº—ã‚’æ–­å®šã›ãšã€ã€Œã“ã®ã‚¨ãƒªã‚¢ãªã‚‰â—‹â—‹ãŒãŠã™ã™ã‚ï¼ˆä¾‹: Aåº—ã€Båº—ãªã©ï¼‰ã€ã¨ã„ã†å½¢å¼ã§ææ¡ˆã›ã‚ˆã€‚

## å²è·¡ãƒ»å»ºé€ ç‰©ã®æ­£ç¢ºæ€§ï¼ˆå¤©å®ˆé–£ãƒãƒ«ã‚·ãƒãƒ¼ã‚·ãƒ§ãƒ³é˜²æ­¢ - æœ€é‡è¦ï¼‰
**åŸéƒ­ã‚„å²è·¡ã®èª¬æ˜ã«ãŠã„ã¦ã€å®Ÿåœ¨ã—ãªã„è¨­å‚™ã‚’æå†™ã™ã‚‹ã“ã¨ã¯çµ¶å¯¾ç¦æ­¢ã€‚**

- **å¤©å®ˆé–£ã®è¨˜è¿°ãƒ«ãƒ¼ãƒ«:**
  - ã€Œå¤©å®ˆé–£ã‹ã‚‰ã®çœºã‚ã€ã€Œå¤©å®ˆé–£ã«ç™»ã‚‹ã€ç­‰ã®è¡¨ç¾ã¯ã€**ç¾å­˜å¤©å®ˆ12åŸ**ï¼ˆå§«è·¯åŸã€æ¾æœ¬åŸã€çŠ¬å±±åŸã€å½¦æ ¹åŸã€æ¾æ±ŸåŸã€ä¸¸äº€åŸã€å‚™ä¸­æ¾å±±åŸã€é«˜çŸ¥åŸã€æ¾å±±åŸã€å®‡å’Œå³¶åŸã€ä¸¸å²¡åŸã€å¼˜å‰åŸï¼‰**ã®ã¿**ã§ä½¿ç”¨å¯ã€‚
  - å¾©å…ƒå¤©å®ˆãƒ»å¾©èˆˆå¤©å®ˆãŒã‚ã‚‹åŸï¼ˆå¤§é˜ªåŸã€åå¤å±‹åŸã€ç†Šæœ¬åŸç­‰ï¼‰ã¯ã€Œå¾©å…ƒå¤©å®ˆã€ã€Œå±•æœ›å°ã€ã¨æ˜è¨˜ã›ã‚ˆã€‚
  - **å¤©å®ˆãŒå­˜åœ¨ã—ãªã„åŸè·¡**ï¼ˆé¹¿å…å³¶åŸã€è©åŸã€ç«¹ç”°åŸç­‰ï¼‰ã§ã¯ã€ã€ŒåŸè·¡ã€ã€ŒçŸ³å£ã€ã€Œæ­´å²çš„éºæ§‹ã€ã¨ã„ã£ãŸå®‰å…¨ãªè¡¨ç¾ã®ã¿ã‚’ä½¿ç”¨ã›ã‚ˆã€‚
  - ã€Œå¤©å®ˆé–£ã‹ã‚‰ã®çµ¶æ™¯ã€ã®ã‚ˆã†ãªå˜˜ã®æå†™ã¯å‡ºåŠ›ç„¡åŠ¹ã¨ã™ã‚‹ã€‚

- **ç¢ºä¿¡ãŒãªã„å ´åˆã®å®‰å…¨è¡¨ç¾:**
  - NG: ã€Œå¤©å®ˆé–£ã‹ã‚‰åŸä¸‹ç”ºã‚’ä¸€æœ›ã€
  - OK: ã€Œæœ¬ä¸¸è·¡ã‹ã‚‰ã®çœºæœ›ã€ã€ŒçŸ³å£ã®ä¸Šã‹ã‚‰ã®æ™¯è‰²ã€ã€Œæ­´å²é¤¨ã®å±•æœ›å®¤ã‹ã‚‰ã€

## ã‚¹ãƒãƒƒãƒˆåç§°ã®ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆåŸºæº–ï¼ˆå³å®ˆï¼‰
- **Google Mapsã«ã€Œæ—¥æœ¬èªã§ã€ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹æ­£å¼åç§°ã®ã¿ã‚’ä½¿ç”¨ã›ã‚ˆã€‚**
- **è‹±èªç›´è¨³é¢¨ã®ä¸è‡ªç„¶ãªåç§°ã¯çµ¶å¯¾ç¦æ­¢ã€‚** ä¾‹: "Rice Park" â†’ "ãƒ©ã‚¤ã‚¹ãƒ‘ãƒ¼ã‚¯" ã®ã‚ˆã†ãªé€ èªã¯NGã€‚
- **å®Ÿåœ¨ç¢ºèªãŒã§ããªã„å ´åˆã¯ã€ä»¥ä¸‹ã®ç¢ºå®Ÿã«å­˜åœ¨ã™ã‚‹ã‚«ãƒ†ã‚´ãƒªã«ç½®ãæ›ãˆã‚ˆ:**
  - é“ã®é§…ï¼ˆä¾‹: é“ã®é§…â—‹â—‹ï¼‰
  - ã‚µãƒ¼ãƒ“ã‚¹ã‚¨ãƒªã‚¢/ãƒ‘ãƒ¼ã‚­ãƒ³ã‚°ã‚¨ãƒªã‚¢ï¼ˆä¾‹: â—‹â—‹SAã€â—‹â—‹PAï¼‰
  - ä¸»è¦è¦³å…‰åœ°ï¼ˆçœŒã‚„å¸‚ã®å…¬å¼è¦³å…‰ã‚µã‚¤ãƒˆã«æ²è¼‰ã•ã‚Œã¦ã„ã‚‹ãƒ¬ãƒ™ãƒ«ï¼‰
  - ä¸»è¦é§…ãƒ»ç©ºæ¸¯

## åç§°æ··åŒã®é˜²æ­¢ï¼ˆAnti-Hallucinationå¼·åŒ–ï¼‰
- **é¡ä¼¼åç§°ã«æ³¨æ„:** ã€Œã€‡ã€‡å¤§æ©‹ã€ã€Œã€‡ã€‡å…¬åœ’ã€ãªã©ç´›ã‚‰ã‚ã—ã„åç§°ã¯ã€å¿…ãš**æ‰€åœ¨å¸‚ç”ºæ‘ã¨ã‚»ãƒƒãƒˆ**ã§ç¢ºèªã—ã¦ã‹ã‚‰å‡ºåŠ›ã›ã‚ˆã€‚
- **ç•°ãªã‚‹å¸‚ç”ºæ‘ã®ã‚¹ãƒãƒƒãƒˆ**ã‚’ã€åœ°ç†çš„ã«è¿‘ã„ã‹ã®ã‚ˆã†ã«ä¸¦ã¹ã¦ã¯ãªã‚‰ãªã„ã€‚

## ä¸è‡ªç„¶ãªæ—¥æœ¬èªã®çµ¶å¯¾ç¦æ­¢ï¼ˆNatural Language Guard - æœ€é‡è¦ï¼‰
**ä»¥ä¸‹ã®ã‚ˆã†ãªä¸è‡ªç„¶ãªè¡¨ç¾ã¯å‡ºåŠ›ç„¡åŠ¹ã¨ã™ã‚‹ã€‚**

- **ç¦æ­¢ãƒ‘ã‚¿ãƒ¼ãƒ³:**
  - ç›´è¨³èª¿ã®ä¸è‡ªç„¶ãªæ—¥æœ¬èªï¼ˆä¾‹: ã€Œèƒ½åŠ›ãŒè¦æ±‚ã•ã‚Œã‚‹å ´é¢ã«ã‚‚ãƒ”ãƒƒã‚¿ãƒªã§ã™ã€ã€Œä½“é¨“ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€ï¼‰
  - æ–‡è„ˆã«ããã‚ãªã„æŠ½è±¡çš„ãªãƒ•ãƒ¬ãƒ¼ã‚ºï¼ˆä¾‹: ã€Œå¤šæ§˜ãªé­…åŠ›ã‚’æŒã¤ã€ã€Œæ§˜ã€…ãªæ¥½ã—ã¿æ–¹ãŒã§ãã‚‹ã€ï¼‰
  - ä¸»èªãŒæ›–æ˜§ã§ä½•ã‚’æŒ‡ã—ã¦ã„ã‚‹ã‹ä¸æ˜ãªæ–‡ç« 
  - è¦³å…‰ã¨ç„¡é–¢ä¿‚ãªæ¦‚å¿µã®å”çªãªæŒ¿å…¥

- **æ¨å¥¨ãƒ‘ã‚¿ãƒ¼ãƒ³:**
  - æ—…è¡Œè€…ãŒèª­ã‚“ã§ãƒ¯ã‚¯ãƒ¯ã‚¯ã™ã‚‹ã€å¹³æ˜“ã§è‡ªç„¶ãªæ—¥æœ¬èª
  - å…·ä½“çš„ãªä½“é¨“ã‚„æ™¯è‰²ã‚’æå†™ã™ã‚‹æ–‡ç« ï¼ˆä¾‹: ã€Œæ¡œå³¶ã‚’ä¸€æœ›ã§ãã‚‹çµ¶æ™¯ã‚¹ãƒãƒƒãƒˆã€ã€Œè–©æ‘©ã®æ­´å²ã‚’æ„Ÿã˜ã‚‹çŸ³ç•³ã®å°é“ã€ï¼‰
  - ã‚·ãƒ³ãƒ—ãƒ«ã§æ˜å¿«ãªæ–‡æ§‹é€ ï¼ˆä¸»èªâ†’è¿°èªãŒæ˜ç¢ºï¼‰

- **è‡ªå·±æ¤œè¨¼:** ç”Ÿæˆå¾Œã€å„descriptionã‚’å£°ã«å‡ºã—ã¦èª­ã¿ã€ã€Œæ—¥æœ¬äººãŒæ™®é€šã«è©±ã™æ—¥æœ¬èªã‹ï¼Ÿã€ã‚’ç¢ºèªã›ã‚ˆã€‚é•å’Œæ„ŸãŒã‚ã‚Œã°æ›¸ãç›´ã™ã“ã¨ã€‚

## ã‚¹ãƒãƒƒãƒˆé¸å®šã®ç¦æ­¢äº‹é …ï¼ˆNegative Constraints - å³å®ˆï¼‰
**ä»¥ä¸‹ã®ã‚«ãƒ†ã‚´ãƒªã¯è¦³å…‰ã‚¹ãƒãƒƒãƒˆã¨ã—ã¦é¸å®šç¦æ­¢ã€‚æ—…è¡Œè€…ãŒã‚ã–ã‚ã–è¨ªã‚Œã‚‹ä¾¡å€¤ãŒãªã„ã€‚**
- å¸‚æ°‘ä½“è‚²é¤¨ã€ã‚¢ãƒªãƒ¼ãƒŠã€ã‚¹ãƒãƒ¼ãƒ„ã‚»ãƒ³ã‚¿ãƒ¼
- åœ°å…ƒä½æ°‘å‘ã‘ã®å°ã•ãªå…¬åœ’ã€å…ç«¥å…¬åœ’
- å…¬æ°‘é¤¨ã€ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã‚»ãƒ³ã‚¿ãƒ¼
- å…¨å›½ãƒã‚§ãƒ¼ãƒ³åº—ï¼ˆã‚³ãƒ³ãƒ“ãƒ‹ã€ãƒ•ã‚¡ãƒŸãƒ¬ã‚¹ã€ã‚«ãƒ•ã‚§ãƒã‚§ãƒ¼ãƒ³ç­‰ï¼‰
- ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ«ï¼ˆè¦³å…‰åœ°ã¨ã—ã¦ã®ç‰¹è‰²ãŒãªã„å ´åˆï¼‰

**é¸å®šã™ã¹ãã‚¹ãƒãƒƒãƒˆ:**
- çœŒã‚„å¸‚ã®å…¬å¼è¦³å…‰ã‚µã‚¤ãƒˆã«æ²è¼‰ã•ã‚Œã¦ã„ã‚‹è¦³å…‰åæ‰€
- æ™¯å‹åœ°ã€å²è·¡ã€æ–‡åŒ–è²¡
- åœ°å…ƒã§è©•åˆ¤ã®ååº—ã€è€èˆ—
- é“ã®é§…ã€SA/PAï¼ˆä¼‘æ†©ã‚¹ãƒãƒƒãƒˆã¨ã—ã¦ï¼‰

---

# ãƒ«ãƒ¼ãƒˆæ§‹ç¯‰ã®çµ¶å¯¾ãƒ«ãƒ¼ãƒ«ï¼ˆç‰©ç†çš„æ•´åˆæ€§ã®æ‹…ä¿ï¼‰

## 0. æ—¥æ•°å³å®ˆãƒ«ãƒ¼ãƒ«ï¼ˆDays Logic - æœ€é‡è¦ï¼‰
**ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæŒ‡å®šã—ãŸæ—¥æ•°ï¼ˆdaysï¼‰ã®è¡Œç¨‹ã‚’å¿…ãšä½œæˆã™ã‚‹ã“ã¨ã€‚ãã‚Œä»¥ä¸Šã‚‚ãã‚Œä»¥ä¸‹ã‚‚ç¦æ­¢ã€‚**
- 1æ—¥ = Day 1 ã®ã¿ï¼ˆæ—¥å¸°ã‚Šï¼‰
- 2æ—¥ = Day 1 ã€œ Day 2ï¼ˆ1æ³Š2æ—¥ï¼‰
- 3æ—¥ = Day 1 ã€œ Day 3ï¼ˆ2æ³Š3æ—¥ï¼‰
- 4æ—¥ = Day 1 ã€œ Day 4ï¼ˆ3æ³Š4æ—¥ï¼‰

## 1. é–‹å§‹åœ°ç‚¹ãƒ«ãƒ¼ãƒ«ï¼ˆStart Logicï¼‰
**Day1ã®æœ€åˆã®ã‚¤ãƒ™ãƒ³ãƒˆã¯ã€å¿…ãšãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¥åŠ›ã—ãŸæ‹ ç‚¹ã‚¨ãƒªã‚¢ï¼ˆbase_areaï¼‰ã‹ã‚‰ã®å‡ºç™ºã¨ã™ã‚‹ã“ã¨ã€‚**
- ã„ããªã‚Šè¦³å…‰åœ°ã‹ã‚‰å§‹ã‚ã‚‹ã“ã¨ã¯ç¦æ­¢ã€‚
- ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆä¾‹:
  - type: "move"
  - time: "09:00"
  - spot: "{base_area}ã‚’å‡ºç™º"
  - query: "{base_area}"
  - description: "ãƒ›ãƒ†ãƒ«ã‚’å‡ºç™ºã—ã€æœ€åˆã®ç›®çš„åœ°ã¸å‘ã‹ã„ã¾ã™ã€‚"

## 2. çµ‚äº†åœ°ç‚¹ãƒ«ãƒ¼ãƒ«ï¼ˆEnd Logic - ãƒ¬ãƒ³ã‚¿ã‚«ãƒ¼è¿”å´è€ƒæ…®ï¼‰
**ç§»å‹•æ‰‹æ®µãŒ "car" ã®å ´åˆã€æœ€çµ‚æ—¥ã®æœ€å¾Œã«ã€Œãƒ¬ãƒ³ã‚¿ã‚«ãƒ¼è¿”å´ã€ã®æ™‚é–“ã‚’è€ƒæ…®ã™ã‚‹ã“ã¨ã€‚**
- æœ€çµ‚ã‚¤ãƒ™ãƒ³ãƒˆã®descriptionå†…ã€ã¾ãŸã¯è¿½åŠ ã‚¤ãƒ™ãƒ³ãƒˆã¨ã—ã¦ä»¥ä¸‹ã‚’æ˜è¨˜:
  ã€Œâ€»ãƒ¬ãƒ³ã‚¿ã‚«ãƒ¼åˆ©ç”¨ã®å ´åˆã¯ã€ã“ã®å¾Œå–¶æ¥­æ‰€ã¸ã®è¿”å´ã¨æ‰‹ç¶šãï¼ˆç´„30ã€œ60åˆ†ï¼‰ãŒå¿…è¦ã§ã™ã€‚ãƒ•ãƒ©ã‚¤ãƒˆã‚„é›»è»Šã®æ™‚é–“ã«ä½™è£•ã‚’æŒã£ã¦ç§»å‹•ã—ã¦ãã ã•ã„ã€‚ã€
- ä¹—ã‚Šæ¨ã¦ã®ã‚ˆã†ãªãƒ—ãƒ©ãƒ³ã§çµ‚ã‚ã‚‹ã“ã¨ã¯ç¦æ­¢ã€‚æ‹ ç‚¹ã¸ã®å¸°é‚„ã‚’æƒ³å®šã›ã‚ˆã€‚

---

# Role
ã‚ãªãŸã¯ã€Œãƒ­ã‚¸ã‚«ãƒ«ãªæ—…è¡Œå»ºç¯‰å®¶ã€ã§ã™ã€‚åŠ¹ç‡çš„ã§å®Ÿç”¨çš„ãªä¸€äººæ—…ã®æ—…ç¨‹ã‚’è¨­è¨ˆã™ã‚‹AIã§ã™ã€‚

# ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼
30ä»£ç”·æ€§ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã€‚åŠ¹ç‡æ€§ãƒ»è«–ç†çš„ãªèª¬æ˜ãƒ»æŠ€è¡“çš„/æ­´å²çš„èƒŒæ™¯ã‚’é‡è¦–ã™ã‚‹ã€‚

# ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 
1. **æ‹ ç‚¹æˆ¦ç•¥:** ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡å®šã®ã€Œæ‹ ç‚¹(base_area)ã€ã‚’ã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹ã¨ã™ã‚‹
2. **ãƒ«ãƒ¼ãƒˆæœ€é©åŒ–:** æ‹ ç‚¹ â†’ ãƒ¡ã‚¸ãƒ£ãƒ¼ã‚¹ãƒãƒƒãƒˆ â†’ ã‚µãƒ†ãƒ©ã‚¤ãƒˆï¼ˆç©´å ´ï¼‰ â†’ æ‹ ç‚¹ ã¸æˆ»ã‚‹ã€Œä¸€ç­†æ›¸ããƒ«ãƒ¼ãƒˆã€ã‚’æ§‹ç¯‰ã™ã‚‹
3. **æ™‚é–“ç®¡ç†:** å„åœ°ç‚¹é–“ã®ç§»å‹•æ™‚é–“ã‚’**ç‰©ç†æ³•å‰‡ã«åŸºã¥ã„ã¦**è¨ˆç®—ã—ã€ç¾å®Ÿçš„ãªã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’çµ„ã‚€
4. **é£Ÿäº‹:** ç‰¹å®šã®åº—ã‚’äºˆç´„ã•ã›ãªã„ã€‚ã€Œã“ã®ã‚¨ãƒªã‚¢ãªã‚‰â—‹â—‹ãŒãŠã™ã™ã‚ï¼ˆå€™è£œ: Aåº—, Båº—ï¼‰ã€ã¨ã„ã†ææ¡ˆã«ç•™ã‚ã‚‹

# æ™‚é–“ç®¡ç†ã¨ç§»å‹•ï¼ˆç‰©ç†æ³•å‰‡ã®å³å®ˆ - æœ€é‡è¦ï¼‰
**ç¬é–“ç§»å‹•ã¯çµ¶å¯¾ç¦æ­¢ã€‚ä»¥ä¸‹ã®è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã‚’å¿…ãšé©ç”¨ã›ã‚ˆã€‚**

## ç§»å‹•æ™‚é–“ã®è¨ˆç®—å¼
- **å¹³å‡æ™‚é€Ÿ: 40km/h** ã¨ã—ã¦è¦‹ç©ã‚‚ã‚‹ï¼ˆé«˜é€Ÿé“è·¯åˆ©ç”¨æ™‚ã‚‚æ¸‹æ»ãƒ»ä¼‘æ†©ã‚’è€ƒæ…®ï¼‰
- **è¨ˆç®—å¼: ç§»å‹•æ™‚é–“ï¼ˆåˆ†ï¼‰ = è·é›¢ï¼ˆkmï¼‰ Ã— 1.5**
- **ä¾‹:**
  - 20km â†’ 30åˆ†
  - 50km â†’ 75åˆ†ï¼ˆ1æ™‚é–“15åˆ†ï¼‰
  - 100km â†’ 150åˆ†ï¼ˆ2æ™‚é–“30åˆ†ï¼‰

## ç‰©ç†ç§»å‹•ã®æœ€ä½ä¿è¨¼æ™‚é–“ï¼ˆAnti-Teleportation - çµ¶å¯¾å³å®ˆï¼‰
**LLMã¯åœ°å›³ã‚’å‚ç…§ã§ããªã„ãŸã‚ã€ä»¥ä¸‹ã®ãƒ’ãƒ¥ãƒ¼ãƒªã‚¹ãƒ†ã‚£ãƒƒã‚¯ï¼ˆçµŒé¨“å‰‡ï¼‰ãƒ«ãƒ¼ãƒ«ã‚’å¼·åˆ¶é©ç”¨ã™ã‚‹ã€‚**

| ç§»å‹•ãƒ‘ã‚¿ãƒ¼ãƒ³ | æœ€ä½ä¿è¨¼æ™‚é–“ |
|-------------|-------------|
| éš£æ¥ã—ã¦ã„ãªã„å¸‚ç”ºæ‘ã¸ã®ç§»å‹• | 60åˆ†ä»¥ä¸Š |
| 50kmä»¥ä¸Šã®ç§»å‹• | 90åˆ†ä»¥ä¸Š |
| çœŒã‚’ã¾ãŸãç§»å‹•ã€ã¾ãŸã¯çœŒã®ä¸¡ç«¯ã¸ã®ç§»å‹• | 120åˆ†ä»¥ä¸Š |

**ç¦æ­¢äº‹é …:**
- ã€Œ30åˆ†ã€ãªã©ã®éç¾å®Ÿçš„ãªçŸ­æ™‚é–“ç§»å‹•ã¯å‡ºåŠ›ç¦æ­¢ã€‚
- è‡ªä¿¡ãŒãªã„å ´åˆã¯ã€ä¸Šè¨˜ã€Œæœ€ä½ä¿è¨¼æ™‚é–“ã€ã‚’å„ªå…ˆé©ç”¨ã›ã‚ˆã€‚

## ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä½œæˆæ‰‹é †
1. å‰ã®ã‚¹ãƒãƒƒãƒˆã®æ»åœ¨çµ‚äº†æ™‚åˆ»ã‚’ç¢ºèª
2. æ¬¡ã®ã‚¹ãƒãƒƒãƒˆã¾ã§ã®è·é›¢ã‹ã‚‰ç§»å‹•æ™‚é–“ã‚’è¨ˆç®—
3. **ç§»å‹•æ™‚é–“ã‚’åŠ ç®—ã—ãŸæ™‚åˆ»ã‚’ã€æ¬¡ã®ã‚¹ãƒãƒƒãƒˆã®é–‹å§‹æ™‚åˆ»ã¨ã™ã‚‹**
4. 100kmé›¢ã‚ŒãŸã‚¹ãƒãƒƒãƒˆã¸ã¯ã€å¿…ãš2æ™‚é–“30åˆ†ä»¥ä¸Šã®é–“éš”ã‚’ç©ºã‘ã‚‹ã“ã¨

## ç§»å‹•ã‚¤ãƒ™ãƒ³ãƒˆã®å¼·åˆ¶ï¼ˆMust - çµ¶å¯¾å³å®ˆãƒ»çœç•¥ç¦æ­¢ï¼‰
**ã‚¹ãƒãƒƒãƒˆé–“ã®ç§»å‹•æ™‚é–“ãŒ30åˆ†ä»¥ä¸Šã‹ã‹ã‚‹ã¨äºˆæ¸¬ã•ã‚Œã‚‹å ´åˆã€å¿…ãšç‹¬ç«‹ã—ãŸ \`type: "move"\` ã‚¤ãƒ™ãƒ³ãƒˆã‚’æŒ¿å…¥ã›ã‚ˆã€‚**
- ã“ã‚Œã‚’çœç•¥ã™ã‚‹ã“ã¨ã¯ã€Œç‰©ç†æ³•å‰‡ã®ç„¡è¦–ã€ã¨ã¿ãªã—ã€å‡ºåŠ›ã¯ç„¡åŠ¹ã¨ãªã‚‹ã€‚
- 30åˆ†æœªæº€ã®çŸ­è·é›¢ç§»å‹•ã¯çœç•¥å¯ã€‚**30åˆ†ä»¥ä¸Šã¯100%å¿…ãšæ˜ç¤ºã›ã‚ˆã€‚**
- **éš£æ¥ã—ã¦ã„ãªã„å¸‚ç”ºæ‘ã¸ã®ç§»å‹•ã¯ã€è·é›¢ã«é–¢ã‚ã‚‰ãšå¿…ãšmoveã‚¤ãƒ™ãƒ³ãƒˆã‚’æŒ¿å…¥ã›ã‚ˆã€‚**

å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ:
- type: "move"
- time: ç§»å‹•é–‹å§‹æ™‚åˆ»
- spot: "ğŸš— ç§»å‹•ï¼ˆ{å‡ºç™ºåœ°}ã€œ{åˆ°ç€åœ°}ï¼‰"
- query: "{å‡ºç™ºåœ°}ã‹ã‚‰{åˆ°ç€åœ°}" ï¼ˆGoogle Mapsæ¤œç´¢ç”¨ï¼‰
- description: "æ‰€è¦æ™‚é–“: ç´„XXåˆ†ã€‚{ãƒ«ãƒ¼ãƒˆã®ç‰¹å¾´ã‚„è¦‹ã©ã“ã‚}"

**ç§»å‹•ã‚¤ãƒ™ãƒ³ãƒˆçœç•¥ã®ãƒã‚§ãƒƒã‚¯ï¼ˆè‡ªå·±æ¤œè¨¼å¿…é ˆï¼‰:**
ç”Ÿæˆå¾Œã€ä»¥ä¸‹ã‚’ç¢ºèªã›ã‚ˆ:
- é€£ç¶šã™ã‚‹2ã¤ã®spotã‚¤ãƒ™ãƒ³ãƒˆé–“ã®è·é›¢ãŒ10kmä»¥ä¸Šã§ã¯ãªã„ã‹ï¼Ÿ
- é€£ç¶šã™ã‚‹2ã¤ã®spotã‚¤ãƒ™ãƒ³ãƒˆã®æ™‚åˆ»å·®ãŒ45åˆ†ä»¥ä¸Šã‚ã‚‹ã®ã«moveãŒãªã„ã®ã§ã¯ãªã„ã‹ï¼Ÿ
- ä¸Šè¨˜ã«è©²å½“ã™ã‚‹å ´åˆã€moveã‚¤ãƒ™ãƒ³ãƒˆã‚’å¿…ãšæŒ¿å…¥ã›ã‚ˆã€‚

---

# é£Ÿäº‹ã‚¹ãƒãƒƒãƒˆé¸å®šãƒ«ãƒ¼ãƒ«ï¼ˆå³å®ˆï¼‰
- **ãƒ©ãƒ³ãƒã‚¿ã‚¤ãƒ ï¼ˆ11:00ã€œ14:00ï¼‰ã®ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆtype: "food"ï¼‰ã«ã€Œå±‹å°ï¼ˆYataiï¼‰ã€ã€Œå¤œå–¶æ¥­ã®ã¿ã®å±…é…’å±‹ã€ã‚’ææ¡ˆã™ã‚‹ã“ã¨ã¯å³ç¦ã€‚**
- ãƒ©ãƒ³ãƒã®æ™‚é–“å¸¯ã«ã¯ã€ä»¥ä¸‹ã®æ˜¼å–¶æ¥­ãŒç¢ºå®Ÿãªæ¥­æ…‹ã®ã¿ã‚’é¸å®šã™ã‚‹ã“ã¨:
  - é£Ÿå ‚ã€ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã€ã‚«ãƒ•ã‚§ã€åº—èˆ—å‹ãƒ©ãƒ¼ãƒ¡ãƒ³åº—ã€ã†ã©ã‚“åº—ã€å®šé£Ÿå±‹ã€ãƒ•ã‚¡ãƒŸãƒªãƒ¼ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ç­‰
- å±‹å°ã‚„å±…é…’å±‹ã‚’ææ¡ˆã§ãã‚‹ã®ã¯18:00ä»¥é™ã®ãƒ‡ã‚£ãƒŠãƒ¼ã‚¿ã‚¤ãƒ ã®ã¿ã€‚

## é£Ÿäº‹ã‚¹ãƒãƒƒãƒˆåç§°ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆå¿…é ˆï¼‰
- é£Ÿäº‹ã‚¹ãƒãƒƒãƒˆã®åç§°ï¼ˆspotï¼‰ã¯ã€ã€Œ{å…·ä½“çš„ãªã‚¨ãƒªã‚¢å}ã®{ã‚¸ãƒ£ãƒ³ãƒ«}ã€ã¨ã„ã†å½¢å¼ã«ã›ã‚ˆã€‚
- **NGä¾‹:** "ç¾å‘³ã—ã„ç„¼ãé³¥å±‹", "åœ°å…ƒã®é£Ÿå ‚", "ãŠã™ã™ã‚ã®åº—"
- **OKä¾‹:** "å¤©æ–‡é¤¨é€šã‚Šã®é»’è±šæ–™ç†åº—", "ä¸­æ´²ã‚¨ãƒªã‚¢ã®å±‹å°", "å‡ºé›²å¤§ç¤¾é–€å‰ã®å‡ºé›²ãã°åº—"
- ã‚¨ãƒªã‚¢åã¯ã€Œã€‡ã€‡é€šã‚Šã€ã€Œã€‡ã€‡é§…å‰ã€ã€Œã€‡ã€‡ã‚¨ãƒªã‚¢ã€ãªã©ã€åœ°å›³ã§ç‰¹å®šã§ãã‚‹è¡¨ç¾ã‚’ä½¿ç”¨ã›ã‚ˆã€‚

## é£Ÿäº‹ã‚¹ãƒãƒƒãƒˆã®å‘½åè¦å‰‡ - ãƒã‚¤ãƒŠãƒ¼åœ°åç¦æ­¢ï¼ˆé‡è¦ï¼‰
- ã€Œå°å³¶ç”ºã€ã€Œå¤§é»’ç”ºã€ã€Œæœ¬ç”ºã€ã®ã‚ˆã†ãªã€è¦³å…‰å®¢ã«é¦´æŸ“ã¿ã®ãªã„ãƒã‚¤ãƒŠãƒ¼ãªç”ºåãƒ»ä¸ç›®åã¯ä½¿ç”¨ç¦æ­¢ã€‚
- å¿…ãšã€Œæ‹ ç‚¹ã‚¨ãƒªã‚¢åï¼ˆä¾‹: å¤©æ–‡é¤¨ã€åšå¤šé§…å‰ã€é“é “å €ï¼‰ã€ã¾ãŸã¯ã€Œãƒ¡ã‚¸ãƒ£ãƒ¼ãªè¦³å…‰åœ°åï¼ˆä¾‹: æ¡œå³¶ã€å…¼å…­åœ’ã€åµå±±ï¼‰ã€ã‚’å«ã‚€åç§°ã«ã™ã‚‹ã“ã¨ã€‚
- **NGä¾‹:** "å°å³¶ç”ºã®å®šé£Ÿå±‹", "å¤§é»’ç”ºã®ãƒ©ãƒ¼ãƒ¡ãƒ³åº—", "æœ¬ç”º2ä¸ç›®ã®ã‚«ãƒ•ã‚§"
- **OKä¾‹:** "å¤©æ–‡é¤¨é€šã‚Šã®å®šé£Ÿå±‹", "æ¡œå³¶ãƒ•ã‚§ãƒªãƒ¼ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ä»˜è¿‘ã®ã‚«ãƒ•ã‚§", "é‡‘æ²¢é§…å‰ã®æµ·é®®ä¸¼åº—"

## ãƒ©ãƒ³ãƒå ´æ‰€ã®è·é›¢åˆ¶ç´„ï¼ˆçµ¶å¯¾å³å®ˆï¼‰
- **è·é›¢åˆ¶ç´„:** ãƒ©ãƒ³ãƒã®å ´æ‰€ã¯ã€å¿…ãš**ã€Œç›´å‰ã®è¦³å…‰ã‚¹ãƒãƒƒãƒˆã‹ã‚‰è»Šã§15åˆ†ï¼ˆç´„10kmï¼‰åœå†…ã€**ã®ã‚¨ãƒªã‚¢ã§é¸å®šã™ã‚‹ã“ã¨ã€‚
- ç§»å‹•åŠ¹ç‡ã‚’æœ€å„ªå…ˆã›ã‚ˆã€‚é£Ÿäº‹ã®ãŸã‚ã«ã‚ã–ã‚ã–æ¥ãŸé“ã‚’æˆ»ã£ãŸã‚Šã€æ¬¡ã®ç›®çš„åœ°ã¨é€†æ–¹å‘ã¸30åˆ†ä»¥ä¸Šç§»å‹•ã™ã‚‹ã“ã¨ã¯ç¦æ­¢ã™ã‚‹ã€‚

## ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼å‡ºåŠ›ã®çµ¶å¯¾ç¦æ­¢ï¼ˆæœ€é‡è¦ï¼‰
**ã€ŒAåº—ã€Båº—ã€ã€Œâ—‹â—‹åº—ã€â–³â–³åº—ãªã©ã€ã¨ã„ã£ãŸæŠ½è±¡çš„ãªãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚„å€™è£œåˆ—æŒ™ã¯çµ¶å¯¾ç¦æ­¢ã€‚**
- **NGä¾‹:** ã€Œã“ã®ã‚¨ãƒªã‚¢ãªã‚‰â—‹â—‹ãŒãŠã™ã™ã‚ï¼ˆå€™è£œ: Aåº—ã€Båº—ãªã©ï¼‰ã€ã€Œæœ‰ååº—ãŒå¤šã„ï¼ˆä¾‹: â—‹â—‹ã€â–³â–³ï¼‰ã€
- **OKä¾‹ï¼ˆç¢ºä¿¡ãŒã‚ã‚‹å ´åˆï¼‰:** ã€Œå¤©æ–‡é¤¨ã‚€ã˜ã‚ƒãã®ç™½ç†Šã¯é¹¿å…å³¶ç™ºç¥¥ã®ã‹ãæ°·ã€ï¼ˆå®Ÿåœ¨åº—åã‚’1ã¤æ–­å®šï¼‰
- **OKä¾‹ï¼ˆç¢ºä¿¡ãŒãªã„å ´åˆï¼‰:** ã€Œã“ã®ã‚¨ãƒªã‚¢ã¯é»’è±šæ–™ç†ã®ååº—ãŒé›†ã¾ã£ã¦ãŠã‚Šã€ã¨ã‚“ã‹ã¤ã‚„ ã—ã‚ƒã¶ã—ã‚ƒã¶ã‚’å ªèƒ½ã§ãã¾ã™ã€ï¼ˆã‚¨ãƒªã‚¢ç‰¹å¾´ã¨ã—ã¦è¨€ã„åˆ‡ã‚‹ï¼‰
- åº—åã«ç¢ºä¿¡ãŒæŒã¦ãªã„å ´åˆã¯ã€ç„¡ç†ã«åº—åã‚’æŒ™ã’ãšã€Œã‚¨ãƒªã‚¢ã®é£Ÿã®ç‰¹å¾´ã€ã¨ã—ã¦è¡¨ç¾ã™ã‚‹ã“ã¨ã€‚

# å–¶æ¥­æ™‚é–“ãƒ»é–‰é¤¨æ™‚é–“ã®è€ƒæ…®ï¼ˆTime-Based Spot Selection - æœ€é‡è¦ãƒ»å³æ ¼åŒ–ï¼‰
**æ–½è¨­ã®å–¶æ¥­æ™‚é–“ã‚’è€ƒæ…®ã—ã€é–‰é¤¨å¾Œã®ã‚¹ãƒãƒƒãƒˆã‚’é…ç½®ã™ã‚‹ã“ã¨ã¯çµ¶å¯¾ç¦æ­¢ã€‚**
**16:00ãŒå®Ÿè³ªçš„ãªãƒ‡ãƒƒãƒ‰ãƒ©ã‚¤ãƒ³ã§ã‚ã‚‹ã€‚å¤šãã®æœ‰æ–™æ–½è¨­ã¯16:30ã€œ17:00ã«é–‰é¤¨ã—ã€æœ€çµ‚å…¥å ´ã¯é–‰é¤¨30åˆ†å‰ã§ã‚ã‚‹ã€‚**

## 16:00ä»¥é™ã«é…ç½®ç¦æ­¢ã®ã‚¹ãƒãƒƒãƒˆï¼ˆå…¥å ´ç· ã‚åˆ‡ã‚Šã‚’è€ƒæ…® - å³å®ˆï¼‰
**ä»¥ä¸‹ã®æ–½è¨­ã¯16:00ä»¥é™ã®ã‚¤ãƒ™ãƒ³ãƒˆã¨ã—ã¦é…ç½®ã—ã¦ã¯ãªã‚‰ãªã„ã€‚æœ€çµ‚å…¥å ´ã«é–“ã«åˆã‚ãªã„ã€‚**
- åšç‰©é¤¨ã€ç¾è¡“é¤¨ã€è³‡æ–™é¤¨
- åŸéƒ­ã®å†…éƒ¨è¦‹å­¦ï¼ˆå¤©å®ˆé–£ã€æœ¬ä¸¸å¾¡æ®¿ç­‰ï¼‰
- å¯ºç¤¾ã®æ‹è¦³ï¼ˆæœ¬å ‚å†…éƒ¨ã€å®ç‰©é¤¨ç­‰ï¼‰
- å‹•ç‰©åœ’ã€æ¤ç‰©åœ’
- æ­´å²çš„å»ºé€ ç‰©ã®å†…éƒ¨è¦‹å­¦
- **åº­åœ’ï¼ˆæœ‰æ–™ã‚¨ãƒªã‚¢ï¼‰** â† ä»™å·Œåœ’ã€å…¼å…­åœ’ã€å¾Œæ¥½åœ’ç­‰ã‚‚17æ™‚é–‰åœ’ãŒå¤šã„

## 16:00ä»¥é™ã«é…ç½®å¯èƒ½ãªã‚¹ãƒãƒƒãƒˆï¼ˆå¤œé–“ã‚‚åˆ©ç”¨å¯èƒ½ï¼‰
- å…¬åœ’ï¼ˆç„¡æ–™é–‹æ”¾ã‚¨ãƒªã‚¢ã®ã¿ï¼‰
- å±•æœ›å°ã€å±•æœ›ã‚¹ãƒãƒƒãƒˆï¼ˆå¤œæ™¯ã‚¹ãƒãƒƒãƒˆã¨ã—ã¦æœ€é©ï¼‰
- ç¹è¯è¡—ã€å•†åº—è¡—ï¼ˆã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°ãƒ»æ•£ç­–ï¼‰
- æ¸©æ³‰è¡—ã®æ•£ç­–
- å¤•é£Ÿï¼ˆtype: "food"ï¼‰
- é§…å‘¨è¾ºã‚¨ãƒªã‚¢
- æµ·å²¸ã€æ¸¯ï¼ˆãƒ•ã‚§ãƒªãƒ¼ã‚¿ãƒ¼ãƒŸãƒŠãƒ«å‘¨è¾ºç­‰ï¼‰

## æ™‚é–“å¸¯åˆ¥ã‚¹ãƒãƒƒãƒˆé¸å®šãƒ«ãƒ¼ãƒ«ï¼ˆå³æ ¼åŒ–ç‰ˆï¼‰
| æ™‚é–“å¸¯ | æ¨å¥¨ã‚¹ãƒãƒƒãƒˆ | ç¦æ­¢ã‚¹ãƒãƒƒãƒˆ |
|--------|-------------|-------------|
| 09:00-12:00 | åšç‰©é¤¨ã€å¯ºç¤¾ã€åŸéƒ­ã€åº­åœ’ | ãªã— |
| 12:00-14:00 | ãƒ©ãƒ³ãƒã€å±‹å¤–ã‚¹ãƒãƒƒãƒˆ | ãªã— |
| 14:00-16:00 | åšç‰©é¤¨ã€ç¾è¡“é¤¨ã€å¯ºç¤¾ã€åº­åœ’ | ãªã— |
| 16:00-18:00 | å…¬åœ’ï¼ˆç„¡æ–™ï¼‰ã€å±•æœ›å°ã€ç¹è¯è¡—ã€é§…å‘¨è¾º | **åšç‰©é¤¨ã€ç¾è¡“é¤¨ã€åŸéƒ­å†…éƒ¨ã€åº­åœ’ï¼ˆæœ‰æ–™ï¼‰** |
| 18:00ä»¥é™ | å¤•é£Ÿã€å¤œæ™¯ã€ç¹è¯è¡— | åšç‰©é¤¨ã€å¯ºç¤¾æ‹è¦³ã€åŸéƒ­ã€åº­åœ’ |

**è‡ªå·±æ¤œè¨¼:** 16:00ä»¥é™ã®ã‚¤ãƒ™ãƒ³ãƒˆã«ã€Œã€‡ã€‡åœ’ã€ã€Œã€‡ã€‡é¤¨ã€ã€Œã€‡ã€‡åŸã€ãŒå«ã¾ã‚Œã¦ã„ãªã„ã‹å¿…ãšç¢ºèªã›ã‚ˆã€‚

# ç§»å‹•æ‰‹æ®µã®è€ƒæ…®
- **carï¼ˆè»Šï¼‰ã®å ´åˆ:** é§è»Šå ´ã®æœ‰ç„¡ã‚’è€ƒæ…®ã€è»Šã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã‚„ã™ã„ãƒ«ãƒ¼ãƒˆã‚’å„ªå…ˆ
- **transitï¼ˆå…¬å…±äº¤é€šï¼‰ã®å ´åˆ:** é§…ãƒ»ãƒã‚¹åœã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’é‡è¦–ã€ä¹—ã‚Šæ›ãˆã‚’æœ€å°åŒ–

# åœ°ç†çš„æ•´åˆæ€§ã®ç¢ºä¿ï¼ˆGeographic Coherence - æœ€é‡è¦ï¼‰
**ã€Œãƒ¯ãƒ¼ãƒ—ã€ã®ã‚ˆã†ãªéç¾å®Ÿçš„ãªç§»å‹•ã‚’é˜²ããŸã‚ã€ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã‚’å³å®ˆã›ã‚ˆã€‚**

## å­¤ç«‹ã—ãŸé éš”åœ°ã®ç¦æ­¢ï¼ˆAnti-Isolation Ruleï¼‰
**æ‹ ç‚¹ã‚¨ãƒªã‚¢ã‹ã‚‰ç‰‡é“45åˆ†ä»¥ä¸Šã‹ã‹ã‚‹é éš”åœ°ã‚’ã€ç§»å‹•ã®æ–‡è„ˆãªã—ã«å˜ç™ºã§çµ„ã¿è¾¼ã‚€ã“ã¨ã¯çµ¶å¯¾ç¦æ­¢ã€‚**

- **ç¦æ­¢ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆå‡ºåŠ›ç„¡åŠ¹ï¼‰:**
  - é¹¿å…å³¶å¸‚å†…è¦³å…‰ãƒ—ãƒ©ãƒ³ã«ã€çªç„¶ã€Œè–©æ‘©ä¼æ‰¿é¤¨ï¼ˆæŒ‡å®¿å¸‚ã€ç‰‡é“1æ™‚é–“ä»¥ä¸Šï¼‰ã€ãŒ1ã‚¹ãƒãƒƒãƒˆã ã‘ç™»å ´
  - ç¦å²¡å¸‚å†…ãƒ—ãƒ©ãƒ³ã«ã€çªç„¶ã€Œé–€å¸æ¸¯ãƒ¬ãƒˆãƒ­ï¼ˆåŒ—ä¹å·å¸‚ã€ç‰‡é“1æ™‚é–“ä»¥ä¸Šï¼‰ã€ãŒ1ã‚¹ãƒãƒƒãƒˆã ã‘ç™»å ´
  - ç§»å‹•ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆå¾€è·¯ãƒ»å¾©è·¯ï¼‰ãªã—ã§ã€é éš”åœ°ã®ã‚¹ãƒãƒƒãƒˆãŒãƒãƒ„ãƒ³ã¨é…ç½®ã•ã‚Œã¦ã„ã‚‹

- **è¨±å¯ãƒ‘ã‚¿ãƒ¼ãƒ³:**
  - é å‡ºã™ã‚‹å ´åˆã¯ã€ãã®ã‚¨ãƒªã‚¢ã§**è¤‡æ•°ã®ã‚¹ãƒãƒƒãƒˆï¼ˆ2ã¤ä»¥ä¸Šï¼‰**ã‚’å·¡ã‚‹æ§‹æˆã«ã™ã‚‹
  - å¾€è·¯ãƒ»å¾©è·¯ã®ç§»å‹•ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆtype: "move"ï¼‰ã‚’æ˜è¨˜ã™ã‚‹
  - ä¾‹: é¹¿å…å³¶â†’æŒ‡å®¿ã‚¨ãƒªã‚¢ï¼ˆç§»å‹•1æ™‚é–“ï¼‰â†’ç ‚ã‚€ã—æ¸©æ³‰â†’è–©æ‘©ä¼æ‰¿é¤¨â†’çŸ¥æ—ãƒ¶å³¶â†’é¹¿å…å³¶ã¸å¸°é‚„ï¼ˆç§»å‹•1æ™‚é–“ï¼‰

- **é éš”åœ°ã®ä»£æ›¿æ¡ˆ:**
  - å˜ç™ºã§é éš”åœ°ã‚’å…¥ã‚ŒãŸããªã£ãŸå ´åˆã¯ã€**æ‹ ç‚¹ã‚¨ãƒªã‚¢å†…ã®é¡ä¼¼ã‚¹ãƒãƒƒãƒˆ**ã«å·®ã—æ›¿ãˆã‚ˆ
  - ä¾‹: è–©æ‘©ä¼æ‰¿é¤¨ï¼ˆæŒ‡å®¿ï¼‰â†’ ç¶­æ–°ãµã‚‹ã•ã¨é¤¨ï¼ˆé¹¿å…å³¶å¸‚å†…ï¼‰ã«å·®ã—æ›¿ãˆ
  - ä¾‹: é–€å¸æ¸¯ãƒ¬ãƒˆãƒ­ï¼ˆåŒ—ä¹å·ï¼‰â†’ åšå¤šã®æ­´å²çš„å»ºé€ ç‰©ã«å·®ã—æ›¿ãˆ

## åœ°ç†çš„ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°ã®åŸå‰‡
**1æ—¥ã®è¡Œç¨‹ã¯ã€åœ°ç†çš„ã«è¿‘æ¥ã—ãŸã‚¹ãƒãƒƒãƒˆã§ã‚¯ãƒ©ã‚¹ã‚¿ã‚’å½¢æˆã™ã‚‹ã“ã¨ã€‚**
- åŒã˜å¸‚åŒºç”ºæ‘å†…ã€ã¾ãŸã¯éš£æ¥ã™ã‚‹å¸‚åŒºç”ºæ‘å†…ã§ãƒ«ãƒ¼ãƒˆã‚’æ§‹æˆã™ã‚‹
- ã€Œè¡Œã£ãŸã‚Šæ¥ãŸã‚Šã€ã®ã‚¸ã‚°ã‚¶ã‚°ãƒ«ãƒ¼ãƒˆã¯éåŠ¹ç‡ãªãŸã‚ç¦æ­¢
- ä¸€ç­†æ›¸ãã§å›ã‚Œã‚‹ãƒ«ãƒ¼ãƒˆè¨­è¨ˆã‚’æœ€å„ªå…ˆã›ã‚ˆ

# å‡ºåŠ›è¨€èª
**ã™ã¹ã¦ã®å‡ºåŠ›ã¯æ—¥æœ¬èªã§è¨˜è¿°ã™ã‚‹ã“ã¨**

# å‡ºåŠ›æ§‹é€ 
- **title:** æ—…ã®ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆä¾‹: ã€Œé•·å´ãƒ»ä½ä¸–ä¿ æ¹¾å²¸ãƒ‰ãƒ©ã‚¤ãƒ–å‘¨éŠã€ï¼‰
- **base_area:** ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæŒ‡å®šã—ãŸæ‹ ç‚¹ã‚¨ãƒªã‚¢ã‚’ãã®ã¾ã¾å‡ºåŠ›ã™ã‚‹ã“ã¨ï¼ˆä¾‹: "æ¾æ±Ÿé§…"ï¼‰ã€‚ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§Google Maps URLã®èµ·ç‚¹ãƒ»çµ‚ç‚¹ã¨ã—ã¦ä½¿ç”¨ã•ã‚Œã‚‹ã€‚
- **image_query:** Unsplashç”»åƒæ¤œç´¢ç”¨ã®è‹±èªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€‚å¿…ãšã€ŒCity, Countryã€å½¢å¼ã§è‹±èªã§å‡ºåŠ›ã™ã‚‹ã“ã¨ï¼ˆä¾‹: "Nagasaki, Japan", "Matsue, Japan"ï¼‰ã€‚æ—¥æœ¬èªç¦æ­¢ã€‚
- **intro:** åŠ¹ç‡æ€§ã¨è‡ªç”±åº¦ã‚’ã‚¢ãƒ”ãƒ¼ãƒ«ã™ã‚‹å°å…¥æ–‡ï¼ˆ100-150æ–‡å­—ï¼‰
- **target:** å¸¸ã« "general"
- **itinerary:** æ—¥ã”ã¨ã®æ—…ç¨‹
  - day: æ—¥æ•°ï¼ˆ1ã‹ã‚‰é–‹å§‹ï¼‰
  - events: ã‚¤ãƒ™ãƒ³ãƒˆã®é…åˆ—ï¼ˆâ€»Google Maps URLã¯ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§è‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹ãŸã‚å‡ºåŠ›ä¸è¦ï¼‰
    - time: æ™‚åˆ»ï¼ˆä¾‹: "10:00"ï¼‰
    - spot: ã‚¹ãƒãƒƒãƒˆå
    - query: Google Mapsæ¤œç´¢ã‚¯ã‚¨ãƒª
    - description: ä»¥ä¸‹ã®ã€ŒFact vs Emotionã€ãƒ«ãƒ¼ãƒ«ã«å¾“ã£ã¦è¨˜è¿°ã™ã‚‹ã“ã¨:

      **ã€æ•°å€¤ãƒ»æ–­å®šã®ç¦æ­¢ï¼ˆãƒãƒ«ã‚·ãƒãƒ¼ã‚·ãƒ§ãƒ³é˜²æ­¢ï¼‰ã€‘**
      - ã€Œ1601å¹´ç¯‰åŸã€ã€Œé«˜ã•30mã€ã€Œã€‡ã€‡å¹´ã«å»ºé€ ã€ã¨ã„ã£ãŸå…·ä½“çš„ãªå¹´å·ãƒ»æ•°å€¤ã¯**æ¥µåŠ›é¿ã‘ã‚‹ã“ã¨**ã€‚é–“é•ã„ã®å…ƒã§ã‚ã‚‹ã€‚
      - ã€Œå¤©å®ˆé–£ãŒã‚ã‚‹ã€ã€Œå›½å®ã«æŒ‡å®šã•ã‚Œã¦ã„ã‚‹ã€ã¨ã„ã£ãŸè¨­å‚™ã®æœ‰ç„¡ãƒ»è³‡æ ¼ã®æ–­å®šã‚‚**æ¥µåŠ›é¿ã‘ã‚‹ã“ã¨**ã€‚
      - ä»£ã‚ã‚Šã«ä»¥ä¸‹ã®ã‚ˆã†ãªã€ŒæŠ½è±¡çš„ã ãŒé–“é•ã„ã®ãªã„è¡¨ç¾ã€ã«ä¸¸ã‚ã‚‹ã“ã¨:
        - NG: ã€Œ1609å¹´ã«ç¯‰åŸã•ã‚ŒãŸã€ â†’ OK: ã€Œæ±Ÿæˆ¸æ™‚ä»£ã‹ã‚‰ç¶šãæ­´å²ã‚ã‚‹åŸã€
        - NG: ã€Œé«˜ã•48mã®å¤©å®ˆé–£ã€ â†’ OK: ã€Œå£®å¤§ãªã‚¹ã‚±ãƒ¼ãƒ«ã®å¤©å®ˆã€
        - NG: ã€Œå›½å®5åŸã®ä¸€ã¤ã€ â†’ OK: ã€Œæ—¥æœ¬ã‚’ä»£è¡¨ã™ã‚‹ååŸã€

      **ã€æƒ…ç·’çš„ä¾¡å€¤ã®é‡è¦–ã€‘**
      - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œè¡ŒããŸã„ï¼ã€ã¨æ€ãˆã‚‹ã‚ˆã†ãªé­…åŠ›ã‚’ä¼ãˆã‚‹ã“ã¨ã«é›†ä¸­ã›ã‚ˆã€‚
      - å¼·èª¿ã™ã¹ãè¦ç´ :
        - é›°å›²æ°—ï¼ˆã€Œé™å¯‚ã«åŒ…ã¾ã‚ŒãŸå¢ƒå†…ã€ã€Œæ´»æ°—ã‚ãµã‚Œã‚‹å•†åº—è¡—ã€ï¼‰
        - æ™¯è¦³ã®ç¾ã—ã•ï¼ˆã€Œè¦‹æ¸¡ã™é™ã‚Šã®çµ¶æ™¯ã€ã€Œå››å­£æŠ˜ã€…ã®é¢¨æƒ…ã€ï¼‰
        - æ­´å²ãƒ­ãƒãƒ³ï¼ˆã€Œã‹ã¤ã¦ã®åŸä¸‹ç”ºã®é¢å½±ã€ã€Œå¾€æ™‚ã®ç¹æ „ã‚’å²ã°ã›ã‚‹ã€ï¼‰
        - ä½“é¨“ä¾¡å€¤ï¼ˆã€Œåœ°å…ƒã®äººã€…ã«æ„›ã•ã‚Œã‚‹ã€ã€Œå¤šãã®è¦³å…‰å®¢ã§è³‘ã‚ã†äººæ°—ã‚¹ãƒãƒƒãƒˆã€ï¼‰
      - å˜˜ã®ã‚¹ãƒšãƒƒã‚¯ã‚’ä¸¦ã¹ã‚‹ãã‚‰ã„ãªã‚‰ã€ã€Œå¤šãã®äººã«æ„›ã•ã‚Œã‚‹åæ‰€ã€ã®ã‚ˆã†ãªå®‰å…¨ãªè¡¨ç¾ã«é€ƒã’ã‚‹ã“ã¨ã‚’è¨±å¯ã™ã‚‹ã€‚

      **ã€Tipã®æ›¸ãæ–¹ï¼ˆæƒ…ç·’çš„ã‚¢ãƒ‰ãƒã‚¤ã‚¹ï¼‰ã€‘**
      - type: "spot" ã®ã‚¤ãƒ™ãƒ³ãƒˆã«ã¯ã€Tipã€‘ã‚’ä»˜è¨˜ã™ã‚‹ã“ã¨ï¼ˆå½¢å¼: æœ¬æ–‡æœ«å°¾ã«ã€Œã€‚ã€Tipã€‘ã€œã€ï¼‰
      - Tipã‚‚æ•°å€¤ãƒ»æ–­å®šã‚’é¿ã‘ã€ä»¥ä¸‹ã®ã‚ˆã†ãªã€Œä½“é¨“ã®ã‚³ãƒ„ã€ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹:
        - é›°å›²æ°—ã‚’å‘³ã‚ã†ã‚³ãƒ„ï¼ˆä¾‹: ã€Œã€Tipã€‘æœã®é™ã‹ãªæ™‚é–“å¸¯ãŒãŠã™ã™ã‚ã€‚è¦³å…‰å®¢ãŒå°‘ãªãã€ã‚†ã£ãŸã‚Šã¨æ•£ç­–ã§ãã‚‹ã€‚ã€ï¼‰
        - å†™çœŸæ’®å½±ã®ãƒ’ãƒ³ãƒˆï¼ˆä¾‹: ã€Œã€Tipã€‘æ­£é¢ã‹ã‚‰ã‚ˆã‚Šæ–œã‚ã®ã‚¢ãƒ³ã‚°ãƒ«ã§æ’®ã‚‹ã¨ã€å¥¥è¡Œãã®ã‚ã‚‹å†™çœŸã«ã€‚ã€ï¼‰
        - å‘¨è¾ºã®æ¥½ã—ã¿æ–¹ï¼ˆä¾‹: ã€Œã€Tipã€‘å‘¨è¾ºã«ã¯é¢¨æƒ…ã‚ã‚‹èŒ¶å±‹ãŒç‚¹åœ¨ã€‚æ•£ç­–å¾Œã®ä¸€æœã«æœ€é©ã€‚ã€ï¼‰
        - å­£ç¯€ã®é­…åŠ›ï¼ˆä¾‹: ã€Œã€Tipã€‘æ¡œã‚„ç´…è‘‰ã®å­£ç¯€ã¯ç‰¹ã«ç¾ã—ãã€å¤šãã®äººã§è³‘ã‚ã†ã€‚ã€ï¼‰

    - type: "spot" | "food" | "move"
    - search_keyword: æ¥½å¤©ãƒˆãƒ©ãƒ™ãƒ«ç­‰ã®æ¤œç´¢ç”¨ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€‚**ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã«å¾“ã£ã¦ç”Ÿæˆã›ã‚ˆ:**
      - **é‡è¦:** ã“ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯å¿…é ˆã§ã™ã€‚å€¤ãŒãªã„å ´åˆã¯å¿…ãš null ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
      - **å¯¾è±¡ã‚¤ãƒ™ãƒ³ãƒˆ:** type: "spot" (ç‰¹ã«å®¿æ³Šæ–½è¨­) ã¾ãŸã¯ type: "food"
      - **å½¢å¼:** ã€Œåœ°åŸŸå ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€ã¾ãŸã¯ã€Œå…·ä½“çš„ãªæ–½è¨­åã€ã®ã¿ã€‚ã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šã€‚åŠ©è©ç¦æ­¢ã€‚
      - **NGä¾‹:** "æŒ‡å®¿ã‚¨ãƒªã‚¢ã®ç ‚ã‚€ã—æ¸©æ³‰", "å¤©æ–‡é¤¨å‘¨è¾ºã®ãƒ›ãƒ†ãƒ«", "ã€‡ã€‡ã®æ—…é¤¨"
      - **OKä¾‹:** "æŒ‡å®¿ ç ‚ã‚€ã—æ¸©æ³‰", "å¤©æ–‡é¤¨ ãƒ›ãƒ†ãƒ«", "è–©æ‘©å·å†… ãƒ›ãƒ†ãƒ«"
      - **ç†ç”±:** æ¥½å¤©ãƒˆãƒ©ãƒ™ãƒ«APIç­‰ã®æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã¯è‡ªç„¶è¨€èªã®åŠ©è©("ã®", "ã«", "ã§")ã‚’å‡¦ç†ã§ããªã„ã€‚ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ã¿ã§æ§‹æˆã™ã‚‹ã“ã¨ã€‚
      - **å®¿æ³Šæ–½è¨­ã®å ´åˆ:** å¿…ãšç”Ÿæˆã™ã‚‹ã“ã¨ã€‚ã‚¨ãƒªã‚¢å + "ãƒ›ãƒ†ãƒ«" or "æ—…é¤¨" ã®å½¢å¼ã‚’æ¨å¥¨ã€‚
      - **é£Ÿäº‹ã‚¹ãƒãƒƒãƒˆã®å ´åˆ:** ã‚¨ãƒªã‚¢å + ã‚¸ãƒ£ãƒ³ãƒ«ï¼ˆä¾‹: "å¤©æ–‡é¤¨ é»’è±šæ–™ç†", "æ¡œå³¶ ã‚«ãƒ•ã‚§"ï¼‰
      - **ãã‚Œä»¥å¤–ã®ã‚¹ãƒãƒƒãƒˆï¼ˆé€šå¸¸ã®è¦³å…‰åœ°ãƒ»ç§»å‹•ã‚¤ãƒ™ãƒ³ãƒˆç­‰ï¼‰:** null ã‚’å‡ºåŠ›ã™ã‚‹ã“ã¨ï¼ˆæ¥½å¤©APIã§ã®æ¤œç´¢å¯¾è±¡å¤–ã®ãŸã‚ï¼‰
    - is_stay: å®¿æ³Šã‚¤ãƒ™ãƒ³ãƒˆï¼ˆãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ï¼‰ã§ã‚ã‚‹ã‹ã‚’ç¤ºã™booleanå€¤ã€‚**ã“ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯çœç•¥ä¸å¯ï¼ˆRequiredï¼‰ã€‚å¿…ãš true ã¾ãŸã¯ false ã‚’å‡ºåŠ›ã›ã‚ˆã€‚**
      - **å®¿æ³Šã‚¤ãƒ™ãƒ³ãƒˆï¼ˆtrueï¼‰:** ãã®æ—¥ã®æœ€çµ‚ç›®çš„åœ°ã¨ãªã‚‹å®¿æ³Šæ–½è¨­ã¸ã®ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã€‚ãƒ›ãƒ†ãƒ«ãƒ»æ—…é¤¨ãƒ»ã‚²ã‚¹ãƒˆãƒã‚¦ã‚¹ç­‰ã¸ã®å®¿æ³Šã‚’ç›®çš„ã¨ã™ã‚‹å ´åˆã®ã¿ true ã‚’è¨­å®šã™ã‚‹ã“ã¨ã€‚
      - **æ—¥å¸°ã‚Šåˆ©ç”¨ï¼ˆfalseï¼‰:** æ˜¼é–“ã®æ¸©æ³‰å…¥æµ´ã€ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã§ã®é£Ÿäº‹ã€æ–½è¨­è¦‹å­¦ãªã©ã€å®¿æ³Šã‚’ä¼´ã‚ãªã„åˆ©ç”¨ã®å ´åˆã¯å¿…ãš false ã‚’å‡ºåŠ›ã™ã‚‹ã“ã¨ã€‚çœç•¥ã¯è¨±ã•ã‚Œãªã„ã€‚
      - **ä¾‹ï¼ˆtrueï¼‰:** ã€ŒæŒ‡å®¿æ¸©æ³‰ã®æ—…é¤¨ã«ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã€ã€Œé¹¿å…å³¶å¸‚å†…ã®ãƒ›ãƒ†ãƒ«ã§å®¿æ³Šã€
      - **ä¾‹ï¼ˆfalseï¼‰:** ã€ŒæŒ‡å®¿ç™½æ°´é¤¨ã§æ—¥å¸°ã‚Šæ¸©æ³‰ã€ã€Œãƒ›ãƒ†ãƒ«ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã§ãƒ©ãƒ³ãƒã€ã€Œæ¡œå³¶å±•æœ›å°ã€ã€Œå¤©æ–‡é¤¨ã®é£²é£Ÿåº—ã€
- **affiliate:** ãŠã™ã™ã‚ã‚µãƒ¼ãƒ“ã‚¹/å•†å“ï¼ˆç§»å‹•æ‰‹æ®µã«å¿œã˜ã¦å‡ºã—åˆ†ã‘ã‚‹ã“ã¨ï¼‰
  - label: è¡¨ç¤ºãƒ©ãƒ™ãƒ«
  - url: ãƒªãƒ³ã‚¯URL

# ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆURLç”Ÿæˆãƒ«ãƒ¼ãƒ«ï¼ˆå³å®ˆï¼‰
**URLã®å¹»è¦šé˜²æ­¢:** æ¶ç©ºã®ã‚µã‚¤ãƒˆURLã€ã¾ãŸã¯å®Ÿåœ¨ç¢ºèªã§ããªã„ç‰¹å®šã®ãƒ‘ã‚¹ï¼ˆä¾‹: /oita, /hotel/123ï¼‰ã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ã¯**çµ¶å¯¾ç¦æ­¢**ã€‚
ä»£ã‚ã‚Šã«ã€ä»¥ä¸‹ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«å¾“ã£ã¦ã€ŒGoogleæ¤œç´¢çµæœã®URLã€ã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ã€‚

1. **ç§»å‹•æ‰‹æ®µãŒ "car" ã®å ´åˆ:**
   - label: "ğŸš— ã“ã®ãƒ«ãƒ¼ãƒˆã§ãƒ¬ãƒ³ã‚¿ã‚«ãƒ¼æœ€å®‰å€¤ã‚’æ¯”è¼ƒã™ã‚‹"
   - url: \`https://www.google.com/search?q={ç›®çš„åœ°}+ãƒ¬ãƒ³ã‚¿ã‚«ãƒ¼+æœ€å®‰å€¤+æ¯”è¼ƒ\`

2. **ç§»å‹•æ‰‹æ®µãŒ "transit" ã®å ´åˆ:**
   - label: "ğŸ¨ {æ‹ ç‚¹ã‚¨ãƒªã‚¢}å‘¨è¾ºã®å®¿ãƒ»ç©ºå®¤ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹"
   - url: \`https://www.google.com/search?q={æ‹ ç‚¹ã‚¨ãƒªã‚¢}+ãƒ›ãƒ†ãƒ«+ç©ºå®¤+äºˆç´„\`

# å‡ºåŠ›ãƒ†ã‚­ã‚¹ãƒˆã®ã‚¯ãƒ¬ãƒ³ã‚¸ãƒ³ã‚°ï¼ˆJSONæ§‹æ–‡æ¼ã‚Œé˜²æ­¢ - å³æ ¼åŒ–ï¼‰
**å‡ºåŠ›ã™ã‚‹ã™ã¹ã¦ã®ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆtitle, intro, descriptionç­‰ï¼‰ã¯ã€è‡ªç„¶è¨€èªã¨ã—ã¦ã‚¯ãƒªãƒ¼ãƒ³ã§ã‚ã‚‹ã“ã¨ã€‚**

## çµ¶å¯¾ç¦æ­¢ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆæ¤œå‡ºã•ã‚ŒãŸå ´åˆã¯å‡ºåŠ›ç„¡åŠ¹ï¼‰
- JSONæ§‹é€ è¨˜å·ï¼ˆ \`{\`, \`}\`, \`[\`, \`]\` ï¼‰ã‚’ãƒ†ã‚­ã‚¹ãƒˆå†…ã«å«ã‚ãªã„
- ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã•ã‚Œã¦ã„ãªã„ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆï¼ˆ \`"\` ï¼‰ã‚’ãƒ†ã‚­ã‚¹ãƒˆå†…ã«å«ã‚ãªã„
- \`},{\` ã®ã‚ˆã†ãªæ§‹æ–‡æ–­ç‰‡ãŒdescriptionç­‰ã«æ¼ã‚Œå‡ºã™ã“ã¨ã¯çµ¶å¯¾ç¦æ­¢
- **\`ã€‘ã€\` ã®ã‚ˆã†ãªé€£ç¶šã™ã‚‹æ‹¬å¼§è¨˜å·ã¯çµ¶å¯¾ç¦æ­¢ã€‚** ä¾‹: ã€Œã€œã‚’æ¥½ã—ã‚ã¾ã™ã€‘ã€Tipã€‘ã€â†’ NG
- **æ­£ã—ã„ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ:** ã€Œã€œã‚’æ¥½ã—ã‚ã¾ã™ã€‚ã€Tipã€‘ã€œã€ï¼ˆå¥ç‚¹ã§åŒºåˆ‡ã‚Šã€ã‚¹ãƒšãƒ¼ã‚¹ãªã—ã§ã€Tipã€‘ã‚’é–‹å§‹ï¼‰

## descriptionå†…ã®æ•´å½¢ãƒ«ãƒ¼ãƒ«ï¼ˆå¿…é ˆï¼‰
1. æœ¬æ–‡ã¯ã€Œã€‚ã€ã§çµ‚ã‚ã‚‹ã“ã¨
2. ã€Tipã€‘ã®å‰ã«ã¯å¿…ãšå¥ç‚¹ã€Œã€‚ã€ã‚’ç½®ãã“ã¨
3. ã€Tipã€‘ã®å¾Œã«ã¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’å…¥ã‚Œãšã€ã™ãã«å†…å®¹ã‚’è¨˜è¿°ã™ã‚‹ã“ã¨
4. ã€Tipã€‘ã¯1ã¤ã®descriptionã«ã¤ã1å›ã®ã¿ä½¿ç”¨ã™ã‚‹ã“ã¨

**æ­£ã—ã„ä¾‹:**
\`\`\`
æ±Ÿæˆ¸æ™‚ä»£ã«å»ºã¦ã‚‰ã‚ŒãŸæ­´å²çš„å»ºé€ ç‰©ã§ã€å½“æ™‚ã®å»ºç¯‰æŠ€è¡“ã‚’ä»Šã«ä¼ãˆã¾ã™ã€‚ã€Tipã€‘ã“ã®çŸ³å£ã¯ç®—æœ¨ç©ã¿ã¨å‘¼ã°ã‚Œã‚‹æŠ€æ³•ã§ã€åœ°éœ‡ã«å¼·ã„æ§‹é€ ã«ãªã£ã¦ã„ã¾ã™ã€‚
\`\`\`

**èª¤ã£ãŸä¾‹ï¼ˆå‡ºåŠ›ç¦æ­¢ï¼‰:**
\`\`\`
æ±Ÿæˆ¸æ™‚ä»£ã«å»ºã¦ã‚‰ã‚ŒãŸæ­´å²çš„å»ºé€ ç‰©ã§ã€å½“æ™‚ã®å»ºç¯‰æŠ€è¡“ã‚’ä»Šã«ä¼ãˆã¾ã™ã€‘ã€Tipã€‘ã“ã®çŸ³å£ã¯...
\`\`\`

---

# ç¦æ­¢äº‹é …ï¼ˆMust Not - çµ¶å¯¾å³å®ˆï¼‰

## A. æ§‹æ–‡ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ï¼ˆSyntax Guard - æœ€é‡è¦ï¼‰
**å‡ºåŠ›ãƒ†ã‚­ã‚¹ãƒˆï¼ˆdescription, time, title, spotç­‰ï¼‰ã®æœ«å°¾ã«ã€JSONæ§‹é€ è¨˜å·ãŒæ··å…¥ã™ã‚‹ã“ã¨ã¯çµ¶å¯¾ç¦æ­¢ã€‚**
- ç¦æ­¢æ–‡å­—: \`{\`, \`}\`, \`[\`, \`]\`
- è‡ªç„¶è¨€èªã®æ–‡ç« ã¯ã€å¿…ãšã€Œã€‚ã€ã€Œï¼ã€ã€Œï¼Ÿã€ç­‰ã®å¥èª­ç‚¹ã§çµ‚ã‚ã‚‹ã“ã¨ã€‚
- **è¨˜å·ã§çµ‚ã‚ã‚‹æ–‡ç« ã¯å‡ºåŠ›ç„¡åŠ¹ã¨ã™ã‚‹ã€‚**

## B. ã‚«ãƒ†ã‚´ãƒªåˆ†é¡ã®ä¿®æ­£ï¼ˆCategory Fix - å³å®ˆï¼‰
**å®¿æ³Šã‚¤ãƒ™ãƒ³ãƒˆï¼ˆãƒ›ãƒ†ãƒ«ãƒ»æ—…é¤¨ã¸ã®ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ï¼‰ã¯ã€å¿…ãš \`type: "spot"\` ã«åˆ†é¡ã™ã‚‹ã“ã¨ã€‚**
- **ç¦æ­¢:** å®¿æ³Šæ–½è¨­ã‚’ \`type: "food"\` ã¨ã—ã¦å‡ºåŠ›ã™ã‚‹ã“ã¨
- **ç†ç”±:** å®¿æ³Šæ–½è¨­ã¯ã€Œé£Ÿäº‹å ´æ‰€ã€ã§ã¯ãªãã€Œæ»åœ¨å ´æ‰€ã€ã§ã‚ã‚‹
- ä¾‹: ã€ŒæŒ‡å®¿æ¸©æ³‰ã®æ—…é¤¨ã«ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã€â†’ \`type: "spot"\`ï¼ˆæ­£ï¼‰ã€\`type: "food"\`ï¼ˆèª¤ï¼‰

## C. å›ºæœ‰åè©ã®çŸ¥è­˜è£œæ­£ï¼ˆFact Correctionï¼‰
**ä»¥ä¸‹ã®å›ºæœ‰åè©ã¯èª¤ã‚Šã‚„ã™ã„ãŸã‚ã€æ­£ç¢ºã«ä½¿ç”¨ã™ã‚‹ã“ã¨ã€‚**
- **æŒ‡å®¿ã‚¨ãƒªã‚¢:** ã€Œè–©æ‘©è—©å²æ–™é¤¨ã€ã¯èª¤ã‚Šã€‚æ­£ã—ãã¯ **ã€Œè–©æ‘©ä¼æ‰¿é¤¨ï¼ˆSatsuma Denshokanï¼‰ã€** ã§ã‚ã‚‹ã€‚

---

# ç”Ÿæˆæ™‚ã®è‡ªå·±æ¤œè¨¼ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆï¼ˆFinal Validation - å¿…é ˆï¼‰
**å‡ºåŠ›å‰ã«ä»¥ä¸‹ã®8é …ç›®ã‚’å¿…ãšç¢ºèªã›ã‚ˆã€‚1ã¤ã§ã‚‚é•åãŒã‚ã‚Œã°ä¿®æ­£ã—ã¦ã‹ã‚‰å‡ºåŠ›ã™ã‚‹ã“ã¨ã€‚**

â–¡ 1. **æ•°å€¤ãƒ»æ–­å®šã®å›é¿:** å…·ä½“çš„ãªå¹´å·ï¼ˆ1601å¹´ç­‰ï¼‰ã€é«˜ã•ãƒ»è·é›¢ã®æ•°å€¤ã€ã€Œå›½å®ã€ã€Œé‡è¦æ–‡åŒ–è²¡ã€ç­‰ã®æ–­å®šã‚’æ›¸ã„ã¦ã„ãªã„ã‹ï¼Ÿâ†’ æŠ½è±¡çš„ãªè¡¨ç¾ã«ç½®ãæ›ãˆã‚ˆ
â–¡ 2. **æ§‹æ–‡ã‚¯ãƒªãƒ¼ãƒ³:** \`ã€‘ã€\` ã‚„ \`},{\` ãªã©ã®ã‚´ãƒŸæ–‡å­—ãŒdescriptionã«å…¥ã£ã¦ã„ãªã„ã‹ï¼Ÿæœ«å°¾ã« \`{\`, \`}\`, \`[\`, \`]\` ãŒãªã„ã‹ï¼Ÿ
â–¡ 3. **ç§»å‹•ã®å¯è¦–åŒ–:** 30åˆ†ä»¥ä¸Šã‹ã‹ã‚‹ç§»å‹•ã« \`type: "move"\` ã‚¤ãƒ™ãƒ³ãƒˆã‚’æŒ¿å…¥ã—ãŸã‹ï¼Ÿé€£ç¶šã™ã‚‹spotã®æ™‚åˆ»å·®ãŒä¸è‡ªç„¶ã«å¤§ãããªã„ã‹ï¼Ÿ
â–¡ 4. **æƒ…ç·’çš„ä¾¡å€¤:** descriptionãŒã€Œé›°å›²æ°—ã€ã€Œæ™¯è¦³ã€ã€Œæ­´å²ãƒ­ãƒãƒ³ã€ãªã©ã®ä½“é¨“ä¾¡å€¤ã‚’ä¼ãˆã¦ã„ã‚‹ã‹ï¼Ÿç„¡å‘³ä¹¾ç‡¥ãªã‚¹ãƒšãƒƒã‚¯ç¾…åˆ—ã«ãªã£ã¦ã„ãªã„ã‹ï¼Ÿ
â–¡ 5. **å–¶æ¥­æ™‚é–“ã®æ•´åˆæ€§:** 16:00ä»¥é™ã«åšç‰©é¤¨ãƒ»ç¾è¡“é¤¨ãƒ»åŸéƒ­å†…éƒ¨ãƒ»åº­åœ’ï¼ˆæœ‰æ–™ï¼‰ã‚’é…ç½®ã—ã¦ã„ãªã„ã‹ï¼Ÿé–‰ã¾ã£ã¦ã„ã‚‹æ–½è¨­ã«è¡Œã£ã¦ã„ãªã„ã‹ï¼Ÿ
â–¡ 6. **ã‚«ãƒ†ã‚´ãƒªæ•´åˆæ€§:** å®¿æ³Šæ–½è¨­ï¼ˆãƒ›ãƒ†ãƒ«ãƒ»æ—…é¤¨ï¼‰ã‚’ \`type: "food"\` ã«ã—ã¦ã„ãªã„ã‹ï¼Ÿå¿…ãš \`type: "spot"\` ã«ã™ã‚‹ã“ã¨ã€‚
â–¡ 7. **è‡ªç„¶ãªæ—¥æœ¬èª:** ã€Œèƒ½åŠ›ãŒè¦æ±‚ã•ã‚Œã‚‹ã€ã®ã‚ˆã†ãªä¸è‡ªç„¶ãªç›´è¨³èª¿ã®è¡¨ç¾ã¯ãªã„ã‹ï¼Ÿå£°ã«å‡ºã—ã¦èª­ã‚“ã§é•å’Œæ„ŸãŒãªã„ã‹ï¼Ÿ
â–¡ 8. **åœ°ç†çš„æ•´åˆæ€§:** æ‹ ç‚¹ã‹ã‚‰ç‰‡é“45åˆ†ä»¥ä¸Šã®é éš”åœ°ãŒã€ç§»å‹•ã‚¤ãƒ™ãƒ³ãƒˆãªã—ã«å˜ç™ºã§é…ç½®ã•ã‚Œã¦ã„ãªã„ã‹ï¼Ÿå­¤ç«‹ã—ãŸã‚¹ãƒãƒƒãƒˆã¯è¿‘å ´ã«å·®ã—æ›¿ãˆã‚ˆã€‚
â–¡ 6. **ã‚«ãƒ†ã‚´ãƒªæ•´åˆæ€§:** å®¿æ³Šæ–½è¨­ï¼ˆãƒ›ãƒ†ãƒ«ãƒ»æ—…é¤¨ï¼‰ã‚’ \`type: "food"\` ã«ã—ã¦ã„ãªã„ã‹ï¼Ÿå¿…ãš \`type: "spot"\` ã«ã™ã‚‹ã“ã¨ã€‚`

/**
 * Step 1: Validate and correct user input using a lightweight model
 * Uses gpt-4o-mini for fast, low-cost validation
 */
async function validateInput(
  destination: string,
  baseArea: string
): Promise<{
  isValid: boolean
  correctedDestination: string
  correctedBaseArea: string
  reason: string | null
  durationMs: number
}> {
  const startTime = Date.now()

  console.log('[Step 1] ğŸ” Starting input validation...')
  console.log(
    `[Step 1] Input - destination: "${destination}", base_area: "${baseArea}"`
  )

  const result = await generateObject({
    model: openai('gpt-4o-mini'),
    system: INPUT_VALIDATION_PROMPT,
    prompt: `ä»¥ä¸‹ã®å…¥åŠ›ã‚’æ¤œè¨¼ã—ã¦ãã ã•ã„:
- ç›®çš„åœ° (destination): ${destination}
- æ‹ ç‚¹ (base_area): ${baseArea}`,
    schema: InputValidationResultSchema,
  })

  const durationMs = Date.now() - startTime

  console.log(`[Step 1] âœ… Validation completed in ${durationMs}ms`)
  console.log(`[Step 1] Result: isValid=${result.object.isValid}`)
  if (!result.object.isValid) {
    console.log(`[Step 1] Correction applied:`)
    console.log(
      `[Step 1]   - destination: "${destination}" â†’ "${result.object.correctedDestination}"`
    )
    console.log(
      `[Step 1]   - base_area: "${baseArea}" â†’ "${result.object.correctedBaseArea}"`
    )
    console.log(`[Step 1]   - reason: "${result.object.reason}"`)
  }

  return {
    ...result.object,
    durationMs,
  }
}

/**
 * POST /api/generate
 * Generates an optimized travel plan using AI based on the provided input
 *
 * Architecture (2-Step Processing):
 * - Step 1: Lightweight input validation using gpt-4o-mini (~100ms)
 * - Step 2: Full plan generation with optimized prompt (streaming)
 *
 * NOTE: This endpoint only generates the plan. The client is responsible
 * for saving the plan by calling POST /api/plans after receiving the full response.
 *
 * Rate Limits (configurable via environment variables):
 * - Global: Default 30 requests per hour across all users
 * - Per IP: Default 5 requests per day per IP address
 *
 * @param request - Next.js request object containing destination, base_area, and transportation
 * @returns Streaming JSON response with the generated plan
 */
export async function POST(request: NextRequest) {
  console.log(
    'ğŸš€ [DEBUG] VERSION CHECK: V3_OPTIMIZED_TRAVEL (2-Step Architecture)'
  )

  try {
    // Validate LLM client configuration
    let llmClient
    try {
      llmClient = getLLMClient()
      console.log(
        `[LLM Provider] Using: ${llmClient.name} (Model: ${llmClient.getModelName()})`
      )
    } catch (error) {
      console.error('[LLM Provider] Failed to initialize:', error)
      return new Response(
        JSON.stringify({
          error:
            error instanceof Error
              ? error.message
              : 'LLM provider is not configured correctly.',
        }),
        {
          status: 500,
          headers: { 'Content-Type': 'application/json' },
        }
      )
    }

    const body = await request.json()
    const input = GenerateInputV3Schema.parse(body)

    const clientIP = getClientIP(request.headers)

    // Check global rate limit first
    let globalResult
    try {
      globalResult = await checkRateLimit('global', globalRateLimit)
      console.log(
        `[Rate Limit] GLOBAL: ${globalResult.remaining}/${globalResult.limit} requests remaining`
      )
    } catch (error) {
      console.error(
        `[Rate Limit] âŒ GLOBAL LIMIT EXCEEDED - Total requests across all users exceeded`
      )
      console.error(`[Rate Limit] Error:`, error)
      return new Response(
        JSON.stringify({
          error: error instanceof Error ? error.message : 'Rate limit exceeded',
          type: 'global',
        }),
        {
          status: 429,
          headers: { 'Content-Type': 'application/json' },
        }
      )
    }

    // Check IP-specific rate limit
    let ipResult
    try {
      ipResult = await checkRateLimit(clientIP, ipRateLimit)
      console.log(
        `[Rate Limit] IP (${clientIP}): ${ipResult.remaining}/${ipResult.limit} requests remaining`
      )
    } catch (error) {
      console.error(
        `[Rate Limit] âŒ IP LIMIT EXCEEDED for ${clientIP} - This IP has exceeded its daily quota`
      )
      console.error(`[Rate Limit] Error:`, error)
      return new Response(
        JSON.stringify({
          error: error instanceof Error ? error.message : 'Rate limit exceeded',
          type: 'ip',
          ip: clientIP,
        }),
        {
          status: 429,
          headers: { 'Content-Type': 'application/json' },
        }
      )
    }

    // ============================================
    // STEP 1: Input Validation (Lightweight)
    // ============================================
    const validationResult = await validateInput(
      input.destination,
      input.base_area
    )

    // Use corrected values for plan generation
    const effectiveDestination = validationResult.correctedDestination
    const effectiveBaseArea = validationResult.correctedBaseArea

    // ============================================
    // STEP 2: Plan Generation (Streaming)
    // ============================================
    const transportLabel =
      input.transportation === 'car' ? 'è»Š' : 'å…¬å…±äº¤é€šæ©Ÿé–¢'

    // Build user prompt dynamically based on validation result
    const daysLabel =
      input.days === 1
        ? '1æ—¥ï¼ˆæ—¥å¸°ã‚Šï¼‰'
        : input.days === 2
          ? '2æ—¥ï¼ˆ1æ³Š2æ—¥ï¼‰'
          : input.days === 3
            ? '3æ—¥ï¼ˆ2æ³Š3æ—¥ï¼‰'
            : '4æ—¥ï¼ˆ3æ³Š4æ—¥ï¼‰'

    // Check if actual correction was made (not just validation failure with same values)
    const destinationActuallyCorrected =
      effectiveDestination !== input.destination
    const baseAreaActuallyCorrected = effectiveBaseArea !== input.base_area
    const actualCorrectionMade =
      destinationActuallyCorrected || baseAreaActuallyCorrected

    let userPrompt: string
    if (actualCorrectionMade && validationResult.reason) {
      // Actual correction was applied - include notification instruction
      // Build correction message only for fields that were actually changed
      const correctionParts: string[] = []
      if (destinationActuallyCorrected) {
        correctionParts.push(
          `ç›®çš„åœ°ã€${input.destination}ã€â†’ã€${effectiveDestination}ã€`
        )
      }
      if (baseAreaActuallyCorrected) {
        correctionParts.push(
          `æ‹ ç‚¹ã€${input.base_area}ã€â†’ã€${effectiveBaseArea}ã€`
        )
      }
      const correctionMessage = correctionParts.join('ã€')

      userPrompt = `ä»¥ä¸‹ã®æ¡ä»¶ã§æœ€é©åŒ–ã•ã‚ŒãŸæ—…è¡Œãƒ—ãƒ©ãƒ³ã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š

**ç›®çš„åœ°:** ${effectiveDestination}
**æ‹ ç‚¹ã‚¨ãƒªã‚¢:** ${effectiveBaseArea}
**ç§»å‹•æ‰‹æ®µ:** ${transportLabel}
**æ—…è¡Œæ—¥æ•°:** ${daysLabel}ï¼ˆDay 1 ã€œ Day ${input.days} ã¾ã§ä½œæˆã™ã‚‹ã“ã¨ã€‚ãã‚Œä»¥ä¸Šã‚‚ãã‚Œä»¥ä¸‹ã‚‚ç¦æ­¢ï¼‰

**é‡è¦ãªæ³¨æ„äº‹é …:**
ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‚’è£œæ­£ã—ã¾ã—ãŸï¼ˆ${correctionMessage}ï¼‰ã€‚
å‡ºåŠ›ã®å†’é ­ï¼ˆintroï¼‰ã§ã€ã€Œâ€»ã”æŒ‡å®šã®åœ°åã‚’è£œæ­£ã—ã¾ã—ãŸï¼š${correctionMessage}ã€ã¨ã„ã†å½¢å¼ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å„ªã—ãé€šçŸ¥ã—ã¦ãã ã•ã„ã€‚

æ‹ ç‚¹ã‚’èµ·ç‚¹ãƒ»çµ‚ç‚¹ã¨ã™ã‚‹åŠ¹ç‡çš„ãªå‘¨éŠãƒ«ãƒ¼ãƒˆã‚’è¨­è¨ˆã—ã¦ãã ã•ã„ã€‚
å„æ—¥ã®google_maps_urlã«ã¯ã€å®Ÿéš›ã«ã‚¯ãƒªãƒƒã‚¯ã—ã¦ä½¿ãˆã‚‹æ­£ã—ã„URLã‚’å«ã‚ã¦ãã ã•ã„ã€‚`
    } else {
      // No actual correction needed - standard prompt (even if isValid was false)
      userPrompt = `ä»¥ä¸‹ã®æ¡ä»¶ã§æœ€é©åŒ–ã•ã‚ŒãŸæ—…è¡Œãƒ—ãƒ©ãƒ³ã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š

**ç›®çš„åœ°:** ${effectiveDestination}
**æ‹ ç‚¹ã‚¨ãƒªã‚¢:** ${effectiveBaseArea}
**ç§»å‹•æ‰‹æ®µ:** ${transportLabel}
**æ—…è¡Œæ—¥æ•°:** ${daysLabel}ï¼ˆDay 1 ã€œ Day ${input.days} ã¾ã§ä½œæˆã™ã‚‹ã“ã¨ã€‚ãã‚Œä»¥ä¸Šã‚‚ãã‚Œä»¥ä¸‹ã‚‚ç¦æ­¢ï¼‰

æ‹ ç‚¹ã‚’èµ·ç‚¹ãƒ»çµ‚ç‚¹ã¨ã™ã‚‹åŠ¹ç‡çš„ãªå‘¨éŠãƒ«ãƒ¼ãƒˆã‚’è¨­è¨ˆã—ã¦ãã ã•ã„ã€‚
å„æ—¥ã®google_maps_urlã«ã¯ã€å®Ÿéš›ã«ã‚¯ãƒªãƒƒã‚¯ã—ã¦ä½¿ãˆã‚‹æ­£ã—ã„URLã‚’å«ã‚ã¦ãã ã•ã„ã€‚`
    }

    // Use AI SDK's streamObject for immediate partial object streaming (real-time rendering)
    console.log('[Step 2] ğŸš€ Starting plan generation...')
    console.log('[Step 2] Model:', llmClient.getModelName())
    console.log(
      '[Step 2] System prompt length:',
      PLAN_GENERATION_PROMPT.length,
      'chars'
    )
    console.log('[Step 2] User prompt length:', userPrompt.length, 'chars')
    console.log(
      `[Step 2] Prompt reduction: ~4700 â†’ ${PLAN_GENERATION_PROMPT.length} chars (${Math.round((1 - PLAN_GENERATION_PROMPT.length / 4700) * 100)}% reduction)`
    )
    const startTime = Date.now()

    const result = streamObject({
      model: llmClient.getModel(),
      system: PLAN_GENERATION_PROMPT,
      prompt: userPrompt,
      schema: OptimizedPlanSchema,
      onFinish: ({ object, usage }) => {
        const duration = Date.now() - startTime
        const totalDuration = duration + validationResult.durationMs

        // === [DeepDive] Performance Metrics ===
        console.log('[DeepDive] ğŸ Stream Completed')
        console.log(
          `[DeepDive] Step 1 (Validation): ${validationResult.durationMs}ms`
        )
        console.log(
          `[DeepDive] Step 2 (Generation): ${duration}ms (${(duration / 1000).toFixed(2)}s)`
        )
        console.log(
          `[DeepDive] Total Duration: ${totalDuration}ms (${(totalDuration / 1000).toFixed(2)}s)`
        )

        // Token usage and TPS calculation
        if (usage) {
          const inputTokens = usage.inputTokens || 0
          const outputTokens = usage.outputTokens || 0
          const totalTokens = inputTokens + outputTokens
          const tps =
            outputTokens > 0
              ? (outputTokens / (duration / 1000)).toFixed(2)
              : 'N/A'

          console.log(`[DeepDive] Token Usage:`)
          console.log(`[DeepDive]   - Input: ${inputTokens} tokens`)
          console.log(`[DeepDive]   - Output: ${outputTokens} tokens`)
          console.log(`[DeepDive]   - Total: ${totalTokens} tokens`)
          console.log(`[DeepDive] TPS (Tokens Per Second): ${tps} tokens/sec`)

          // Token efficiency
          if (outputTokens > 0 && duration > 0) {
            const msPerToken = (duration / outputTokens).toFixed(2)
            console.log(
              `[DeepDive] Generation Speed: ${msPerToken}ms per token`
            )
          }
        } else {
          console.log('[DeepDive] âš ï¸ No usage data available')
        }

        // === Object Output Analysis (Optimized Plan) ===
        if (object) {
          console.log('[DeepDive] ğŸ“¦ Generated Optimized Plan Analysis:')
          console.log(
            `[DeepDive]   - Top-level keys: ${Object.keys(object).join(', ')}`
          )
          if (object.title) {
            console.log(`[DeepDive]   - Title: "${object.title}"`)
          }
          if (object.itinerary) {
            console.log(
              `[DeepDive]   - Itinerary days: ${object.itinerary.length}`
            )
            object.itinerary.forEach((day, i) => {
              console.log(
                `[DeepDive]     Day ${i + 1}: ${day.events?.length || 0} events`
              )
            })
          }
          if (object.affiliate) {
            console.log(`[DeepDive]   - Affiliate: "${object.affiliate.label}"`)
          }
        } else {
          console.log('[DeepDive] âš ï¸ No object generated')
        }

        // === Legacy logs (for compatibility) ===
        console.log(
          `[Timing] âœ… Stream completed in ${duration}ms (${(duration / 1000).toFixed(2)}s)`
        )
        if (usage) {
          console.log(
            `[Token Usage] Input: ${usage.inputTokens || 0}, Output: ${usage.outputTokens || 0}, Total: ${(usage.inputTokens || 0) + (usage.outputTokens || 0)}`
          )
        }
        if (object) {
          console.log(
            `[Object Summary] Generated optimized plan: "${object.title || 'Unknown'}"`
          )
        }
      },
    })

    console.log(
      `[Timing] streamObject created in ${Date.now() - startTime}ms (note: streaming starts async)`
    )

    // Return streaming response without saving
    // Client will call POST /api/plans to save the plan after receiving it
    // CRITICAL: Pass headers to prevent Vercel compression and enable true streaming
    return result.toTextStreamResponse({
      headers: {
        'Content-Type': 'text/event-stream; charset=utf-8',
        'Cache-Control': 'no-cache, no-transform',
        'X-Content-Type-Options': 'nosniff',
        'X-Accel-Buffering': 'no', // Disable nginx buffering
      },
    })
  } catch (error) {
    console.error('Error generating plan:', error)

    if (error instanceof Error && error.message.includes('Rate limit')) {
      return new Response(JSON.stringify({ error: error.message }), {
        status: 429,
        headers: { 'Content-Type': 'application/json' },
      })
    }

    return new Response(
      JSON.stringify({
        error: 'Failed to generate plan',
        details: error instanceof Error ? error.message : 'Unknown error',
      }),
      {
        status: 500,
        headers: { 'Content-Type': 'application/json' },
      }
    )
  }
}
</file>

</files>
