'use client'

import { useState } from 'react'
import { useRouter } from 'next/navigation'
import { Plan } from '@/types/plan'
import { Copy, Share2, ArrowLeft, Clock } from 'lucide-react'
import { toast } from 'sonner'
import type { DeepPartial } from 'ai'
import { SpotImage } from './spot-image'

interface ResultViewProps {
  plan: DeepPartial<Plan>
}

const EVENT_TYPE_LABELS = {
  spot: 'LOCATION',
  food: 'SUSTENANCE',
  work: 'OPERATION',
  move: 'TRANSIT',
}

const EVENT_ICONS = {
  spot: 'ðŸ“',
  food: 'ðŸ½ï¸',
  work: 'ðŸ’¼',
  move: 'ðŸš¶',
}

export function ResultView({ plan }: ResultViewProps) {
  const router = useRouter()
  const [copied, setCopied] = useState(false)

  const copyMissionText = () => {
    if (!plan.title || !plan.days || plan.days.length === 0) return

    let text = `=== MISSION BRIEFING ===\n\n`
    text += `OPERATION: ${plan.title}\n\n`
    text += `TARGET: ${plan.target === 'engineer' ? 'ENGINEER MODE' : 'GENERAL MODE'}\n\n`
    if (plan.intro) {
      text += `BRIEFING:\n${plan.intro}\n\n`
    }

    plan.days?.forEach((day, dayIndex) => {
      if (!day) return
      text += `=== DAY ${day.day || dayIndex + 1} ===\n\n`
      day.events?.forEach(event => {
        if (!event || !event.tp || !event.t || !event.n) return
        text += `[${event.t}] ${EVENT_TYPE_LABELS[event.tp]}: ${event.n}\n`
        if (event.a) {
          text += `${event.a}\n`
        }
        text += `\n`
      })
    })

    navigator.clipboard.writeText(text)
    setCopied(true)
    toast.success('MISSION DATA COPIED', {
      description: 'Data transferred to clipboard.',
    })
    setTimeout(() => setCopied(false), 2000)
  }

  const shareToTwitter = () => {
    const text = `${plan.title || 'MISSION'} - Generated by Engineer's Scouter`
    const url = window.location.href
    const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`
    window.open(twitterUrl, '_blank', 'noopener,noreferrer')
  }

  // Allow rendering with partial data for streaming display
  const hasAnyContent = plan.title || plan.days?.length
  if (!hasAnyContent) {
    return (
      <div className="terminal-panel">
        <div className="flex items-center space-x-3">
          <div className="w-2 h-2 bg-green-500 animate-pulse rounded-full" />
          <div className="w-2 h-2 bg-green-500 animate-pulse rounded-full animation-delay-150" />
          <div className="w-2 h-2 bg-green-500 animate-pulse rounded-full animation-delay-300" />
          <span className="terminal-text-secondary ml-2">
            LOADING MISSION DATA...
          </span>
        </div>
      </div>
    )
  }

  return (
    <div className="max-w-4xl mx-auto space-y-6">
      {/* Header */}
      <div className="terminal-panel hud-corners">
        <div className="flex items-center justify-between mb-4">
          <div>
            <div className="text-xs terminal-text-secondary mb-1">
              [ ARCHIVED MISSION BRIEFING ]
            </div>
            <h1 className="terminal-heading">{plan.title || 'LOADING...'}</h1>
          </div>
          <div className="flex gap-2">
            <button
              onClick={copyMissionText}
              className="terminal-button text-xs px-3 py-2"
              title="Copy mission data"
            >
              <Copy className="w-4 h-4 inline mr-1" />
              {copied ? 'COPIED' : 'COPY'}
            </button>
            <button
              onClick={shareToTwitter}
              className="terminal-button text-xs px-3 py-2"
              title="Share on X"
            >
              <Share2 className="w-4 h-4 inline mr-1" />X
            </button>
          </div>
        </div>

        {plan.target && (
          <div className="mb-3">
            <span className="terminal-text-amber text-xs px-2 py-1 border border-amber-500/50">
              {plan.target === 'engineer'
                ? '[ENGINEER MODE]'
                : '[GENERAL MODE]'}
            </span>
          </div>
        )}

        {plan.intro && (
          <div className="terminal-body border-l-2 border-green-500/50 pl-4 py-2 bg-green-500/5">
            {plan.intro}
          </div>
        )}
      </div>

      {/* Daily Itinerary */}
      {plan.days?.map((day, dayIndex) => {
        if (!day) return null
        return (
          <div key={dayIndex} className="terminal-panel">
            <h2 className="terminal-subheading mb-4">
              <Clock className="inline w-5 h-5 mr-2" />
              DAY {day.day || dayIndex + 1}
            </h2>
            <div className="space-y-4">
              {day.events?.map((event, eventIndex) => {
                if (!event || !event.tp || !event.t || !event.n) return null

                return (
                  <div
                    key={eventIndex}
                    className="border border-green-500/30 overflow-hidden"
                  >
                    {/* Event Image */}
                    {event.tp === 'spot' && event.n && (
                      <SpotImage
                        query={event.q || event.n}
                        spotName={event.n}
                      />
                    )}

                    {/* Event Content */}
                    <div className="p-4 space-y-2">
                      <div className="flex items-start gap-3">
                        <span className="text-xl shrink-0">
                          {EVENT_ICONS[event.tp]}
                        </span>
                        <div className="flex-1 space-y-1">
                          <div className="flex items-center gap-2 flex-wrap">
                            <span className="terminal-text-amber text-xs font-bold">
                              [{event.t}]
                            </span>
                            <span className="terminal-text-secondary text-xs">
                              {EVENT_TYPE_LABELS[event.tp]}:
                            </span>
                            <span className="terminal-subheading text-sm">
                              {event.n}
                            </span>
                          </div>
                          {event.a && (
                            <p className="terminal-body text-sm mt-2">
                              {event.a}
                            </p>
                          )}
                        </div>
                      </div>
                    </div>
                  </div>
                )
              })}
            </div>
          </div>
        )
      })}

      {/* Navigation */}
      <div className="terminal-panel">
        <button
          onClick={() => router.push('/')}
          className="terminal-button w-full"
        >
          <ArrowLeft className="inline w-4 h-4 mr-2" />
          NEW MISSION CONFIG
        </button>
      </div>
    </div>
  )
}
